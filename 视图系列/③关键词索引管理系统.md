
# Supermemoçš„concept
[[supermemoçš„conceptçš„å±•ç¤º]]

# å…³é”®è¯ç´¢å¼•é¡µ
```dataviewjs
//=============================================================================
// å…³é”®è¯ç´¢å¼•ç®¡ç†ç³»ç»Ÿ v3.7
// æ ¸å¿ƒç‰¹æ€§ï¼š
// - YAMLå­—æ®µåï¼šå…³é”®è¯ç®¡ç†ï¼ˆä¸­æ–‡ï¼‰
// - +å·æ˜¯åç¼€æ³¨è§£ï¼Œç”¨äºæŠ½å±‰å†…ç¬”è®°çš„å¤šå±‚çº§å±•ç¤º
// - å…³é”®è¯å±‚çº§é€šè¿‡parentIdç®¡ç†ï¼Œç”¨æˆ·æ‹–æ‹½è°ƒæ•´
// - ä¸¤ä¸ªè§†å›¾ï¼šå¥—åœˆå¼å±•ç¤ºï¼ˆç´§å‡‘å¸ƒå±€ï¼‰ + GTDå¼ç®¡ç†
// - åå‘åŒæ­¥ï¼šé‡å‘½åå…³é”®è¯æ—¶è‡ªåŠ¨æ›´æ–°åŸå§‹ç¬”è®°æ–‡ä»¶
// - çˆ¶çº§é€‰æ‹©ï¼šæ”¯æŒè¾“å…¥æœç´¢ç­›é€‰ï¼Œé”®ç›˜å¯¼èˆª
// - æ··åˆæ¥æºç±»å‹ï¼šæ¯ä¸ªç¬”è®°è®°å½•å®é™…æ¥æºç±»å‹ï¼Œæ”¯æŒåˆ†ç»„æ˜¾ç¤º
// - v3.4æ–°å¢ï¼šèƒ¶å›ŠæŠ½å±‰å†…æ”¯æŒå¤šå±‚çº§å±•ç¤ºï¼ˆæŒ‰+å·åˆ†å‰²ï¼‰
// - v3.7ä¼˜åŒ–ï¼šé»˜è®¤åªæ˜¾ç¤ºå±‚çº§åï¼Œæœ‰ç¬”è®°æ—¶æ˜¾ç¤ºå¯æŠ˜å "ğŸ“ æ ¹ç¬”è®°"æŒ‰é’®
//=============================================================================

(async () => {

// ============ é…ç½® ============
const INDEX_PATH = 'data/keyword_index.json';
const SCAN_FOLDER = '';  // æ‰«ææ•´ä¸ªåº“ï¼Œæˆ–æŒ‡å®šæ–‡ä»¶å¤¹

// ============ é¢œè‰²é…ç½® ============
const COLORS = {
    yaml: { bg: 'rgba(0, 122, 255, 0.12)', border: 'rgba(0, 122, 255, 0.3)', text: '#007AFF', icon: 'â—†' },
    plus: { bg: 'rgba(255, 149, 0, 0.12)', border: 'rgba(255, 149, 0, 0.3)', text: '#D47300', icon: 'â–²' },
    dot:  { bg: 'rgba(142, 68, 173, 0.1)', border: 'rgba(142, 68, 173, 0.25)', text: '#8E44AD', icon: 'â—' }
};

// ============ æ ·å¼æ³¨å…¥ ============
const styleId = 'keyword-index-styles-v37';
// å¼ºåˆ¶æ›´æ–°æ ·å¼ï¼ˆç§»é™¤æ—§çš„ï¼‰
const oldStyle = document.getElementById(styleId);
if (oldStyle) oldStyle.remove();
if (true) {  // å§‹ç»ˆæ³¨å…¥æ–°æ ·å¼
    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = `
        .kw-container { font-family: var(--font-text); padding: 10px; }

        /* å›¾ä¾‹ */
        .kw-legend { display: flex; flex-wrap: wrap; gap: 12px; padding: 10px; background: var(--background-secondary); border-radius: 8px; margin-bottom: 12px; font-size: 12px; }
        .kw-legend-item { display: flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; }
        .kw-legend-yaml { background: ${COLORS.yaml.bg}; color: ${COLORS.yaml.text}; border-left: 3px solid ${COLORS.yaml.text}; }
        .kw-legend-plus { background: ${COLORS.plus.bg}; color: ${COLORS.plus.text}; border-left: 3px solid ${COLORS.plus.text}; }
        .kw-legend-dot { background: ${COLORS.dot.bg}; color: ${COLORS.dot.text}; border-left: 3px solid ${COLORS.dot.text}; }

        /* å·¥å…·æ  */
        .kw-toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; padding: 8px; background: var(--background-secondary); border-radius: 6px; }
        .kw-toolbar button { padding: 6px 14px; border: none; border-radius: 4px; background: var(--interactive-accent); color: var(--text-on-accent); cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; }
        .kw-toolbar button:hover { opacity: 0.85; transform: translateY(-1px); }
        .kw-toolbar button:disabled { opacity: 0.5; cursor: not-allowed; }
        .kw-toolbar button.secondary { background: var(--background-modifier-border); color: var(--text-normal); }

        /* å­—æ¯å¯¼èˆª */
        .kw-alphabet-nav { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 16px; }
        .kw-letter-link { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; background: var(--background-secondary); border-radius: 50%; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.15s; }
        .kw-letter-link:hover { background: var(--interactive-accent); color: var(--text-on-accent); transform: scale(1.1); }

        /* åˆ†ç»„æ ‡é¢˜ */
        .kw-group-header { margin-top: 16px; border-bottom: 1px solid var(--background-modifier-border); color: var(--text-muted); font-size: 14px; padding-bottom: 4px; font-weight: 600; }

        /* ============ å¥—åœˆå¼å±•ç¤ºæ ·å¼ï¼ˆç´§å‡‘æ ‡ç­¾äº‘ç‰ˆï¼‰============ */
        .kw-nest-container {
            margin-top: 12px;
            min-height: 50px;
        }

        /* åˆ†ç»„å†…å®¹ - æ°´å¹³æµå¼å¸ƒå±€ï¼ˆåŒçº§æ¨ªæ’ï¼‰ */
        .kw-group-content {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 30px;
            padding: 8px 0;
            align-items: flex-start;
        }

        /* å…³é”®è¯èƒ¶å›Š - åŸºç¡€æ ·å¼ */
        .kw-capsule {
            display: inline-flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: center;
            border-radius: 8px;
            transition: all 0.2s;
            margin: 2px;
            vertical-align: top;
        }

        /* æœ‰å­å…³é”®è¯çš„çˆ¶çº§èƒ¶å›Š - åŒ…è£¹å¼å¸ƒå±€ */
        .kw-capsule.has-children {
            display: inline-flex;
            flex-direction: column;
            align-items: flex-start;
            border: 2px solid rgba(100, 149, 237, 0.35);
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(100, 149, 237, 0.1) 0%, rgba(100, 149, 237, 0.03) 100%);
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(100, 149, 237, 0.15);
            margin: 4px;
            vertical-align: top;
        }
        .kw-capsule.has-children:hover {
            border-color: rgba(100, 149, 237, 0.6);
            box-shadow: 0 2px 8px rgba(100, 149, 237, 0.25);
        }

        /* ç¬¬2å±‚åµŒå¥— - ç¿ ç»¿è‰² */
        .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.12) 0%, rgba(46, 204, 113, 0.04) 100%);
            border-color: rgba(46, 204, 113, 0.4);
            box-shadow: 0 1px 3px rgba(46, 204, 113, 0.15);
        }

        /* ç¬¬3å±‚åµŒå¥— - ç´«ç½—å…° */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.14) 0%, rgba(155, 89, 182, 0.05) 100%);
            border-color: rgba(155, 89, 182, 0.45);
            box-shadow: 0 1px 3px rgba(155, 89, 182, 0.15);
        }

        /* ç¬¬4å±‚åµŒå¥— - æ©™è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(230, 126, 34, 0.14) 0%, rgba(230, 126, 34, 0.05) 100%);
            border-color: rgba(230, 126, 34, 0.45);
            box-shadow: 0 1px 3px rgba(230, 126, 34, 0.15);
        }

        /* ç¬¬5å±‚åµŒå¥— - ç«çº¢è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.14) 0%, rgba(233, 30, 99, 0.05) 100%);
            border-color: rgba(233, 30, 99, 0.45);
            box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
        }

        /* ç¬¬6å±‚åµŒå¥— - é’è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(0, 188, 212, 0.14) 0%, rgba(0, 188, 212, 0.05) 100%);
            border-color: rgba(0, 188, 212, 0.45);
            box-shadow: 0 1px 3px rgba(0, 188, 212, 0.15);
        }

        /* ç¬¬7å±‚åµŒå¥— - ç¥ç€è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.14) 0%, rgba(255, 193, 7, 0.05) 100%);
            border-color: rgba(255, 193, 7, 0.45);
            box-shadow: 0 1px 3px rgba(255, 193, 7, 0.15);
        }

        /* ç¬¬8å±‚åµŒå¥— - é›è“è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(63, 81, 181, 0.14) 0%, rgba(63, 81, 181, 0.05) 100%);
            border-color: rgba(63, 81, 181, 0.45);
            box-shadow: 0 1px 3px rgba(63, 81, 181, 0.15);
        }

        /* ç¬¬9å±‚åµŒå¥— - æ£•è¤è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(121, 85, 72, 0.14) 0%, rgba(121, 85, 72, 0.05) 100%);
            border-color: rgba(121, 85, 72, 0.45);
            box-shadow: 0 1px 3px rgba(121, 85, 72, 0.15);
        }

        /* ç¬¬10å±‚åµŒå¥— - æ·±ç²‰è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(255, 64, 129, 0.14) 0%, rgba(255, 64, 129, 0.05) 100%);
            border-color: rgba(255, 64, 129, 0.45);
            box-shadow: 0 1px 3px rgba(255, 64, 129, 0.15);
        }

        /* ç¬¬11å±‚åµŒå¥— - å¢¨ç»¿è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(0, 150, 136, 0.14) 0%, rgba(0, 150, 136, 0.05) 100%);
            border-color: rgba(0, 150, 136, 0.45);
            box-shadow: 0 1px 3px rgba(0, 150, 136, 0.15);
        }

        /* ç¬¬12å±‚åµŒå¥— - æ·±ç´«è‰² */
        .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children .kw-capsule.has-children {
            background: linear-gradient(135deg, rgba(103, 58, 183, 0.14) 0%, rgba(103, 58, 183, 0.05) 100%);
            border-color: rgba(103, 58, 183, 0.45);
            box-shadow: 0 1px 3px rgba(103, 58, 183, 0.15);
        }

        /* å…³é”®è¯èƒ¶å›Šå¤´éƒ¨ - æ›´ç´§å‡‘çš„æ ‡ç­¾æ ·å¼ */
        .kw-capsule-header {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 11px;
            line-height: 1.4;
        }
        .kw-capsule-header:hover {
            transform: scale(1.02);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .kw-capsule-header.type-yaml { background: ${COLORS.yaml.bg}; color: ${COLORS.yaml.text}; }
        .kw-capsule-header.type-plus { background: ${COLORS.plus.bg}; color: ${COLORS.plus.text}; }
        .kw-capsule-header.type-dot { background: ${COLORS.dot.bg}; color: ${COLORS.dot.text}; }
        /* æ··åˆç±»å‹ - æ¸å˜èƒŒæ™¯ */
        .kw-capsule-header.type-mixed {
            background: linear-gradient(135deg, ${COLORS.yaml.bg} 0%, ${COLORS.plus.bg} 50%, ${COLORS.dot.bg} 100%);
            color: var(--text-normal);
            border: 1px solid rgba(100, 100, 100, 0.25);
            font-weight: 500;
        }

        .kw-capsule-icon { font-size: 7px; opacity: 0.85; }
        .kw-capsule-icon-mixed { font-size: 6px; letter-spacing: 1px; }
        .kw-capsule-label { font-weight: 500; font-size: 11px; white-space: nowrap; }
        .kw-capsule-badge {
            background: rgba(0,0,0,0.1);
            padding: 0 4px;
            border-radius: 6px;
            font-size: 9px;
            margin-left: 1px;
        }
        .kw-capsule-expand {
            font-size: 8px;
            transition: transform 0.2s;
            margin-left: 1px;
            opacity: 0.7;
        }
        .kw-capsule.expanded .kw-capsule-expand { transform: rotate(90deg); }

        /* å­å…³é”®è¯å®¹å™¨ - æ°´å¹³æµå¼å¸ƒå±€ï¼ˆåŒçº§æ¨ªæ’ï¼Œæ•´ä½“åœ¨çˆ¶çº§ä¸‹æ–¹ï¼‰ */
        .kw-capsule-children {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            width: 100%;
            align-items: flex-start;
        }
        /* æŠ˜å æ—¶éšè— */
        .kw-capsule.collapsed > .kw-capsule-children { display: none; }

        /* ç¬”è®°æŠ½å±‰ */
        .kw-notes-drawer {
            margin-top: 8px;
            padding: 8px;
            background: var(--background-primary);
            border-radius: 6px;
            border: 1px solid var(--background-modifier-border);
            display: none;
        }
        .kw-capsule.notes-open > .kw-notes-drawer { display: block; }

        .kw-note-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .kw-note-item:hover {
            background: var(--background-modifier-hover);
            color: var(--text-normal);
        }
        .kw-note-suffix {
            color: var(--text-faint);
            font-size: 11px;
        }

        /* ç¬”è®°æŠ½å±‰åˆ†ç»„æ ‡é¢˜ */
        .kw-drawer-group-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            margin-top: 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 4px;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .kw-drawer-group-header:first-child { margin-top: 0; }
        .kw-drawer-group-header.type-yaml {
            background: ${COLORS.yaml.bg};
            color: ${COLORS.yaml.text};
            border-left: 3px solid ${COLORS.yaml.text};
        }
        .kw-drawer-group-header.type-plus {
            background: ${COLORS.plus.bg};
            color: ${COLORS.plus.text};
            border-left: 3px solid ${COLORS.plus.text};
        }
        .kw-drawer-group-header.type-dot {
            background: ${COLORS.dot.bg};
            color: ${COLORS.dot.text};
            border-left: 3px solid ${COLORS.dot.text};
        }
        .kw-drawer-group-count {
            background: rgba(0,0,0,0.1);
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: auto;
        }

        /* ç»Ÿè®¡æ  */
        .kw-stats { font-size: 12px; color: var(--text-muted); padding: 10px; border-top: 1px solid var(--background-modifier-border); margin-top: 16px; }

        /* ç©ºçŠ¶æ€ */
        .kw-empty { text-align: center; padding: 40px; color: var(--text-muted); }

        /* ============ ç®¡ç†ç•Œé¢æ ·å¼ï¼ˆGTDé£æ ¼ï¼‰============ */
        .kw-mgr-container { background: var(--background-secondary); border-radius: 12px; padding: 20px; min-height: 500px; }
        .kw-mgr-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--interactive-accent); }
        .kw-mgr-title { font-size: 1.5em; font-weight: 800; color: var(--text-normal); }
        .kw-mgr-actions { display: flex; gap: 8px; }

        .kw-mgr-stats { display: flex; gap: 20px; padding: 10px 15px; background: var(--background-primary); border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; color: var(--text-muted); }
        .kw-mgr-stat-item { display: flex; align-items: center; gap: 6px; }
        .kw-mgr-stat-num { font-weight: 700; color: var(--text-normal); }

        /* ç®¡ç†ç•Œé¢çš„å…³é”®è¯é¡¹ */
        .kw-mgr-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin: 4px 0;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }
        .kw-mgr-item:hover {
            border-color: var(--interactive-accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .kw-mgr-item.drag-over {
            border: 2px dashed var(--interactive-accent);
            background: rgba(var(--interactive-accent-rgb), 0.1);
        }
        .kw-mgr-item.dragging { opacity: 0.5; transform: scale(0.98); }

        .kw-mgr-item-icon { font-size: 1.2em; margin-right: 10px; width: 28px; text-align: center; }
        .kw-mgr-item-info { flex: 1; }
        .kw-mgr-item-label { font-weight: 600; color: var(--text-normal); }
        .kw-mgr-item-meta { font-size: 0.8em; color: var(--text-muted); margin-top: 2px; }
        .kw-mgr-item-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }

        .kw-mgr-item-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
        .kw-mgr-item:hover .kw-mgr-item-actions { opacity: 1; }
        .kw-mgr-item-btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--background-modifier-border);
            background: var(--background-secondary);
            cursor: pointer;
            font-size: 12px;
        }
        .kw-mgr-item-btn:hover { background: var(--interactive-accent); color: white; border-color: transparent; }
        .kw-mgr-item-btn.delete:hover { background: #e74c3c; }

        .kw-mgr-children {
            margin-left: 30px;
            border-left: 2px solid var(--background-modifier-border);
            padding-left: 10px;
        }

        .kw-mgr-drop-zone {
            height: 30px;
            border: 2px dashed transparent;
            border-radius: 6px;
            margin: 4px 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.85em;
        }
        .kw-mgr-drop-zone.active {
            border-color: var(--interactive-accent);
            background: rgba(var(--interactive-accent-rgb), 0.05);
        }
        .kw-mgr-drop-zone.active::before { content: "æ‹–æ”¾åˆ°æ­¤å¤„è®¾ä¸ºé¡¶å±‚"; }

        /* ç¼–è¾‘è¡¨å• */
        .kw-form { background: var(--background-primary); border: 1px solid var(--background-modifier-border); border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none; }
        .kw-form.visible { display: block; }
        .kw-form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .kw-form-label { width: 60px; font-weight: 500; color: var(--text-muted); font-size: 0.9em; }
        .kw-form-input { flex: 1; padding: 8px 12px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-secondary); color: var(--text-normal); font-size: 14px; }
        .kw-form-input:focus { outline: none; border-color: var(--interactive-accent); }

        /* æ¨¡æ€æ¡† */
        .kw-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .kw-modal { width: 400px; max-height: 70vh; background: var(--background-primary); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; display: flex; flex-direction: column; }
        .kw-modal-header { padding: 14px 16px; background: var(--background-secondary); border-bottom: 1px solid var(--background-modifier-border); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .kw-modal-badge { background: var(--interactive-accent); color: var(--text-on-accent); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: normal; }
        .kw-modal-list { flex: 1; overflow-y: auto; max-height: 400px; }
        .kw-modal-item { padding: 10px 16px; border-bottom: 1px solid var(--background-modifier-border); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .kw-modal-item:hover { background: var(--background-modifier-hover); }
        .kw-modal-footer { padding: 12px; text-align: center; border-top: 1px solid var(--background-modifier-border); }
        .kw-modal-footer button { border: none; background: none; color: var(--interactive-accent); font-size: 14px; cursor: pointer; font-weight: 500; }
        .kw-edit-modal { width: min(560px, 92vw); max-height: 85vh; overflow: visible; }
        .kw-edit-modal-body { padding: 16px; }
        .kw-edit-modal-tip { margin-bottom: 12px; font-size: 12px; color: var(--text-muted); }
        .kw-edit-modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; }
        .kw-edit-modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-muted);
        }
        .kw-edit-modal-close:hover {
            color: var(--text-normal);
        }

        /* ============ çˆ¶çº§é€‰æ‹©å™¨ï¼ˆå¸¦æœç´¢ç­›é€‰ï¼‰============ */
        .kw-parent-selector {
            position: relative;
            flex: 1;
        }
        .kw-parent-input-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            background: var(--background-secondary);
            overflow: hidden;
        }
        .kw-parent-input-wrapper:focus-within {
            border-color: var(--interactive-accent);
        }
        .kw-parent-input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-normal);
            font-size: 14px;
            outline: none;
        }
        .kw-parent-clear {
            padding: 4px 10px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 16px;
            transition: color 0.15s;
        }
        .kw-parent-clear:hover {
            color: var(--text-normal);
        }
        .kw-parent-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        .kw-parent-dropdown.visible {
            display: block;
        }
        .kw-parent-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            transition: background 0.1s;
        }
        .kw-parent-option:hover, .kw-parent-option.highlighted {
            background: var(--background-modifier-hover);
        }
        .kw-parent-option.selected {
            background: rgba(var(--interactive-accent-rgb), 0.1);
            color: var(--interactive-accent);
        }
        .kw-parent-option-icon {
            font-size: 12px;
            opacity: 0.8;
        }
        .kw-parent-option-text {
            flex: 1;
        }
        .kw-parent-option-match {
            background: rgba(255, 230, 0, 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }
        .kw-parent-no-results {
            padding: 12px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }
        .kw-parent-stats {
            padding: 6px 12px;
            font-size: 11px;
            color: var(--text-faint);
            border-top: 1px solid var(--background-modifier-border);
            background: var(--background-secondary);
        }

        /* ============ å¤šå±‚çº§æŠ½å±‰æ ·å¼ (v3.4æ–°å¢)============ */
        .kw-drawer-note {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .kw-drawer-note:hover {
            background: var(--background-modifier-hover);
            color: var(--text-normal);
        }

        .kw-drawer-parent {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-normal);
            background: var(--background-secondary);
            transition: all 0.15s;
        }
        .kw-drawer-parent:hover {
            background: var(--background-modifier-hover);
        }

        .kw-drawer-toggle {
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s;
            display: inline-block;
        }

        .kw-drawer-label {
            flex: 1;
        }

        .kw-drawer-count {
            font-size: 10px;
            color: var(--text-muted);
            background: rgba(0,0,0,0.08);
            padding: 1px 6px;
            border-radius: 8px;
        }

        .kw-drawer-children {
            margin-left: 10px;
            padding-left: 8px;
            border-left: 1px solid var(--background-modifier-border);
        }
    `;
    document.head.appendChild(style);
}

// ============ å…¨å±€çŠ¶æ€ ============
if (!window._kwIndexV3) {
    window._kwIndexV3 = {
        keywords: {},           // å…³é”®è¯æ•°æ® { id: { id, baseKeyword, displayText, type, parentId, order, notes: [{path, name, suffix, sourceType}], sortKey } }
        collapsedIds: new Set(),// æŠ˜å çš„å…³é”®è¯IDï¼ˆé»˜è®¤å±•å¼€ï¼Œæ‰€ä»¥è®°å½•æŠ˜å çš„ï¼‰
        notesOpenIds: new Set(),// æ‰“å¼€ç¬”è®°æŠ½å±‰çš„å…³é”®è¯ID
        managerMode: false,     // æ˜¯å¦åœ¨ç®¡ç†æ¨¡å¼
        dragId: null            // å½“å‰æ‹–æ‹½çš„å…³é”®è¯ID
    };
}
// ç¡®ä¿ Set å¯¹è±¡å­˜åœ¨ï¼ˆé˜²æ­¢åºåˆ—åŒ–é—®é¢˜ï¼‰
if (!(window._kwIndexV3.collapsedIds instanceof Set)) {
    window._kwIndexV3.collapsedIds = new Set();
}
if (!(window._kwIndexV3.notesOpenIds instanceof Set)) {
    window._kwIndexV3.notesOpenIds = new Set();
}
const state = window._kwIndexV3;

// ============ æ•°æ®ç®¡ç† ============

async function loadIndex() {
    try {
        if (await app.vault.adapter.exists(INDEX_PATH)) {
            const content = await app.vault.adapter.read(INDEX_PATH);
            const json = JSON.parse(content);
            state.keywords = json.keywords || {};
            return state.keywords;
        }
    } catch (e) {
        console.error('åŠ è½½ç´¢å¼•å¤±è´¥:', e);
    }
    return {};
}

async function saveIndex() {
    const json = {
        keywords: state.keywords,
        version: "3.3",
        lastModified: moment().format("YYYY-MM-DD HH:mm:ss"),
        metadata: {
            total: Object.keys(state.keywords).length,
            topLevel: Object.values(state.keywords).filter(k => !k.parentId).length
        }
    };
    const content = JSON.stringify(json, null, 2);

    const dir = INDEX_PATH.substring(0, INDEX_PATH.lastIndexOf('/'));
    if (dir && !(await app.vault.adapter.exists(dir))) {
        await app.vault.adapter.mkdir(dir);
    }

    if (await app.vault.adapter.exists(INDEX_PATH)) {
        const file = app.vault.getAbstractFileByPath(INDEX_PATH);
        await app.vault.modify(file, content);
    } else {
        await app.vault.create(INDEX_PATH, content);
    }
}

// ============ å…³é”®è¯æå–é€»è¾‘ ============

/**
 * è§£æå…³é”®è¯å­—ç¬¦ä¸²ï¼Œæå–åŸºç¡€å…³é”®è¯å’Œåç¼€
 * ä¾‹å¦‚ï¼š'MMKV-Aä¸Šé¡¹+æ–°å¼€å§‹' â†’ { base: 'MMKV-Aä¸Šé¡¹', suffix: '+æ–°å¼€å§‹' }
 * ä¾‹å¦‚ï¼š'ç§‘æŠ€å§”å‘˜ä¼š' â†’ { base: 'ç§‘æŠ€å§”å‘˜ä¼š', suffix: '' }
 */
function parseKeywordWithSuffix(kwString) {
    const plusIndex = kwString.indexOf('+');
    if (plusIndex > 0) {
        return {
            base: kwString.substring(0, plusIndex),
            suffix: kwString.substring(plusIndex)  // åŒ…å«+å·
        };
    }
    return { base: kwString, suffix: '' };
}

/**
 * ç”Ÿæˆå…³é”®è¯IDï¼ˆåŸºäºåŸºç¡€å…³é”®è¯çš„hashï¼‰
 */
function generateKeywordId(baseKeyword) {
    let hash = 0;
    for (let i = 0; i < baseKeyword.length; i++) {
        hash = ((hash << 5) - hash) + baseKeyword.charCodeAt(i);
        hash = hash & hash;
    }
    return 'kw-' + Math.abs(hash).toString(36);
}

/**
 * è·å–æ’åºå­—æ¯
 */
function getSortLetter(keyword) {
    const cleaned = keyword.replace(/^[_\.+\s]+/, '');
    const firstChar = cleaned.charAt(0);
    return (firstChar && /[A-Za-z]/.test(firstChar)) ? firstChar.toUpperCase() : '#';
}

/**
 * è·å–æ˜¾ç¤ºæ–‡æœ¬
 * è§„åˆ™ï¼šå¦‚æœå…³é”®è¯ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼Œåªç§»é™¤ç¬¬ä¸€ä¸ªå­—æ¯ï¼ˆç”¨äºalphabeticalç´¢å¼•å®šä½ï¼‰
 * ä¾‹å¦‚ï¼š'EEVAç³»ç»Ÿè®¾è®¡' â†’ 'EVAç³»ç»Ÿè®¾è®¡'ï¼ˆç§»é™¤ç¬¬ä¸€ä¸ªEï¼‰
 *      'AATEC7' â†’ 'ATEC7'ï¼ˆç§»é™¤ç¬¬ä¸€ä¸ªAï¼‰
 *      'Cè¶…è¶Šæ€§' â†’ 'è¶…è¶Šæ€§'ï¼ˆç§»é™¤Cï¼‰
 *      'ç§‘æŠ€å§”å‘˜ä¼š' â†’ 'ç§‘æŠ€å§”å‘˜ä¼š'ï¼ˆä¸ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼Œä¿æŒä¸å˜ï¼‰
 */
function getDisplayText(keyword) {
    // æ£€æŸ¥ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸ºå¤§å†™å­—æ¯A-Z
    if (keyword.length > 1 && /^[A-Z]/.test(keyword)) {
        return keyword.substring(1);  // ç§»é™¤ç¬¬ä¸€ä¸ªå­—ç¬¦
    }
    return keyword;
}

function compareKeywordName(a, b) {
    const aName = a.displayText || a.baseKeyword || '';
    const bName = b.displayText || b.baseKeyword || '';
    return aName.localeCompare(bName, 'zh-CN', { numeric: true, sensitivity: 'base' });
}

function compareNoteName(a, b) {
    const aName = a.name || '';
    const bName = b.name || '';
    return aName.localeCompare(bName, 'zh-CN', { numeric: true, sensitivity: 'base' });
}

/**
 * è®¡ç®—sortKeyï¼ˆåŸºäºå…³è”ç¬”è®°çš„æœ€å°ATOMç¼–ç ï¼‰
 */
function computeSortKey(notes) {
    const codes = [];
    for (const note of notes) {
        const m = note.path.match(/ATOM@([\d.]+)/);
        if (m) codes.push(m[1]);
    }
    if (codes.length === 0) return 'ZZZZZZ';

    codes.sort((a, b) => {
        const pa = a.split('.').map(Number);
        const pb = b.split('.').map(Number);
        for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
            const diff = (pa[i] || 0) - (pb[i] || 0);
            if (diff !== 0) return diff;
        }
        return 0;
    });

    return codes[0].split('.').map(p => String(p).padStart(3, '0')).join('.');
}

// ============ å…¨é‡æ‰«æ ============

async function fullScan() {
    // ä¸´æ—¶mapï¼šbaseKeyword -> { notes: [], type }
    const keywordMap = new Map();
    const files = app.vault.getMarkdownFiles();

    for (const file of files) {
        if (SCAN_FOLDER && !file.path.startsWith(SCAN_FOLDER)) continue;

        try {
            // 1. ä»yamlæå– - æ³¨æ„å­—æ®µåæ˜¯ä¸­æ–‡"å…³é”®è¯ç®¡ç†"
            const cache = app.metadataCache.getFileCache(file);
            const yamlKws = cache?.frontmatter?.['å…³é”®è¯ç®¡ç†'] || [];
            if (Array.isArray(yamlKws)) {
                yamlKws.forEach(kw => {
                    if (typeof kw === 'string' && kw.trim()) {
                        const { base, suffix } = parseKeywordWithSuffix(kw.trim());
                        addToKeywordMap(keywordMap, base, file, suffix, 'yaml');
                    }
                });
            }

            // 2. ä»æ–‡ä»¶åæå– ++...++
            // æ³¨æ„ï¼šå†…å®¹ä¸­å¯èƒ½åŒ…å«å•ä¸ª+å·ä½œä¸ºåç¼€åˆ†éš”ç¬¦ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨[^+]+
            // ä½¿ç”¨éè´ªå©ªåŒ¹é…ï¼ŒåŒ¹é…åˆ°ä¸‹ä¸€ä¸ª++ä¸ºæ­¢
            const fileName = file.basename;
            const plusRegex = /\+\+(.+?)\+\+/g;
            let match;
            while ((match = plusRegex.exec(fileName)) !== null) {
                const { base, suffix } = parseKeywordWithSuffix(match[1].trim());
                addToKeywordMap(keywordMap, base, file, suffix, 'plus');
            }

            // 3. ä»æ–‡ä»¶åæå– Â·Â·...Â·Â·
            const dotRegex = /Â·Â·([^Â·]+)Â·Â·/g;
            while ((match = dotRegex.exec(fileName)) !== null) {
                const { base, suffix } = parseKeywordWithSuffix(match[1].trim());
                addToKeywordMap(keywordMap, base, file, suffix, 'dot');
            }

        } catch (e) {
            // è·³è¿‡
        }
    }

    // ä¿ç•™ç°æœ‰çš„parentIdå’Œorder
    const oldKeywords = { ...state.keywords };

    // è½¬æ¢ä¸ºstate.keywordsæ ¼å¼
    state.keywords = {};
    for (const [baseKeyword, info] of keywordMap.entries()) {
        const id = generateKeywordId(baseKeyword);
        const oldData = oldKeywords[id] || {};

        state.keywords[id] = {
            id: id,
            baseKeyword: baseKeyword,
            displayText: getDisplayText(baseKeyword),
            sortLetter: getSortLetter(baseKeyword),
            type: info.type,
            notes: Array.from(info.notes.values()),
            sortKey: computeSortKey(Array.from(info.notes.values())),
            // ä¿ç•™ç”¨æˆ·è®¾ç½®çš„å±‚çº§å…³ç³»
            parentId: oldData.parentId || null,
            order: oldData.order ?? 0
        };
    }

    await saveIndex();
    return state.keywords;
}

function addToKeywordMap(map, baseKeyword, file, suffix, type) {
    if (!map.has(baseKeyword)) {
        map.set(baseKeyword, { notes: [], type: type });
    }
    const entry = map.get(baseKeyword);

    // å…è®¸åŒä¸€æ–‡ä»¶/åŒä¸€æ¥æºçš„å¤šä¸ªåç¼€å¹¶å­˜ï¼Œç”¨æ•°ç»„å­˜å‚¨
    entry.notes.push({
        path: file.path,
        name: file.basename,
        suffix: suffix,
        sourceType: type
    });

    // ç±»å‹ä¼˜å…ˆçº§: yaml > plus > dotï¼ˆç”¨äºå…³é”®è¯æ•´ä½“é»˜è®¤æ˜¾ç¤ºç±»å‹ï¼‰
    const priority = { dot: 1, plus: 2, yaml: 3 };
    if (priority[type] > priority[entry.type]) {
        entry.type = type;
    }
}

// ============ å±‚çº§å·¥å…·å‡½æ•° ============

// å­å…³é”®è¯æ’åºï¼šæŒ‰åç§°ï¼ˆdisplayText/baseKeywordï¼‰å­—æ¯/æ‹¼éŸ³æ’åº
function getChildKeywords(parentId) {
    return Object.values(state.keywords)
        .filter(kw => kw.parentId === parentId)
        .sort(compareKeywordName);
}

function getTopLevelKeywords() {
    return Object.values(state.keywords)
        .filter(kw => !kw.parentId)
        .sort(compareKeywordName);
}

function getDescendantIds(kwId) {
    const descendants = [];
    const findChildren = (parentId) => {
        Object.values(state.keywords).forEach(kw => {
            if (kw.parentId === parentId) {
                descendants.push(kw.id);
                findChildren(kw.id);
            }
        });
    };
    findChildren(kwId);
    return descendants;
}

// ============ åå‘åŒæ­¥åŠŸèƒ½ ============

/**
 * åå‘åŒæ­¥ï¼šæ›´æ–°åŸå§‹ç¬”è®°æ–‡ä»¶ä¸­çš„å…³é”®è¯
 * @param {string} oldKeyword - åŸå…³é”®è¯ï¼ˆåŸºç¡€éƒ¨åˆ†ï¼‰
 * @param {string} newKeyword - æ–°å…³é”®è¯
 * @param {Array} notes - å…³è”çš„ç¬”è®°åˆ—è¡¨ [{path, name, suffix}]
 * @param {string} type - å…³é”®è¯ç±»å‹ 'yaml' | 'plus' | 'dot'
 */
async function syncKeywordToNotes(oldKeyword, newKeyword, notes, type) {
    if (oldKeyword === newKeyword) return { updated: 0, failed: 0 };

    let updated = 0;
    let failed = 0;

    for (const note of notes) {
        try {
            const file = app.vault.getAbstractFileByPath(note.path);
            if (!file) continue;

            let content = await app.vault.read(file);
            let modified = false;

            // 1. æ›´æ–°YAMLä¸­çš„å…³é”®è¯ç®¡ç†å­—æ®µ
            if (type === 'yaml') {
                // åŒ¹é…yaml frontmatterä¸­çš„å…³é”®è¯ç®¡ç†å­—æ®µ
                const yamlRegex = /^---\n([\s\S]*?)\n---/;
                const yamlMatch = content.match(yamlRegex);
                if (yamlMatch) {
                    const yamlContent = yamlMatch[1];
                    // æ„å»ºå®Œæ•´çš„åŸå…³é”®è¯ï¼ˆåŒ…å«åç¼€ï¼‰
                    const oldFull = note.suffix ? oldKeyword + note.suffix : oldKeyword;
                    const newFull = note.suffix ? newKeyword + note.suffix : newKeyword;

                    // æ›¿æ¢yamlä¸­çš„å…³é”®è¯
                    const newYaml = yamlContent.replace(
                        new RegExp(`(å…³é”®è¯ç®¡ç†:[\\s\\S]*?)${escapeRegex(oldFull)}`, 'g'),
                        `$1${newFull}`
                    );
                    if (newYaml !== yamlContent) {
                        content = content.replace(yamlMatch[1], newYaml);
                        modified = true;
                    }
                }
            }

            // 2. æ›´æ–°æ–‡ä»¶åä¸­çš„ ++...++ æˆ– Â·Â·...Â·Â·
            if (type === 'plus' || type === 'dot') {
                const delimiter = type === 'plus' ? '++' : 'Â·Â·';
                const oldFull = note.suffix ? oldKeyword + note.suffix : oldKeyword;
                const newFull = note.suffix ? newKeyword + note.suffix : newKeyword;
                const oldPattern = `${delimiter}${oldFull}${delimiter}`;
                const newPattern = `${delimiter}${newFull}${delimiter}`;

                // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ…å«è¯¥å…³é”®è¯
                if (note.name.includes(oldPattern)) {
                    const newName = note.name.replace(oldPattern, newPattern);
                    const newPath = note.path.replace(note.name, newName);

                    // é‡å‘½åæ–‡ä»¶
                    await app.fileManager.renameFile(file, newPath);
                    modified = true;
                }
            }

            // å¦‚æœå†…å®¹æœ‰ä¿®æ”¹ï¼ˆyamlæƒ…å†µï¼‰ï¼Œä¿å­˜æ–‡ä»¶
            if (modified && type === 'yaml') {
                await app.vault.modify(file, content);
            }

            if (modified) updated++;
        } catch (e) {
            console.error(`æ›´æ–°ç¬”è®°å¤±è´¥: ${note.path}`, e);
            failed++;
        }
    }

    return { updated, failed };
}

/**
 * è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
 */
function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ============ æ¸²æŸ“å‡½æ•°å¼•ç”¨ ============
let renderViewFn = null;

// ============ å¥—åœˆå¼å±•ç¤ºè§†å›¾ ============

function renderDisplayView(container) {
    container.innerHTML = '';
    container.className = 'kw-container';

    // å›¾ä¾‹
    const legend = container.createEl('div', { cls: 'kw-legend' });
    legend.innerHTML = `
        <span class="kw-legend-item kw-legend-yaml"><span>${COLORS.yaml.icon}</span> YAMLå…³é”®è¯ç®¡ç†</span>
        <span class="kw-legend-item kw-legend-plus"><span>${COLORS.plus.icon}</span> å±‚çº§å…³é”®è¯ ++...++</span>
        <span class="kw-legend-item kw-legend-dot"><span>${COLORS.dot.icon}</span> è¡Œå†…å…³é”®è¯ Â·Â·...Â·Â·</span>
    `;

    // å·¥å…·æ 
    const toolbar = container.createEl('div', { cls: 'kw-toolbar' });

    const scanBtn = toolbar.createEl('button', { text: 'ğŸ”„ æ‰«æå…³é”®è¯' });
    scanBtn.onclick = async () => {
        scanBtn.disabled = true;
        scanBtn.textContent = 'æ‰«æä¸­...';
        try {
            const result = await fullScan();
            const count = Object.keys(result).length;
            const topLevelCount = Object.values(result).filter(k => !k.parentId).length;
            new Notice(`âœ… æ‰«æå®Œæˆï¼Œæ‰¾åˆ° ${count} ä¸ªå…³é”®è¯ï¼ˆ${topLevelCount} ä¸ªé¡¶å±‚ï¼‰`);
            console.log('æ‰«æç»“æœ:', result);
            console.log('é¡¶å±‚å…³é”®è¯:', Object.values(result).filter(k => !k.parentId));
        } catch (e) {
            console.error('æ‰«æå‡ºé”™:', e);
            new Notice(`âŒ æ‰«æå‡ºé”™: ${e.message}`);
        }
        renderViewFn();
    };

    const collapseAllBtn = toolbar.createEl('button', { text: 'ğŸ“ å…¨éƒ¨æŠ˜å ', cls: 'secondary' });
    collapseAllBtn.onclick = () => {
        if (!(state.collapsedIds instanceof Set)) state.collapsedIds = new Set();
        if (!(state.notesOpenIds instanceof Set)) state.notesOpenIds = new Set();
        Object.keys(state.keywords).forEach(id => state.collapsedIds.add(id));
        state.notesOpenIds.clear();
        renderViewFn();
    };

    const expandAllBtn = toolbar.createEl('button', { text: 'ğŸ“‚ å…¨éƒ¨å±•å¼€', cls: 'secondary' });
    expandAllBtn.onclick = () => {
        if (!(state.collapsedIds instanceof Set)) state.collapsedIds = new Set();
        state.collapsedIds.clear();
        renderViewFn();
    };

    const manageBtn = toolbar.createEl('button', { text: 'âš™ï¸ ç®¡ç†å…³é”®è¯' });
    manageBtn.onclick = () => {
        state.managerMode = true;
        renderViewFn();
    };

    const keywords = Object.values(state.keywords);
    console.log('å‡†å¤‡æ¸²æŸ“å…³é”®è¯ï¼Œæ€»æ•°:', keywords.length, 'æ•°æ®:', keywords);

    if (keywords.length === 0) {
        container.createEl('div', { cls: 'kw-empty', text: 'æš‚æ— å…³é”®è¯ï¼Œç‚¹å‡»"æ‰«æå…³é”®è¯"å¼€å§‹' });
        return;
    }

    // æŒ‰å­—æ¯åˆ†ç»„
    const groups = {};
    const letters = [];
    keywords.forEach(kw => {
        const letter = kw.sortLetter || '#';
        if (!groups[letter]) {
            groups[letter] = [];
            letters.push(letter);
        }
        groups[letter].push(kw);
    });
    letters.sort();

    // å­—æ¯å¯¼èˆª
    const nav = container.createEl('div', { cls: 'kw-alphabet-nav' });
    letters.forEach(l => {
        const link = nav.createEl('a', { cls: 'kw-letter-link', text: l });
        link.onclick = () => {
            document.getElementById(`kw-group-${l}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };
    });

    // å†…å®¹åŒºï¼ˆåœ¨å­—æ¯å¯¼èˆªä¹‹ååˆ›å»ºï¼‰
    const content = container.createEl('div', { cls: 'kw-nest-container' });

    // æ¸²æŸ“å„åˆ†ç»„
    console.log('å­—æ¯åˆ†ç»„:', letters, 'åˆ†ç»„è¯¦æƒ…:', groups);

    letters.forEach(letter => {
        const header = content.createEl('h4', { cls: 'kw-group-header', text: letter });
        header.id = `kw-group-${letter}`;

        // ä½¿ç”¨flex wrapå®¹å™¨å®ç°ç´§å‡‘æ’åˆ—
        const groupContainer = content.createEl('div', { cls: 'kw-group-content' });

        // è·å–è¯¥å­—æ¯ç»„çš„é¡¶å±‚å…³é”®è¯
        const topLevelInGroup = groups[letter].filter(kw => !kw.parentId);
        topLevelInGroup.sort(compareKeywordName);

        console.log(`å­—æ¯ç»„ "${letter}": æ€»å…± ${groups[letter].length} ä¸ªï¼Œé¡¶å±‚ ${topLevelInGroup.length} ä¸ª`);

        // è°ƒè¯•ï¼šå¦‚æœè¯¥ç»„æ²¡æœ‰é¡¶å±‚å…³é”®è¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰å…³é”®è¯ï¼ˆå¯èƒ½æ˜¯parentIdæ•°æ®é—®é¢˜ï¼‰
        if (topLevelInGroup.length === 0) {
            console.warn(`å­—æ¯ç»„ "${letter}" æ²¡æœ‰é¡¶å±‚å…³é”®è¯ï¼Œæ˜¾ç¤ºå…¨éƒ¨:`, groups[letter]);
            groups[letter].sort(compareKeywordName).forEach(kw => {
                renderCapsule(groupContainer, kw);
            });
        } else {
            topLevelInGroup.forEach(kw => {
                console.log('æ¸²æŸ“èƒ¶å›Š:', kw.displayText, kw);
                renderCapsule(groupContainer, kw);
            });
        }

        // è°ƒè¯•ï¼šæ£€æŸ¥DOMæ˜¯å¦æ­£ç¡®åˆ›å»º
        console.log(`åˆ†ç»„ "${letter}" æ¸²æŸ“åï¼ŒgroupContainer å­å…ƒç´ æ•°:`, groupContainer.children.length, groupContainer.innerHTML.substring(0, 200));
    });

    // è°ƒè¯•ï¼šæ¸²æŸ“å®Œæˆåæ£€æŸ¥æ•´ä¸ªcontent
    console.log('æ¸²æŸ“å®Œæˆï¼Œcontentå®¹å™¨:', content);
    console.log('content å­å…ƒç´ æ•°:', content.children.length);
    console.log('container å­å…ƒç´ :', Array.from(container.children).map(c => c.className));

    // ç»Ÿè®¡
    const stats = container.createEl('div', { cls: 'kw-stats' });
    const topCount = keywords.filter(k => !k.parentId).length;
    const noteCount = keywords.reduce((sum, k) => sum + k.notes.length, 0);
    stats.textContent = `å…± ${letters.length} ä¸ªåˆ†ç±»ï¼Œ${keywords.length} ä¸ªå…³é”®è¯ï¼Œ${noteCount} ç¯‡å…³è”ç¬”è®°`;
}

/**
 * è·å–å…³é”®è¯ç¬”è®°çš„æ¥æºç±»å‹é›†åˆ
 */
function getKeywordSourceTypes(kw) {
    const types = new Set();
    kw.notes.forEach(note => {
        const sourceType = note.sourceType || kw.type;
        types.add(sourceType);
    });
    return types;
}

// ============ å¤šå±‚çº§æŠ½å±‰åŠŸèƒ½ (v3.4æ–°å¢) ============

/**
 * æŒ‰+å·åˆ†å‰²suffixï¼Œæ„å»ºç¬”è®°çš„å±‚çº§æ ‘ç»“æ„
 * @param {Array} notes - ç¬”è®°æ•°ç»„ [{path, name, suffix, sourceType}, ...]
 * @returns {Object} æ ‘ç»“æ„ { "ç¬¬ä¸€å±‚": { children: { "ç¬¬äºŒå±‚": { children: { ... }, notes: [...] } }, notes: [...] } }
 */
function buildSuffixTree(notes) {
    const root = { children: new Map(), notes: [] };

    notes.forEach(note => {
        const suffix = note.suffix || '';
        // åˆ†å‰²suffixï¼Œç§»é™¤æ¯ä¸ªéƒ¨åˆ†å‰é¢çš„+å·
        const parts = suffix.split('+').filter(p => p.trim());

        if (parts.length === 0) {
            // æ— suffixï¼Œç›´æ¥æ”¾åœ¨æ ¹èŠ‚ç‚¹
            root.notes.push(note);
        } else {
            let current = root;
            // éå†æ¯ä¸€å±‚
            parts.forEach((part, idx) => {
                const trimmedPart = part.trim();
                if (!trimmedPart) return;

                if (!current.children.has(trimmedPart)) {
                    current.children.set(trimmedPart, { children: new Map(), notes: [] });
                }
                current = current.children.get(trimmedPart);

                // æœ€åä¸€å±‚æ”¾ç¬”è®°
                if (idx === parts.length - 1) {
                    current.notes.push(note);
                }
            });
        }
    });

    return root;
}

/**
 * ç»Ÿè®¡èŠ‚ç‚¹çš„æ‰€æœ‰åä»£ç¬”è®°æ•°é‡ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰
 */
function countAllNotes(node) {
    let count = node.notes.length;
    node.children.forEach(child => {
        count += countAllNotes(child);
    });
    return count;
}

/**
 * æ”¶é›†èŠ‚ç‚¹çš„æ‰€æœ‰ç¬”è®°ï¼ˆæ‰å¹³åŒ–ï¼ŒåŒ…æ‹¬è‡ªèº«å’Œæ‰€æœ‰åä»£ï¼‰
 */
function collectAllNotes(node) {
    let allNotes = [...node.notes];
    node.children.forEach(child => {
        allNotes = allNotes.concat(collectAllNotes(child));
    });
    return allNotes;
}

/**
 * é€’å½’æ¸²æŸ“æŠ½å±‰å†…çš„å¤šå±‚çº§æ ‘ (v3.7: å±‚çº§é»˜è®¤å±•å¼€ï¼Œç¬”è®°é»˜è®¤å±•å¼€)
 * @param {HTMLElement} container - å®¹å™¨å…ƒç´ 
 * @param {Object} node - æ ‘èŠ‚ç‚¹
 * @param {number} level - å½“å‰å±‚çº§ï¼ˆç”¨äºç¼©è¿›å’Œæ ·å¼ï¼‰
 * @param {string} type - æ¥æºç±»å‹ï¼ˆç”¨äºæ ·å¼ï¼‰
 * @param {boolean} expandNotesByDefault - ç¬”è®°é»˜è®¤æ˜¯å¦å±•å¼€
 */
function renderDrawerTree(container, node, level, type, expandNotesByDefault = true) {
    // è°ƒè¯•æ—¥å¿—
    console.log(`[renderDrawerTree] level=${level}, expandNotesByDefault=${expandNotesByDefault}, notesCount=${node.notes.length}, childrenCount=${node.children.size}`);

    // --- é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹ï¼ˆå±‚çº§ï¼‰---
    const childEntries = Array.from(node.children.entries())
        .sort((a, b) => a[0].localeCompare(b[0], 'zh-CN', { numeric: true, sensitivity: 'base' }));

    childEntries.forEach(([childName, childNode]) => {
        const hasChildren = childNode.children.size > 0;

        if (hasChildren) {
            // === æœ‰å­å±‚çº§çš„èŠ‚ç‚¹ ===
            const parentLabel = container.createEl('div', { cls: 'kw-drawer-parent' });
            parentLabel.style.marginLeft = `${level * 20}px`;

            const toggle = parentLabel.createEl('span', { cls: 'kw-drawer-toggle', text: 'â–¼' });
            const label = parentLabel.createEl('span', { cls: 'kw-drawer-label', text: childName });
            const count = parentLabel.createEl('span', { cls: 'kw-drawer-count', text: `(${countAllNotes(childNode)})` });

            // å­å®¹å™¨ï¼ˆé»˜è®¤å±•å¼€ï¼‰
            const childContainer = container.createEl('div', { cls: 'kw-drawer-children' });
            childContainer.style.display = 'block';

            // æŠ˜å /å±•å¼€äº¤äº’
            let isExpanded = true; // é»˜è®¤å±•å¼€
            toggle.style.transform = 'rotate(90deg)';
            parentLabel.onclick = (e) => {
                e.stopPropagation();
                isExpanded = !isExpanded;
                toggle.style.transform = isExpanded ? 'rotate(90deg)' : '';
                childContainer.style.display = isExpanded ? 'block' : 'none';
            };

            // æ·»åŠ åˆ°å®¹å™¨ï¼ˆå…ˆæ ‡ç­¾ï¼Œå†å­å®¹å™¨ï¼‰
            container.appendChild(parentLabel);
            container.appendChild(childContainer);

            // v3.7: å¦‚æœè¯¥å±‚çº§æœ‰ç›´å±ç¬”è®°ï¼Œæ¸²æŸ“å¯æŠ˜å çš„"ğŸ“ æ ¹ç¬”è®°"æŒ‰é’®
            if (childNode.notes.length > 0) {
                const noteWrapper = childContainer.createEl('div', { cls: 'kw-drawer-parent' });
                noteWrapper.style.marginLeft = '20px';

                const noteToggle = noteWrapper.createEl('span', { cls: 'kw-drawer-toggle', text: 'â–¼' });
                noteWrapper.createEl('span', { cls: 'kw-drawer-label', text: 'ğŸ“ æ ¹ç¬”è®°' });
                noteWrapper.createEl('span', { cls: 'kw-drawer-count', text: `(${childNode.notes.length})` });

                // ç¬”è®°å®¹å™¨ï¼ˆé»˜è®¤æŠ˜å ï¼‰
                const notesContainer = noteWrapper.createEl('div', { cls: 'kw-drawer-children' });
                notesContainer.style.display = 'none';

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                let isNoteExpanded = expandNotesByDefault;
                noteToggle.style.transform = isNoteExpanded ? 'rotate(90deg)' : '';
                notesContainer.style.display = isNoteExpanded ? 'block' : 'none';

                noteWrapper.onclick = (e) => {
                    e.stopPropagation();
                    isNoteExpanded = !isNoteExpanded;
                    noteToggle.style.transform = isNoteExpanded ? 'rotate(90deg)' : '';
                    notesContainer.style.display = isNoteExpanded ? 'block' : 'none';
                };

                const sortedNotes = [...childNode.notes].sort(compareNoteName);
                // æ¸²æŸ“ç¬”è®°é¡¹
                sortedNotes.forEach(note => {
                    const noteItem = notesContainer.createEl('div', { cls: 'kw-drawer-note' });
                    noteItem.style.marginLeft = '20px';
                    noteItem.createEl('span', { text: 'ğŸ“„' });
                    noteItem.createEl('span', { text: note.name });
                    noteItem.onclick = (e) => {
                        e.stopPropagation();
                        app.workspace.openLinkText(note.path, '');
                    };
                });
            }

            // é€’å½’æ¸²æŸ“å­å†…å®¹
            renderDrawerTree(childContainer, childNode, level + 1, type, expandNotesByDefault);
        } else {
            // === æœ€æ·±å±‚çº§çš„èŠ‚ç‚¹ï¼ˆæ— å­å±‚çº§ï¼‰ï¼šæ˜¾ç¤ºå±‚çº§å + å¯æŠ˜å çš„"ğŸ“ æ ¹ç¬”è®°"æŒ‰é’® ===
            const leafLabel = container.createEl('div', { cls: 'kw-drawer-parent' });
            leafLabel.style.marginLeft = `${level * 20}px`;

            const toggle = leafLabel.createEl('span', { cls: 'kw-drawer-toggle', text: 'â–¼' });
            const label = leafLabel.createEl('span', { cls: 'kw-drawer-label', text: childName });
            const count = leafLabel.createEl('span', { cls: 'kw-drawer-count', text: `(${childNode.notes.length})` });

            // ç¬”è®°å®¹å™¨ï¼ˆé»˜è®¤æŠ˜å ï¼‰
            const notesContainer = leafLabel.createEl('div', { cls: 'kw-drawer-children' });
            notesContainer.style.display = 'none';

            const sortedNotes = [...childNode.notes].sort(compareNoteName);
            // æ¸²æŸ“è¯¥å¶å­èŠ‚ç‚¹çš„ç¬”è®°
            sortedNotes.forEach(note => {
                const noteItem = notesContainer.createEl('div', { cls: 'kw-drawer-note' });
                noteItem.style.marginLeft = '20px';
                noteItem.createEl('span', { text: 'ğŸ“„' });
                noteItem.createEl('span', { text: note.name });
                noteItem.onclick = (e) => {
                    e.stopPropagation();
                    app.workspace.openLinkText(note.path, '');
                };
            });

            // ç‚¹å‡»äº‹ä»¶ï¼šåˆ‡æ¢ç¬”è®°å®¹å™¨æ˜¾ç¤º/éšè—
            let isNotesExpanded = expandNotesByDefault;
            toggle.style.transform = isNotesExpanded ? 'rotate(90deg)' : '';
            leafLabel.onclick = (e) => {
                e.stopPropagation();
                isNotesExpanded = !isNotesExpanded;
                toggle.style.transform = isNotesExpanded ? 'rotate(90deg)' : '';
                notesContainer.style.display = isNotesExpanded ? 'block' : 'none';
            };

            container.appendChild(leafLabel);
        }
    });

    // --- æ¸²æŸ“å½“å‰å±‚çº§çš„ç¬”è®°ï¼ˆç›´å±ï¼‰- ä»…é’ˆå¯¹ Level 0 ---
    // v3.7: Level 0 çš„ç¬”è®°åœ¨æ‰€æœ‰å­å±‚çº§æ¸²æŸ“å®Œåæ˜¾ç¤ºï¼Œå¯æŠ˜å "ğŸ“ æ ¹ç¬”è®°"
    if (node.notes.length > 0 && level === 0) {
        const noteWrapper = container.createEl('div', { cls: 'kw-drawer-parent' });
        noteWrapper.style.marginLeft = `${level * 20}px`;

        const noteToggle = noteWrapper.createEl('span', { cls: 'kw-drawer-toggle', text: 'â–¼' });
        noteWrapper.createEl('span', { cls: 'kw-drawer-label', text: 'ğŸ“ æ ¹ç¬”è®°' });
        noteWrapper.createEl('span', { cls: 'kw-drawer-count', text: `(${node.notes.length})` });

        // ç¬”è®°å®¹å™¨ï¼ˆé»˜è®¤æŠ˜å ï¼‰
        const notesContainer = noteWrapper.createEl('div', { cls: 'kw-drawer-children' });
        notesContainer.style.display = 'none';

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        let isExpanded = expandNotesByDefault;
        noteToggle.style.transform = isExpanded ? 'rotate(90deg)' : '';

        noteWrapper.onclick = (e) => {
            e.stopPropagation();
            isExpanded = !isExpanded;
            noteToggle.style.transform = isExpanded ? 'rotate(90deg)' : '';
            notesContainer.style.display = isExpanded ? 'block' : 'none';
        };

        const sortedNotes = [...node.notes].sort(compareNoteName);
        // æ¸²æŸ“ç¬”è®°é¡¹
        sortedNotes.forEach(note => {
            const noteItem = notesContainer.createEl('div', { cls: 'kw-drawer-note' });
            noteItem.dataset.level = level;
            noteItem.style.marginLeft = '20px';
            noteItem.createEl('span', { text: 'ğŸ“„' });
            noteItem.createEl('span', { text: note.name });
            noteItem.onclick = (e) => {
                e.stopPropagation();
                app.workspace.openLinkText(note.path, '');
            };
        });
    }
}

/**
 * ç»Ÿè®¡èŠ‚ç‚¹çš„æ‰€æœ‰åä»£ç¬”è®°æ•°é‡
 */
function countDescendants(node) {
    let count = node.notes.length;
    node.children.forEach(child => {
        count += countDescendants(child);
    });
    return count;
}

/**
 * æ¸²æŸ“å¤šå±‚çº§æŠ½å±‰ï¼ˆæŒ‰æ¥æºç±»å‹åˆ†ç»„ï¼‰
 * @param {HTMLElement} drawer - æŠ½å±‰å®¹å™¨
 * @param {Array} notes - è¯¥ç±»å‹çš„ç¬”è®°æ•°ç»„
 * @param {string} type - æ¥æºç±»å‹
 * @param {boolean} showGroupHeader - æ˜¯å¦æ˜¾ç¤ºåˆ†ç»„æ ‡é¢˜
 * @param {boolean} expandNotesByDefault - ç¬”è®°é»˜è®¤æ˜¯å¦å±•å¼€ï¼ˆv3.7æ–°å¢ï¼Œé»˜è®¤æŠ˜å ï¼‰
 */
function renderMultiLevelDrawer(drawer, notes, type, showGroupHeader = false, expandNotesByDefault = false) {
    if (notes.length === 0) return;

    // v3.4.1: æ‰€æœ‰ç¬”è®°ç»Ÿä¸€ä½¿ç”¨å¤šå±‚çº§æ¸²æŸ“
    // æ„å»ºå±‚çº§æ ‘
    const tree = buildSuffixTree(notes);

    // v3.7: ä¼ é€’ expandNotesByDefault å‚æ•°ï¼ˆé»˜è®¤æŠ˜å ï¼‰
    renderDrawerTree(drawer, tree, 0, type, expandNotesByDefault);
}

/**
 * æ¸²æŸ“å•ä¸ªå…³é”®è¯èƒ¶å›Šï¼ˆå¥—åœˆå¼ï¼Œé»˜è®¤å±•å¼€ï¼‰
 */
function renderCapsule(container, kw) {
    if (!kw || !kw.type) {
        console.error('æ— æ•ˆçš„å…³é”®è¯å¯¹è±¡:', kw);
        return;
    }

    const children = getChildKeywords(kw.id);
    const hasChildren = children.length > 0;
    // å®‰å…¨æ£€æŸ¥ Set å¯¹è±¡
    const isCollapsed = state.collapsedIds?.has?.(kw.id) ?? false;
    const isNotesOpen = state.notesOpenIds?.has?.(kw.id) ?? false;

    // æ£€æŸ¥æ˜¯å¦æœ‰å¤šç§æ¥æºç±»å‹
    const sourceTypes = getKeywordSourceTypes(kw);
    const isMixedType = sourceTypes.size > 1;

    const capsule = container.createEl('div', {
        cls: `kw-capsule ${hasChildren ? 'has-children' : ''} ${isCollapsed ? 'collapsed' : 'expanded'} ${isNotesOpen ? 'notes-open' : ''}`
    });

    // å¤´éƒ¨ - æ··åˆç±»å‹ä½¿ç”¨ç‰¹æ®Šæ ·å¼
    const headerCls = isMixedType ? 'kw-capsule-header type-mixed' : `kw-capsule-header type-${kw.type}`;
    const header = capsule.createEl('div', { cls: headerCls });

    // å›¾æ ‡ - æ··åˆç±»å‹æ˜¾ç¤ºå¤šä¸ªå›¾æ ‡
    if (isMixedType) {
        const typeOrder = ['yaml', 'plus', 'dot'];
        const icons = typeOrder.filter(t => sourceTypes.has(t)).map(t => COLORS[t].icon);
        header.createEl('span', { cls: 'kw-capsule-icon kw-capsule-icon-mixed', text: icons.join('') });
    } else {
        header.createEl('span', { cls: 'kw-capsule-icon', text: COLORS[kw.type].icon });
    }

    header.createEl('span', { cls: 'kw-capsule-label', text: kw.displayText });

    if (kw.notes.length > 0) {
        header.createEl('span', { cls: 'kw-capsule-badge', text: `${kw.notes.length}` });
    }

    if (hasChildren) {
        header.createEl('span', { cls: 'kw-capsule-expand', text: 'â€º' });
    }

    // ç‚¹å‡»äº‹ä»¶ - æ‰€æœ‰èƒ¶å›Šç»Ÿä¸€è§¦å‘äº¤äº’
    header.onclick = (e) => {
        e.stopPropagation();
        handleCapsuleClick(kw);
    };

    // ç»Ÿä¸€çš„ç‚¹å‡»å¤„ç†å‡½æ•°
    function handleCapsuleClick(keyword) {
        // ç¡®ä¿ Set å¯¹è±¡å­˜åœ¨
        if (!(state.collapsedIds instanceof Set)) state.collapsedIds = new Set();
        if (!(state.notesOpenIds instanceof Set)) state.notesOpenIds = new Set();

        if (keyword.notes.length === 1) {
            // åªæœ‰ä¸€ä¸ªç¬”è®°ï¼Œç›´æ¥æ‰“å¼€
            app.workspace.openLinkText(keyword.notes[0].path, '');
        } else if (keyword.notes.length > 1) {
            // å¤šä¸ªç¬”è®°ï¼Œåˆ‡æ¢ç¬”è®°æŠ½å±‰
            if (state.notesOpenIds.has(keyword.id)) {
                state.notesOpenIds.delete(keyword.id);
            } else {
                state.notesOpenIds.add(keyword.id);
            }
            renderViewFn();
        }
        // æœ‰å­èŠ‚ç‚¹æ—¶ä¸å†æŠ˜å /å±•å¼€ï¼Œå­èŠ‚ç‚¹å§‹ç»ˆå±•å¼€
    }

    // ç¬”è®°æŠ½å±‰ï¼ˆv3.4: å¤šå±‚çº§æŒ‰+å·åˆ†å‰²å±•ç¤ºï¼‰
    // æ”¾åœ¨å­å…³é”®è¯å®¹å™¨ä¹‹å‰ï¼Œç¡®ä¿å±•å¼€åç›´æ¥æ˜¾ç¤ºåœ¨å½“å‰èƒ¶å›Šä¸‹æ–¹
    if (kw.notes.length > 0) {
        const drawer = capsule.createEl('div', {
            cls: 'kw-notes-drawer',
            style: isNotesOpen ? '' : 'display: none;' // é»˜è®¤éšè—ç¬”è®°æŠ½å±‰
        });

        // æŒ‰æ¥æºç±»å‹åˆ†ç»„ç¬”è®°
        const typeOrder = ['yaml', 'plus', 'dot'];
        const typeNames = {
            yaml: 'â—† YAMLå…³é”®è¯ç®¡ç†',
            plus: 'â–² å±‚çº§å…³é”®è¯ ++...++',
            dot: 'â— è¡Œå†…å…³é”®è¯ Â·Â·...Â·Â·'
        };
        const groupedNotes = { yaml: [], plus: [], dot: [] };

        kw.notes.forEach(note => {
            const sourceType = note.sourceType || kw.type; // å…¼å®¹æ—§æ•°æ®
            if (groupedNotes[sourceType]) {
                groupedNotes[sourceType].push(note);
            }
        });

        // æ£€æŸ¥æ˜¯å¦æœ‰å¤šç§æ¥æºç±»å‹
        const activeTypes = typeOrder.filter(t => groupedNotes[t].length > 0);
        const hasMultipleTypes = activeTypes.length > 1;

        // æŒ‰ç±»å‹é¡ºåºæ¸²æŸ“
        typeOrder.forEach(type => {
            const notes = groupedNotes[type];
            if (notes.length === 0) return;

            // å¦‚æœæœ‰å¤šç§ç±»å‹ï¼Œæ˜¾ç¤ºåˆ†ç»„æ ‡é¢˜
            if (hasMultipleTypes) {
                const groupHeader = drawer.createEl('div', { cls: `kw-drawer-group-header type-${type}` });
                groupHeader.createEl('span', { text: COLORS[type].icon });
                groupHeader.createEl('span', { text: typeNames[type] });
                groupHeader.createEl('span', { cls: 'kw-drawer-group-count', text: `${notes.length}` });
            }

            // ä½¿ç”¨å¤šå±‚çº§æ¸²æŸ“å‡½æ•°
            // v3.7: ç¬”è®°é»˜è®¤æŠ˜å ï¼Œç”¨æˆ·ç‚¹å‡»"ğŸ“ æ ¹ç¬”è®°"å±•å¼€
            renderMultiLevelDrawer(drawer, notes, type, false, false);
        });
    }

    // å­å…³é”®è¯å®¹å™¨ï¼ˆå¥—åœˆæ•ˆæœï¼Œé»˜è®¤å±•å¼€ï¼‰
    if (hasChildren) {
        const childrenContainer = capsule.createEl('div', { cls: 'kw-capsule-children' });
        children.forEach(child => {
            renderCapsule(childrenContainer, child);
        });
    }
}

// ============ GTDé£æ ¼ç®¡ç†è§†å›¾ ============

function renderManagerView(container) {
    container.innerHTML = '';
    container.className = 'kw-mgr-container';

    // å¤´éƒ¨
    const header = container.createEl('div', { cls: 'kw-mgr-header' });
    header.createEl('div', { cls: 'kw-mgr-title', text: 'ğŸ·ï¸ å…³é”®è¯ç®¡ç†å™¨' });

    const headerActions = header.createEl('div', { cls: 'kw-mgr-actions' });
    const exitBtn = headerActions.createEl('button', { text: 'è¿”å›å±•ç¤ºè§†å›¾', cls: 'kw-toolbar button secondary' });
    exitBtn.style.cssText = 'padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; background: var(--background-modifier-border); color: var(--text-normal);';
    exitBtn.onclick = () => {
        state.managerMode = false;
        renderViewFn();
    };

    // ç»Ÿè®¡
    const keywords = Object.values(state.keywords);
    const topCount = keywords.filter(k => !k.parentId).length;
    const stats = container.createEl('div', { cls: 'kw-mgr-stats' });
    stats.innerHTML = `
        <div class="kw-mgr-stat-item">ğŸ“Š æ€»è®¡: <span class="kw-mgr-stat-num">${keywords.length}</span> ä¸ªå…³é”®è¯</div>
        <div class="kw-mgr-stat-item">ğŸŒ² é¡¶å±‚: <span class="kw-mgr-stat-num">${topCount}</span></div>
        <div class="kw-mgr-stat-item">ğŸ“„ ç¬”è®°: <span class="kw-mgr-stat-num">${keywords.reduce((s,k)=>s+k.notes.length,0)}</span></div>
    `;

    // ç¼–è¾‘å¼¹çª—
    const closeEditModal = () => {
        const modal = document.getElementById('kw-edit-modal-overlay');
        if (modal) modal.remove();
    };
    closeEditModal();

    const openEditModal = (kwId) => {
        const kw = state.keywords[kwId];
        if (!kw) return;

        closeEditModal();

        const overlay = document.body.createEl('div', {
            cls: 'kw-modal-overlay',
            attr: { id: 'kw-edit-modal-overlay', tabindex: '-1' }
        });
        const modal = overlay.createEl('div', { cls: 'kw-modal kw-edit-modal' });
        modal.addEventListener('click', (e) => e.stopPropagation());
        overlay.addEventListener('click', closeEditModal);
        overlay.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                closeEditModal();
            }
        });

        const header = modal.createEl('div', { cls: 'kw-modal-header' });
        header.createEl('span', { text: `âœï¸ ç¼–è¾‘å…³é”®è¯: ${kw.displayText}` });
        const closeBtn = header.createEl('button', { text: 'Ã—', cls: 'kw-edit-modal-close' });
        closeBtn.onclick = closeEditModal;

        const body = modal.createEl('div', { cls: 'kw-edit-modal-body' });
        body.createEl('div', { cls: 'kw-edit-modal-tip', text: 'æ”¯æŒä¿®æ”¹åç§°ä¸çˆ¶çº§ï¼Œä¿å­˜åä¼šè‡ªåŠ¨åˆ·æ–°è§†å›¾ã€‚' });

        // æ˜¾ç¤ºåç§°
        const labelRow = body.createEl('div', { cls: 'kw-form-row' });
        labelRow.createEl('span', { text: 'åç§°:', cls: 'kw-form-label' });
        const labelInput = labelRow.createEl('input', { type: 'text', cls: 'kw-form-input', value: kw.baseKeyword });

        // çˆ¶çº§é€‰æ‹©ï¼ˆå¸¦æœç´¢ç­›é€‰ï¼‰
        const parentRow = body.createEl('div', { cls: 'kw-form-row' });
        parentRow.createEl('span', { text: 'çˆ¶çº§:', cls: 'kw-form-label' });

        // æ„å»ºå¯é€‰çˆ¶çº§åˆ—è¡¨
        const descendantIds = new Set(getDescendantIds(kwId));
        const availableParents = Object.values(state.keywords)
            .filter(k => k.id !== kwId && !descendantIds.has(k.id))
            .sort((a, b) => a.displayText.localeCompare(b.displayText, 'zh-CN'));

        // åˆ›å»ºè‡ªå®šä¹‰é€‰æ‹©å™¨å®¹å™¨
        const selectorContainer = parentRow.createEl('div', { cls: 'kw-parent-selector' });

        // è¾“å…¥æ¡†åŒ…è£…å™¨
        const inputWrapper = selectorContainer.createEl('div', { cls: 'kw-parent-input-wrapper' });
        const parentInput = inputWrapper.createEl('input', {
            type: 'text',
            cls: 'kw-parent-input',
            attr: { placeholder: 'è¾“å…¥å…³é”®è¯æœç´¢...' }
        });
        const clearBtn = inputWrapper.createEl('span', { cls: 'kw-parent-clear', text: 'Ã—' });

        // ä¸‹æ‹‰åˆ—è¡¨
        const dropdown = selectorContainer.createEl('div', { cls: 'kw-parent-dropdown' });

        // é€‰ä¸­çš„çˆ¶çº§IDï¼ˆç”¨äºä¿å­˜ï¼‰
        let selectedParentId = kw.parentId || null;
        let highlightedIndex = -1;

        // åˆå§‹åŒ–æ˜¾ç¤º
        if (selectedParentId) {
            const selectedKw = state.keywords[selectedParentId];
            if (selectedKw) {
                parentInput.value = selectedKw.displayText;
            }
        }

        // é«˜äº®åŒ¹é…æ–‡æœ¬çš„å‡½æ•°
        function highlightMatch(text, query) {
            if (!query) return text;
            const lowerText = text.toLowerCase();
            const lowerQuery = query.toLowerCase();
            const index = lowerText.indexOf(lowerQuery);
            if (index === -1) return text;
            return text.substring(0, index) +
                   '<span class="kw-parent-option-match">' +
                   text.substring(index, index + query.length) +
                   '</span>' +
                   text.substring(index + query.length);
        }

        // æ¸²æŸ“ä¸‹æ‹‰é€‰é¡¹
        function renderOptions(query = '') {
            dropdown.innerHTML = '';
            const lowerQuery = query.toLowerCase().trim();

            // ç­›é€‰åŒ¹é…çš„é€‰é¡¹
            const filtered = availableParents.filter(k => {
                if (!lowerQuery) return true;
                return k.displayText.toLowerCase().includes(lowerQuery) ||
                       k.baseKeyword.toLowerCase().includes(lowerQuery);
            });

            // é¡¶å±‚é€‰é¡¹ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
            const topOption = dropdown.createEl('div', {
                cls: `kw-parent-option ${!selectedParentId ? 'selected' : ''}`,
                attr: { 'data-value': '' }
            });
            topOption.innerHTML = `<span class="kw-parent-option-icon">ğŸ </span><span class="kw-parent-option-text">-- é¡¶å±‚å…³é”®è¯ --</span>`;
            topOption.onclick = () => selectOption('', '-- é¡¶å±‚å…³é”®è¯ --');

            if (filtered.length === 0 && lowerQuery) {
                dropdown.createEl('div', { cls: 'kw-parent-no-results', text: `æœªæ‰¾åˆ°åŒ¹é… "${query}" çš„å…³é”®è¯` });
            } else {
                filtered.forEach((k, idx) => {
                    const option = dropdown.createEl('div', {
                        cls: `kw-parent-option ${selectedParentId === k.id ? 'selected' : ''} ${idx === highlightedIndex ? 'highlighted' : ''}`,
                        attr: { 'data-value': k.id }
                    });
                    const highlightedText = highlightMatch(k.displayText, query);
                    option.innerHTML = `<span class="kw-parent-option-icon">${COLORS[k.type].icon}</span><span class="kw-parent-option-text">${highlightedText}</span>`;
                    option.onclick = () => selectOption(k.id, k.displayText);
                });
            }

            // ç»Ÿè®¡ä¿¡æ¯
            const statsText = lowerQuery
                ? `æ˜¾ç¤º ${filtered.length} / ${availableParents.length} ä¸ªå¯é€‰çˆ¶çº§`
                : `å…± ${availableParents.length} ä¸ªå¯é€‰çˆ¶çº§`;
            dropdown.createEl('div', { cls: 'kw-parent-stats', text: statsText });

            highlightedIndex = -1;
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(id, displayText) {
            selectedParentId = id || null;
            parentInput.value = id ? displayText : '';
            dropdown.classList.remove('visible');
            parentInput.blur();
        }

        // æ˜¾ç¤º/éšè—ä¸‹æ‹‰
        function showDropdown() {
            renderOptions(parentInput.value);
            dropdown.classList.add('visible');
        }

        function hideDropdown() {
            setTimeout(() => dropdown.classList.remove('visible'), 150);
        }

        // äº‹ä»¶ç»‘å®š
        parentInput.addEventListener('focus', showDropdown);
        parentInput.addEventListener('blur', hideDropdown);
        parentInput.addEventListener('input', () => {
            renderOptions(parentInput.value);
            dropdown.classList.add('visible');
        });

        // é”®ç›˜å¯¼èˆª
        parentInput.addEventListener('keydown', (e) => {
            const options = dropdown.querySelectorAll('.kw-parent-option');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
                options.forEach((opt, i) => opt.classList.toggle('highlighted', i === highlightedIndex));
                if (options[highlightedIndex]) options[highlightedIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightedIndex = Math.max(highlightedIndex - 1, 0);
                options.forEach((opt, i) => opt.classList.toggle('highlighted', i === highlightedIndex));
                if (options[highlightedIndex]) options[highlightedIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (highlightedIndex >= 0 && options[highlightedIndex]) {
                    options[highlightedIndex].click();
                }
            } else if (e.key === 'Escape') {
                e.stopPropagation();
                hideDropdown();
                parentInput.blur();
            }
        });

        // æ¸…é™¤æŒ‰é’®
        clearBtn.onclick = (e) => {
            e.stopPropagation();
            selectedParentId = null;
            parentInput.value = '';
            parentInput.focus();
        };

        // ç”¨äºä¿å­˜æ—¶è·å–é€‰ä¸­çš„çˆ¶çº§ID
        const getSelectedParentId = () => selectedParentId;

        // æŒ‰é’®
        const btnRow = body.createEl('div', { cls: 'kw-edit-modal-actions' });

        const cancelBtn = btnRow.createEl('button', { text: 'å–æ¶ˆ' });
        cancelBtn.style.cssText = 'padding:6px 14px; border-radius:4px; border:1px solid var(--background-modifier-border); background:var(--background-secondary); cursor:pointer;';
        cancelBtn.onclick = closeEditModal;

        const saveBtn = btnRow.createEl('button', { text: 'ä¿å­˜' });
        saveBtn.style.cssText = 'padding:6px 14px; border-radius:4px; border:none; background:var(--interactive-accent); color:var(--text-on-accent); cursor:pointer;';
        saveBtn.onclick = async () => {
            const newLabel = labelInput.value.trim();
            if (!newLabel) { new Notice('âš ï¸ åç§°ä¸èƒ½ä¸ºç©º'); return; }

            const oldKeyword = kw.baseKeyword;
            const keywordChanged = oldKeyword !== newLabel;
            const oldId = kw.id;
            const newId = generateKeywordId(newLabel);
            if (newId !== oldId && state.keywords[newId]) {
                new Notice('âš ï¸ è¯¥åç§°å·²å­˜åœ¨');
                return;
            }

            // å¦‚æœå…³é”®è¯åç§°æ”¹å˜ï¼Œæ‰§è¡Œåå‘åŒæ­¥
            if (keywordChanged && kw.notes.length > 0) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'åŒæ­¥ä¸­...';

                const result = await syncKeywordToNotes(oldKeyword, newLabel, kw.notes, kw.type);

                if (result.updated > 0) {
                    new Notice(`ğŸ“ å·²æ›´æ–° ${result.updated} ä¸ªç¬”è®°æ–‡ä»¶`);
                }
                if (result.failed > 0) {
                    new Notice(`âš ï¸ ${result.failed} ä¸ªæ–‡ä»¶æ›´æ–°å¤±è´¥`);
                }
            }

            // æ›´æ–°ç´¢å¼•ä¸­çš„å…³é”®è¯ä¿¡æ¯
            kw.baseKeyword = newLabel;
            kw.displayText = getDisplayText(newLabel);
            kw.sortLetter = getSortLetter(newLabel);
            const selectedParentId = getSelectedParentId();
            kw.parentId = selectedParentId === oldId ? null : selectedParentId;

            // æ›´æ–°notesä¸­çš„è·¯å¾„ä¿¡æ¯ï¼ˆå¦‚æœæ–‡ä»¶åæ”¹å˜äº†ï¼‰
            if (keywordChanged && (kw.type === 'plus' || kw.type === 'dot')) {
                const delimiter = kw.type === 'plus' ? '++' : 'Â·Â·';
                kw.notes = kw.notes.map(note => {
                    const oldFull = note.suffix ? oldKeyword + note.suffix : oldKeyword;
                    const newFull = note.suffix ? newLabel + note.suffix : newLabel;
                    const oldPattern = `${delimiter}${oldFull}${delimiter}`;
                    const newPattern = `${delimiter}${newFull}${delimiter}`;

                    if (note.name.includes(oldPattern)) {
                        const newName = note.name.replace(oldPattern, newPattern);
                        const newPath = note.path.replace(note.name, newName);
                        return { ...note, name: newName, path: newPath };
                    }
                    return note;
                });
            }

            if (newId !== oldId) {
                Object.values(state.keywords).forEach(child => {
                    if (child.parentId === oldId) child.parentId = newId;
                });
                delete state.keywords[oldId];
                kw.id = newId;
                state.keywords[newId] = kw;
            }

            await saveIndex();
            new Notice('âœ… å·²ä¿å­˜');
            closeEditModal();
            renderViewFn();
        };

        labelInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveBtn.click();
            }
        });

        setTimeout(() => {
            labelInput.focus();
            labelInput.select();
        }, 0);
    };

    // é¡¶å±‚æ‹–æ”¾åŒº
    const treeContainer = container.createEl('div');
    const topDropZone = treeContainer.createEl('div', { cls: 'kw-mgr-drop-zone' });

    topDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        topDropZone.classList.add('active');
    });
    topDropZone.addEventListener('dragleave', () => {
        topDropZone.classList.remove('active');
    });
    topDropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        topDropZone.classList.remove('active');
        const draggedId = state.dragId;
        if (draggedId && state.keywords[draggedId]) {
            state.keywords[draggedId].parentId = null;
            await saveIndex();
            new Notice('âœ… å·²ç§»åŠ¨åˆ°é¡¶å±‚');
            renderViewFn();
        }
    });

    // æŒ‰å­—æ¯åˆ†ç»„æ¸²æŸ“
    const groups = {};
    keywords.forEach(kw => {
        if (!kw.parentId) {
            const letter = kw.sortLetter || '#';
            if (!groups[letter]) groups[letter] = [];
            groups[letter].push(kw);
        }
    });

    Object.keys(groups).sort().forEach(letter => {
        const groupHeader = treeContainer.createEl('div', {
            text: letter,
            attr: { style: 'font-weight:600; color:var(--text-muted); margin:16px 0 8px; padding-bottom:4px; border-bottom:1px solid var(--background-modifier-border);' }
        });

        groups[letter].sort(compareKeywordName).forEach(kw => {
            renderManagerItem(treeContainer, kw, openEditModal);
        });
    });
}

/**
 * æ¸²æŸ“ç®¡ç†ç•Œé¢çš„å…³é”®è¯é¡¹
 */
function renderManagerItem(container, kw, onEdit, level = 0) {
    const children = getChildKeywords(kw.id);

    const item = container.createEl('div', {
        cls: 'kw-mgr-item',
        attr: { draggable: 'true', 'data-kw-id': kw.id }
    });
    if (level > 0) {
        item.style.marginLeft = `${level * 30}px`;
    }

    // æ‹–æ‹½äº‹ä»¶
    item.addEventListener('dragstart', (e) => {
        state.dragId = kw.id;
        item.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => {
        state.dragId = null;
        item.classList.remove('dragging');
    });
    item.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (state.dragId && state.dragId !== kw.id) {
            item.classList.add('drag-over');
        }
    });
    item.addEventListener('dragleave', () => {
        item.classList.remove('drag-over');
    });
    item.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        item.classList.remove('drag-over');
        const draggedId = state.dragId;
        if (draggedId && draggedId !== kw.id && state.keywords[draggedId]) {
            // æ£€æŸ¥å¾ªç¯å¼•ç”¨
            const descendants = getDescendantIds(draggedId);
            if (descendants.includes(kw.id)) {
                new Notice('âš ï¸ ä¸èƒ½å°†çˆ¶çº§æ‹–å…¥å…¶å­çº§');
                return;
            }
            state.keywords[draggedId].parentId = kw.id;
            await saveIndex();
            new Notice(`âœ… å·²ç§»åŠ¨åˆ° "${kw.displayText}" ä¸‹`);
            renderViewFn();
        }
    });

    // é¢œè‰²ç‚¹
    const colorDot = item.createEl('div', { cls: 'kw-mgr-item-color' });
    colorDot.style.backgroundColor = COLORS[kw.type].text;

    // å›¾æ ‡
    item.createEl('div', { cls: 'kw-mgr-item-icon', text: COLORS[kw.type].icon });

    // ä¿¡æ¯
    const info = item.createEl('div', { cls: 'kw-mgr-item-info' });
    info.createEl('div', { cls: 'kw-mgr-item-label', text: kw.displayText });
    info.createEl('div', { cls: 'kw-mgr-item-meta', text: `${kw.notes.length} ç¯‡ç¬”è®° | ${children.length} ä¸ªå­å…³é”®è¯` });

    // æ“ä½œæŒ‰é’®
    const actions = item.createEl('div', { cls: 'kw-mgr-item-actions' });

    const editBtn = actions.createEl('button', { text: 'âœï¸', cls: 'kw-mgr-item-btn', attr: { title: 'ç¼–è¾‘' } });
    editBtn.onclick = (e) => {
        e.stopPropagation();
        onEdit(kw.id);
    };

    // é€’å½’æ¸²æŸ“å­å…³é”®è¯
    if (children.length > 0) {
        const childContainer = container.createEl('div', { cls: 'kw-mgr-children' });
        children.forEach(child => {
            renderManagerItem(childContainer, child, onEdit, level + 1);
        });
    }
}

// ============ ä¸»æ¸²æŸ“å‡½æ•° ============

function render(container) {
    if (state.managerMode) {
        renderManagerView(container);
    } else {
        renderDisplayView(container);
    }
}

// ============ ä¸»å…¥å£ ============

const data = await loadIndex();

if (Object.keys(data).length === 0) {
    dv.paragraph('é¦–æ¬¡è¿è¡Œï¼Œæ­£åœ¨æ‰«æå…³é”®è¯...');
    await fullScan();
}

renderViewFn = () => render(dv.container);
render(dv.container);

})();
```

---
# å…³é”®è¯ç´¢å¼•ç®¡ç†ç³»ç»Ÿè¯´æ˜

å°†ä»¥ä¸‹ä»£ç å—å¤åˆ¶åˆ°Obsidianç¬”è®°ä¸­å³å¯ä½¿ç”¨ã€‚

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **å…³é”®è¯æå–**ï¼š
   - YAMLå­—æ®µï¼š`å…³é”®è¯ç®¡ç†`ï¼ˆä¸­æ–‡ï¼‰
   - æ–‡ä»¶å`++å…³é”®è¯++`å’Œ`Â·Â·å…³é”®è¯Â·Â·`
   - `+`å·æ˜¯**åç¼€æ³¨è§£**ï¼Œç”¨äºæŠ½å±‰å†…ç¬”è®°çš„å¤šå±‚çº§å±•ç¤º

2. **å±‚çº§å…³ç³»**ï¼š
   - å…³é”®è¯ä¹‹é—´çš„å±‚çº§é€šè¿‡`parentId`å®ç°ï¼ˆå¥—åœˆå¼å±•ç¤ºï¼‰
   - å•ä¸ªå…³é”®è¯çš„ç¬”è®°æŠ½å±‰å†…ï¼Œæ”¯æŒæŒ‰`+`å·åˆ†å‰²æ˜¾ç¤ºå¤šå±‚çº§ç»“æ„

3. **v3.4æ–°å¢ï¼šå¤šå±‚çº§æŠ½å±‰**
   - ç‚¹å‡»èƒ¶å›Šå±•å¼€æŠ½å±‰åï¼Œç¬”è®°æŒ‰`suffix`ä¸­çš„`+`å·åˆ†å‰²æˆå±‚çº§ç»“æ„
   - ä¾‹å¦‚ï¼š`å…³é”®è¯ç®¡ç†+è‡ªå·±åšçš„è°ƒæŸ¥+æ¥ä¸¥ç»åˆ†æ` ä¼šæ˜¾ç¤ºä¸ºåµŒå¥—çš„ä¸‰å±‚ç»“æ„
   - æ”¯æŒæŠ˜å /å±•å¼€äº¤äº’ï¼Œæ¯å±‚æ˜¾ç¤ºç¬”è®°æ•°é‡ç»Ÿè®¡

4. **v3.7ä¼˜åŒ–ï¼šå¯æŠ˜å æ ¹ç¬”è®°**
   - é»˜è®¤åªæ˜¾ç¤ºå±‚çº§å
   - å¦‚æœå±‚çº§æœ‰ç›´å±ç¬”è®°ï¼Œæ˜¾ç¤ºå¯æŠ˜å çš„"ğŸ“ æ ¹ç¬”è®°"æŒ‰é’®
   - ç‚¹å‡»æŒ‰é’®å±•å¼€/æŠ˜å æŸ¥çœ‹è¯¥å±‚çº§çš„ç¬”è®°
   - ä¿æŒå±‚çº§ç»“æ„çš„æ¸…æ™°å’Œç®€æ´

5. **åå‘åŒæ­¥**ï¼ˆv3.1æ–°å¢ï¼‰ï¼š
   - åœ¨ç®¡ç†ç•Œé¢é‡å‘½åå…³é”®è¯æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°åŸå§‹ç¬”è®°æ–‡ä»¶
   - æ”¯æŒYAMLã€++...++ã€Â·Â·...Â·Â·ä¸‰ç§æ ¼å¼çš„åå‘æ›´æ–°

6. **çˆ¶çº§æœç´¢ç­›é€‰**ï¼ˆv3.2æ–°å¢ï¼‰ï¼š
   - ç¼–è¾‘å…³é”®è¯æ—¶ï¼Œçˆ¶çº§é€‰æ‹©æ”¯æŒè¾“å…¥æœç´¢ç­›é€‰
   - æ”¯æŒé”®ç›˜ä¸Šä¸‹é”®å¯¼èˆªå’ŒEnteré€‰æ‹©
   - å®æ—¶é«˜äº®åŒ¹é…æ–‡æœ¬ï¼Œæ˜¾ç¤ºç­›é€‰ç»Ÿè®¡

7. **æ··åˆæ¥æºç±»å‹æ”¯æŒ**ï¼ˆv3.3æ–°å¢ï¼‰ï¼š
   - åŒä¸€å…³é”®è¯å¯é€šè¿‡ä¸åŒæ–¹å¼ï¼ˆYAMLã€++...++ã€Â·Â·...Â·Â·ï¼‰å‡ºç°åœ¨ä¸åŒç¬”è®°ä¸­
   - æ¯ä¸ªç¬”è®°è®°å½•å…¶å®é™…æ¥æºç±»å‹ï¼ˆsourceTypeå­—æ®µï¼‰
   - æ··åˆç±»å‹å…³é”®è¯æ˜¾ç¤ºæ¸å˜èƒŒæ™¯å’Œå¤šå›¾æ ‡ï¼ˆå¦‚ â—†â–²â—ï¼‰
   - ç¬”è®°æŠ½å±‰æŒ‰æ¥æºç±»å‹åˆ†ç»„æ˜¾ç¤ºï¼Œå¸¦å½©è‰²åˆ†ç»„æ ‡é¢˜

---
## ä½¿ç”¨è¯´æ˜

### 1. éƒ¨ç½²

1. åœ¨Obsidianä¸­åˆ›å»ºä¸€ä¸ªæ–°ç¬”è®°
2. å°†ä¸Šé¢çš„ä»£ç å—å®Œæ•´å¤åˆ¶è¿›å»
3. åˆ‡æ¢åˆ°é˜…è¯»æ¨¡å¼å³å¯çœ‹åˆ°å…³é”®è¯ç´¢å¼•

### 2. ä¸‰ç§å…³é”®è¯ç±»å‹

| ç±»å‹ | æ ¼å¼ | é¢œè‰² | è¯´æ˜ |
|------|------|------|------|
| â—† YAMLç®¡ç† | `å…³é”®è¯ç®¡ç†:` å­—æ®µ | è“è‰² | yaml frontmatterä¸­å®šä¹‰ |
| â–² å±‚çº§å…³é”®è¯ | `++å…³é”®è¯++` | æ©™è‰² | æ–‡ä»¶åä¸­ç”¨åŒåŠ å·åŒ…è£¹ |
| â— è¡Œå†…å…³é”®è¯ | `Â·Â·å…³é”®è¯Â·Â·` | ç´«è‰² | æ–‡ä»¶åä¸­ç”¨åŒç‚¹å·åŒ…è£¹ |

### 3. å…³é”®è¯æå–è§„åˆ™

**é‡è¦**ï¼šæ–‡ä»¶åä¸­çš„`+`å·æ˜¯**åç¼€æ³¨è§£**ï¼Œä¸æ˜¯å±‚çº§åˆ†éš”ç¬¦ï¼

ç¤ºä¾‹ï¼š
- æ–‡ä»¶å `Â·Â·MMKV-Aä¸Šé¡¹+æ–°å¼€å§‹Â·Â·`
  - åŸºç¡€å…³é”®è¯ï¼š`MMKV-Aä¸Šé¡¹`
  - åç¼€ï¼š`+æ–°å¼€å§‹`
- æ–‡ä»¶å `Â·Â·MMKV-Aä¸Šé¡¹+èµ°ä¸Šé¡¹æµç¨‹çš„ï¼Œææ–™Â·Â·`
  - åŸºç¡€å…³é”®è¯ï¼š`MMKV-Aä¸Šé¡¹`ï¼ˆä¸ä¸Šé¢ç›¸åŒï¼‰
  - åç¼€ï¼š`+èµ°ä¸Šé¡¹æµç¨‹çš„ï¼Œææ–™`

è¿™ä¸¤ä¸ªæ–‡ä»¶éƒ½ä¼šè¢«å½’å…¥åŒä¸€ä¸ª`MMKV-Aä¸Šé¡¹`èƒ¶å›Šä¸­ï¼Œæ‰“å¼€æŠ½å±‰å¯ä»¥çœ‹åˆ°å„è‡ªçš„åç¼€ã€‚

### 4. å…³é”®è¯å±‚çº§å…³ç³»

å±‚çº§å…³ç³»æ˜¯**å…³é”®è¯ä¹‹é—´**çš„å±‚çº§ï¼Œä¸æ–‡ä»¶åä¸­çš„`+`å·æ— å…³ã€‚

ç”¨æˆ·å¯ä»¥é€šè¿‡ï¼š
1. ç‚¹å‡»"âš™ï¸ ç®¡ç†å…³é”®è¯"è¿›å…¥ç®¡ç†ç•Œé¢
2. æ‹–æ‹½å…³é”®è¯åˆ°å…¶ä»–å…³é”®è¯ä¸Šï¼Œå»ºç«‹çˆ¶å­å…³ç³»
3. æ‹–æ‹½åˆ°é¡¶éƒ¨åŒºåŸŸï¼Œä½¿å…¶æˆä¸ºé¡¶å±‚å…³é”®è¯
4. ç‚¹å‡»ç¼–è¾‘æŒ‰é’®ä¿®æ”¹åç§°æˆ–é€‰æ‹©çˆ¶çº§

### 5. ä¸¤ç§è§†å›¾

- **å±•ç¤ºè§†å›¾**ï¼ˆé»˜è®¤ï¼‰ï¼šå¥—åœˆå¼UIï¼Œé«˜å±‚çº§å…³é”®è¯åŒ…å«ä½å±‚çº§
- **ç®¡ç†è§†å›¾**ï¼šGTDé£æ ¼çš„æ‹–æ‹½ç•Œé¢ï¼Œå¯è°ƒæ•´å±‚çº§å’Œé‡å‘½å

### 6. æ•°æ®æ–‡ä»¶

ç´¢å¼•æ•°æ®ä¿å­˜åœ¨ `data/keyword_index.json`

### 7. v3.7åŠŸèƒ½ï¼šå¤šå±‚çº§æŠ½å±‰ï¼ˆå¯æŠ˜å æ ¹ç¬”è®°ï¼‰

ç‚¹å‡»èƒ¶å›Šå±•å¼€ç¬”è®°æŠ½å±‰æ—¶ï¼Œç¬”è®°ä¼šæŒ‰`+`å·åˆ†å‰²æ˜¾ç¤ºå¤šå±‚çº§ç»“æ„ï¼š

**ç¤ºä¾‹æ•ˆæœ**ï¼š
```
å…³é”®è¯ç®¡ç† æŠ½å±‰ï¼š
â”œâ”€â”€ è‡ªå·±åšçš„è°ƒæŸ¥
â”‚   â””â”€â”€ ğŸ“ æ ¹ç¬”è®° (ç‚¹å‡»å±•å¼€)
â”‚       â””â”€â”€ å­¦ä¹ è®¡åˆ’.md
â”œâ”€â”€ æ¥ä¸¥ç»åˆ†æ
â”‚   â””â”€â”€ ğŸ“ æ ¹ç¬”è®° (ç‚¹å‡»å±•å¼€)
â”‚       â””â”€â”€ ã€Šæ¥ä¸¥ç»ã€‹å­¦ä¹ ç¬”è®°.md
â”œâ”€â”€ è°ƒæŸ¥é—®å·è®¾è®¡.mdï¼ˆæ— +åç¼€ï¼Œç›´æ¥æ˜¾ç¤ºï¼‰
â”œâ”€â”€ å¦ä¸€ä¸ªé¡¹ç›®
â”‚   â””â”€â”€ ğŸ“ æ ¹ç¬”è®° (ç‚¹å‡»å±•å¼€)
â”‚       â””â”€â”€ é¡¹ç›®è®¡åˆ’.md
â””â”€â”€ åŸºç¡€ç¬”è®°.mdï¼ˆæ— +åç¼€ï¼‰
```

**v3.7äº¤äº’æ–¹å¼**ï¼š
- é»˜è®¤åªæ˜¾ç¤ºå±‚çº§åï¼Œç¬”è®°é»˜è®¤æŠ˜å 
- å¦‚æœå±‚çº§æœ‰ç›´å±ç¬”è®°ï¼Œä¼šæ˜¾ç¤ºå¯æŠ˜å çš„"ğŸ“ æ ¹ç¬”è®°"æŒ‰é’®
- ç‚¹å‡»"ğŸ“ æ ¹ç¬”è®°"æŒ‰é’®å¯å±•å¼€/æŠ˜å æŸ¥çœ‹è¯¥å±‚çº§çš„ç¬”è®°
- ç‚¹å‡»å±‚çº§æ ‡ç­¾ï¼ˆâ–¶ è‡ªå·±åšçš„è°ƒæŸ¥ï¼‰å¯æŠ˜å /å±•å¼€å­å±‚çº§
- æ¯å±‚æ˜¾ç¤ºè¯¥å±‚çº§åŠæ‰€æœ‰åä»£ä¸­çš„ç¬”è®°æ•°é‡
- ç›´æ¥ç‚¹å‡»ç¬”è®°åç§°å¯æ‰“å¼€ç¬”è®°

**å±‚çº§è§„åˆ™**ï¼š
- `+`å·åˆ†å‰²çš„æ¯ä¸€çº§ä½œä¸ºä¸€ä¸ªå±‚çº§èŠ‚ç‚¹
- æ— åç¼€çš„ç¬”è®°æ”¾åœ¨æ ¹èŠ‚ç‚¹ï¼ˆç›´å±å…³é”®è¯ï¼‰ï¼Œæ˜¾ç¤ºä¸º"ğŸ“ æ ¹ç¬”è®°"
- ç›¸åŒåç¼€è·¯å¾„çš„ç¬”è®°å½’å…¥åŒä¸€åˆ†æ”¯
