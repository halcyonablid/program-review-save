
```dataviewjs


// è·å–å½“å‰ç¬”è®°çš„å…ƒæ•°æ®ï¼Œç”¨äºå­˜å‚¨è®°å½•

let thisFile;
try {
  thisFile = dv.current();
} catch (e) {
  console.error("æ— æ³•è·å–å½“å‰ç¬”è®°å…ƒæ•°æ®:", e);
}

// æ³¨æ„ï¼šä¸å†åˆå¹¶ç°æœ‰è®°å½•ï¼Œæ¯æ¬¡éƒ½æ˜¯å…¨æ–°è®°å½•
let timeEntries = [];


// ä¿å­˜çŠ¶æ€å®šæ—¶å™¨ï¼ˆé˜²æŠ–ï¼‰
let saveDebounceTimer = null;

// ä¿å­˜çŠ¶æ€æ ‡å¿—
window.timePlannerIsSaving = window.timePlannerIsSaving || false;

// å­˜å‚¨æ—¶é—´é˜¶æ®µè§„åˆ’æ•°æ®
let currentPhase = null;

// å­˜å‚¨UIçŠ¶æ€çš„å¤‡ä»½ï¼Œç”¨äºåœ¨æ“ä½œåæ¢å¤
let lastUIState = {
  phase: 'initial',
  timestamp: Date.now()
};

// NEW AND IMPROVED getTargetFile function
async function getTargetFile() {
  if (!app || !app.vault) {
    throw new Error("æ— æ³•è®¿é—®Obsidian API");
  }

  // 1. ä¼˜å…ˆä½¿ç”¨ thisFile.file (dataviewjs æ‰€åœ¨çš„æ–‡ä»¶)
  if (thisFile && thisFile.file && thisFile.file.path) {
    const fileFromDV = app.vault.getAbstractFileByPath(thisFile.file.path);
    if (fileFromDV) {
      console.log("Target file located via Dataview API:", fileFromDV.path);
      return fileFromDV;
    }
  }

  // 2. å¤‡ç”¨æ–¹æ¡ˆ: ä½¿ç”¨ä½ æä¾›çš„ã€å¸¦ .md åç¼€çš„å›ºå®šè·¯å¾„
  const fixedPath = 'é¡¹ç›®/18-æˆ˜ç•¥è§†å›¾è¿­ä»£/18E-GTDå¤¹å­/18E1-ä¸‹ä¸€æ­¥ä»£åŠäº‹é¡¹æ¸…å•æ–‡ä»¶å¤¹/ä¸‹ä¸€æ­¥ä»£åŠçš„liner chain/supermemoplanåšè®¡åˆ’ï¼Œå¸¦è‡ªåŠ¨ä¿å­˜ç‰ˆ.md';
  const fileFromFixedPath = app.vault.getAbstractFileByPath(fixedPath);
  if (fileFromFixedPath) {
    console.log("Target file located via fixed path:", fileFromFixedPath.path);
    return fileFromFixedPath;
  }
  
  // 3. å¦‚æœéƒ½å¤±è´¥ï¼ŒæŠ›å‡ºæ˜ç¡®é”™è¯¯ï¼Œè€Œä¸æ˜¯é”™è¯¯åœ°ä½¿ç”¨æ´»åŠ¨æ–‡ä»¶
  throw new Error(`æ— æ³•å®šä½è®¡åˆ’è„šæœ¬æ‰€åœ¨çš„ç›®æ ‡æ–‡ä»¶ã€‚è¯·æ£€æŸ¥å›ºå®šè·¯å¾„æ˜¯å¦æ­£ç¡®: "${fixedPath}"`);
}


// è·å–å½“å‰æ–‡ä»¶è·¯å¾„çš„å®‰å…¨å‡½æ•°
function getCurrentFilePath() {
  // é¦–é€‰ä»dv.current()è·å–
  if (thisFile && thisFile.file && thisFile.file.path) {
    return thisFile.file.path;
  }
  
  // å¤‡ç”¨æ–¹æ¡ˆï¼šä»app.workspaceè·å–
  try {
    if (app && app.workspace) {
      const activeFile = app.workspace.getActiveFile();
      if (activeFile && activeFile.path) {
        return activeFile.path;
      }
    }
  } catch (e) {
    console.error("è·å–å½“å‰æ–‡ä»¶è·¯å¾„å¤±è´¥:", e);
  }
  
  // æœ€åå¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å›ºå®šå­—ç¬¦ä¸²ä½œä¸ºé”®
  return "obsidian-time-planner-backup";
}

// ä¿å­˜UIçŠ¶æ€
function saveUIState() {
  if (!currentPhase) {
    lastUIState = { phase: 'initial', timestamp: Date.now() };
    return;
  }
  
  if (currentPhase.status === 'planning') {
    lastUIState = { phase: 'planning', timestamp: Date.now() };
  } else if (currentPhase.status === 'active') {
    lastUIState = { phase: 'active', timestamp: Date.now() };
  } else {
    lastUIState = { phase: 'initial', timestamp: Date.now() };
  }
}

// æ¢å¤UIçŠ¶æ€
function restoreUIState() {
  if (!currentPhase) {
    phaseFormEl.style.display = "block";
    activitiesFormEl.style.display = "none";
    executionPanelEl.style.display = "none";
    reviewFormEl.style.display = "none";
    return;
  }
  
  switch (lastUIState.phase) {
    case 'planning':
      phaseFormEl.style.display = "none";
      activitiesFormEl.style.display = "block";
      executionPanelEl.style.display = "none";
      reviewFormEl.style.display = "none";
      renderActivitiesList();
      updateAllocationSummary();
      break;
    case 'active':
      phaseFormEl.style.display = "none";
      activitiesFormEl.style.display = "none";
      executionPanelEl.style.display = "block";
      reviewFormEl.style.display = "none";
      ensureExecutionTicker();
      calculateExpectedTimes();
      renderExecutionList();
      updateExecutionDisplay();
      break;
    default:
      phaseFormEl.style.display = "block";
      activitiesFormEl.style.display = "none";
      executionPanelEl.style.display = "none";
      reviewFormEl.style.display = "none";
  }
}

function processActivityPlanData(activityPlanData) {
  try {
    // 1) åŸºæœ¬æ ¡éªŒ
    if (!activityPlanData) {
      throw new Error("æ´»åŠ¨è®¡åˆ’æ•°æ®ä¸ºç©º");
    }
    if (!Array.isArray(activityPlanData)) {
      throw new Error("æ´»åŠ¨è®¡åˆ’æ•°æ®ä¸æ˜¯æ•°ç»„");
    }
    if (activityPlanData.length === 0) {
      throw new Error("æ´»åŠ¨è®¡åˆ’æ•°æ®æ•°ç»„ä¸ºç©º");
    }

    // 2) æ‰¾åˆ°è®¡åˆ’å¼€å§‹è®°å½•
    const startEntry = activityPlanData.find(entry => entry.status === "å¼€å§‹");
    if (!startEntry) {
      throw new Error("æ‰¾ä¸åˆ°è®¡åˆ’å¼€å§‹è®°å½•");
    }

    // 3) è§£æå¼€å§‹æ—¶é—´
    let startTime;
    try {
      startTime = new Date(startEntry.timestamp);
      if (isNaN(startTime.getTime())) {
        throw new Error("æ— æ•ˆçš„å¼€å§‹æ—¶é—´");
      }
    } catch (e) {
      console.error("è§£æå¼€å§‹æ—¶é—´å¤±è´¥:", e);
      startTime = new Date(); // å¤‡ç”¨
    }

    // 4) æ„å»ºé˜¶æ®µå¯¹è±¡
    let newPhase = {
      startTime,
      plannedDuration: startEntry.duration || 60,
      status: 'planning',
      activities: [],
      totalExpectedDuration: 0,
      lastTransitionTime: new Date()
    };

    // 5) è¿‡æ»¤å‡ºæ´»åŠ¨æ¡ç›®
    const activityEntries = activityPlanData.filter(entry => entry.status !== "å¼€å§‹");
    if (activityEntries.length === 0) {
      console.warn("è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°æ´»åŠ¨æ¡ç›®");
    }

    // 6) é€æ¡æ„å»ºæ´»åŠ¨å¯¹è±¡
    activityEntries.forEach((entry) => {
      if (!entry.project) {
        console.warn("è­¦å‘Š: è·³è¿‡æ²¡æœ‰projectå±æ€§çš„æ¡ç›®", entry);
        return;
      }

      const activity = {
        id: generateId(),
        project: entry.project,
        expectedDuration: entry.expectedDuration || 15,
        allocatedDuration: entry.allocatedDuration || entry.expectedDuration || 15,
        status: entry.status || 'pending',
        experience: entry.experience || "",
        rating: entry.rating || 0,
        originalTimestamp: entry.timestamp,
        isStartTimeFixed: !!entry.isStartTimeFixed
      };

      // ======================= â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ç‚¹ START â–¼â–¼â–¼ =======================
      // å¦‚æœä¸€ä¸ªæ´»åŠ¨æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”æ˜¯å¾…å®šçŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒçš„'timestamp'å­—æ®µ
      // å­˜å‚¨çš„å°±æ˜¯æˆ‘ä»¬å¿…é¡»æ¢å¤çš„ 'expectedStart' æ—¶é—´ã€‚
      if (entry.isStartTimeFixed && activity.status === 'pending') {
        try {
          activity.expectedStart = new Date(entry.timestamp);
          if (isNaN(activity.expectedStart.getTime())) {
            activity.expectedStart = null; // å¦‚æœæ—¶é—´æˆ³æ— æ•ˆï¼Œåˆ™é‡ç½®
            console.warn("æ¢å¤å›ºå®šçš„expectedStartæ—¶é—´å¤±è´¥ï¼Œæ—¶é—´æˆ³æ— æ•ˆ:", entry.timestamp);
          }
        } catch(e) {
            activity.expectedStart = null;
            console.error("æ¢å¤å›ºå®šçš„expectedStartæ—¶é—´å‡ºé”™:", e);
        }
      }
      // ======================= â–²â–²â–² æ ¸å¿ƒä¿®å¤ç‚¹ END â–²â–²â–² =======================

      // å¦‚æœæœ‰å·²å¼€å§‹æˆ–å·²å®Œæˆçš„æ´»åŠ¨ï¼Œè®¾ç½®å®é™…å¼€å§‹æ—¶é—´
      if (entry.status === 'in-progress' || entry.status === 'completed') {
        try {
          activity.actualStart = new Date(entry.timestamp);
          if (isNaN(activity.actualStart.getTime())) {
            activity.actualStart = new Date(); // å¤‡ç”¨å€¼
          }
        } catch (e) {
          console.warn("æ— æ³•è§£æactualStartæ—¶é—´:", e);
          activity.actualStart = new Date(); // å¤‡ç”¨å€¼
        }
      }

      // å¦‚æœå·²å®Œæˆï¼Œè®¾ç½®å®é™…ç»“æŸæ—¶é—´
      if (entry.status === 'completed') {
        try {
          if (entry.actualEnd) {
            activity.actualEnd = new Date(entry.actualEnd);
            if (isNaN(activity.actualEnd.getTime())) {
              activity.actualEnd = new Date(
                activity.actualStart.getTime() +
                (activity.allocatedDuration || activity.expectedDuration) * 60 * 1000
              );
            }
          } else {
            activity.actualEnd = new Date(
              activity.actualStart.getTime() +
              (activity.allocatedDuration || activity.expectedDuration) * 60 * 1000
            );
          }
        } catch (e) {
          console.warn("æ— æ³•è®¾ç½®actualEndæ—¶é—´:", e);
          activity.actualEnd = new Date(); // å¤‡ç”¨
        }
      }

      newPhase.activities.push(activity);
    });

    // 7) æ ¡éªŒè‡³å°‘æœ‰ä¸€ä¸ªæ´»åŠ¨
    if (newPhase.activities.length === 0) {
      throw new Error("æ²¡æœ‰æˆåŠŸåŠ è½½ä»»ä½•æ´»åŠ¨");
    }

    // 8) è®¡ç®—æ€»é¢„æœŸæ—¶é•¿
    newPhase.totalExpectedDuration = newPhase.activities.reduce(
      (sum, activity) => sum + (activity.expectedDuration || 0), 0
    );

    // 9) æ ¹æ®æ´»åŠ¨çŠ¶æ€ç¡®å®šé˜¶æ®µçŠ¶æ€
    if (newPhase.activities.some(a => a.status === 'completed' || a.status === 'in-progress')) {
      newPhase.status = 'active';
    }

    // 10) æ›´æ–°æœ€åè½¬æ¢æ—¶é—´
    const latestActivities = [...newPhase.activities].filter(a => a.actualStart);
    if (latestActivities.length > 0) {
      const latestActivity = latestActivities.sort((a, b) =>
        new Date(b.actualStart) - new Date(a.actualStart)
      )[0];
      newPhase.lastTransitionTime = new Date(latestActivity.actualStart);
    }

    // 11) æ›´æ–°å½“å‰é˜¶æ®µ
    currentPhase = newPhase;

    // 12) åˆå§‹åŒ–é¢„è®¡æ—¶é—´
    if (currentPhase.status === 'active') {
      calculateExpectedTimes();
    } else {
      calculateExpectedTimesForPlanning();
    }

    // 14) æ›´æ–°UIçŠ¶æ€
    if (currentPhase.status === 'active') {
      lastUIState = { phase: 'active', timestamp: Date.now() };
    } else {
      lastUIState = { phase: 'planning', timestamp: Date.now() };
    }
    initUIBasedOnPhaseStatus();

    // 15) æˆåŠŸæç¤º
    statusEl.innerHTML = '';
    statusEl.createEl("div", {
      text: "å·²ä»å¤‡ä»½æ¢å¤æ´»åŠ¨è®¡åˆ’",
      attr: {style: "color: green; background-color: #e8f5e9; padding: 8px; border-radius: 3px; margin: 10px 0;"}
    });

    return true;
  } catch (error) {
    console.error("å¤„ç†æ´»åŠ¨è®¡åˆ’æ•°æ®å¤±è´¥:", error);
    statusEl.innerHTML = '';
    statusEl.createEl("div", {
      text: "å¤„ç†æ´»åŠ¨è®¡åˆ’æ•°æ®å¤±è´¥: " + error.message,
      attr: {style: "color: white; background-color: #d32f2f; padding: 8px; border-radius: 3px; margin: 10px 0;"}
    });
    return false;
  }
}


// ============================================================
// ğŸ¯ JSON æ•°æ®å­˜å‚¨å±‚ (æ–°å¢)
// ============================================================

// è·å–å½“å‰æ–‡ä»¶è·¯å¾„çš„å®‰å…¨æ–¹å¼ï¼ˆæ”¯æŒ DataviewJS ç¯å¢ƒï¼‰
function getCurrentFolder() {
    // è°ƒè¯•ä¿¡æ¯
    console.log("=== getCurrentFolder è°ƒè¯• ===");

    // æ–¹å¼1: ä¼˜å…ˆä½¿ç”¨ this.container.file (DataviewJS ç¯å¢ƒ)
    if (this?.container?.file?.path) {
        console.log("æ–¹å¼1 æˆåŠŸ: this.container.file.path =", this.container.file.path);
        return this.container.file.path.replace(/[^/]+$/, "");
    }
    console.log("æ–¹å¼1 å¤±è´¥: this.container =", this?.container);

    // æ–¹å¼2: ä½¿ç”¨ dv.current() (Dataview API)
    if (typeof dv !== 'undefined' && dv.current()?.file?.path) {
        console.log("æ–¹å¼2 æˆåŠŸ: dv.current().file.path =", dv.current().file.path);
        return dv.current().file.path.replace(/[^/]+$/, "");
    }
    console.log("æ–¹å¼2 å¤±è´¥: dv.current() =", typeof dv !== 'undefined' ? dv.current() : 'dv undefined');

    // æ–¹å¼3: ä½¿ç”¨ app.workspace (å¤‡é€‰)
    if (typeof app !== 'undefined' && app.workspace?.getActiveFile()?.path) {
        console.log("æ–¹å¼3 æˆåŠŸ: getActiveFile().path =", app.workspace.getActiveFile().path);
        return app.workspace.getActiveFile().path.replace(/[^/]+$/, "");
    }
    console.log("æ–¹å¼3 å¤±è´¥: app.workspace.getActiveFile() =", typeof app !== 'undefined' ? app.workspace?.getActiveFile() : 'app undefined');

    // å›é€€: è¿”å›ç©ºå­—ç¬¦ä¸²æˆ–å½“å‰ç›®å½•
    console.warn("æ‰€æœ‰è·¯å¾„è·å–æ–¹å¼éƒ½å¤±è´¥ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²ä½œä¸ºç›®å½•");
    return "";
}

const currentFolder = getCurrentFolder();
console.log("currentFolder ç»“æœ:", currentFolder);

// ä¿®å¤ï¼šç¡®ä¿è·¯å¾„ä¸ä»¥/ç»“å°¾ï¼Œé¿å…åŒæ–œæ é—®é¢˜
const normalizedFolder = currentFolder.replace(/\/$/, "");
const PLAN_FILE = normalizedFolder
    ? `${normalizedFolder}/superplan_data.json`
    : "superplan_data.json";
console.log("PLAN_FILE è·¯å¾„:", PLAN_FILE);

// ä¿å­˜è®¡åˆ’åˆ° JSON æ–‡ä»¶ï¼ˆå‚è€ƒ GTD çš„ç®€æ´å†™æ³•ï¼‰
async function savePlanToJSON(phase) {
    console.log("=== savePlanToJSON å¼€å§‹ ===");
    console.log("PLAN_FILE:", PLAN_FILE);
    if (!phase) {
        console.log("phase ä¸ºç©ºï¼Œè¿”å› false");
        return false;
    }
    try {
        const planData = {
            id: phase.id || generateId(),  // ä½¿ç”¨ generateId è€Œä¸æ˜¯ generateActivityId
            created: phase.created || new Date().toISOString(),
            startTime: phase.startTime,
            plannedDuration: phase.plannedDuration,
            activities: phase.activities.map(a => ({
                id: a.id,
                project: a.project,
                expectedDuration: a.expectedDuration,
                allocatedDuration: a.allocatedDuration,
                status: a.status,
                isStartTimeFixed: a.isStartTimeFixed,
                expectedStart: a.expectedStart,
                expectedEnd: a.expectedEnd,
                // æ–°å¢ï¼šä¿å­˜å®é™…æ—¶é—´ï¼ˆç”¨äºå·²å®Œæˆæ´»åŠ¨çš„å†å²è®°å½•ï¼‰
                actualStart: a.actualStart,
                actualEnd: a.actualEnd,
                // ä¿å­˜ä½“éªŒå’Œè¯„åˆ†
                experience: a.experience || "",
                rating: a.rating || 0,
                // é¢„ç•™ä½ï¼šæœªæ¥å¯æ‰©å±•çš„è‡ªå®šä¹‰å­—æ®µ
            }))
        };
        const jsonString = JSON.stringify(planData, null, 2);
        console.log("JSON æ•°æ®å‡†å¤‡å®Œæ¯•ï¼Œé•¿åº¦:", jsonString.length);

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        const fileExists = await app.vault.adapter.exists(PLAN_FILE);
        console.log("æ–‡ä»¶æ˜¯å¦å­˜åœ¨:", fileExists);

        const file = app.vault.getAbstractFileByPath(PLAN_FILE);
        console.log("getAbstractFileByPath ç»“æœ:", file);

        if (file) {
            console.log("æ‰§è¡Œ modify...");
            await app.vault.modify(file, jsonString);
        } else {
            console.log("æ‰§è¡Œ create...");
            await app.vault.create(PLAN_FILE, jsonString);
        }
        console.log("âœ… è®¡åˆ’å·²ä¿å­˜:", PLAN_FILE);
        return true;
    } catch (e) {
        console.error("âŒ ä¿å­˜è®¡åˆ’å¤±è´¥:", e);
        console.error("é”™è¯¯è¯¦æƒ…:", e.message, e.stack);
        return false;
    }
}

// ä» JSON æ–‡ä»¶åŠ è½½è®¡åˆ’
async function loadPlanFromJSON() {
    console.log("=== loadPlanFromJSON å¼€å§‹ ===");
    console.log("PLAN_FILE:", PLAN_FILE);
    try {
        const fileExists = await app.vault.adapter.exists(PLAN_FILE);
        console.log("æ–‡ä»¶æ˜¯å¦å­˜åœ¨:", fileExists);

        if (fileExists) {
            const content = await app.vault.adapter.read(PLAN_FILE);
            console.log("æ–‡ä»¶å†…å®¹é•¿åº¦:", content.length);
            const data = JSON.parse(content);
            console.log("JSON è§£ææˆåŠŸï¼Œæ´»åŠ¨æ•°é‡:", data.activities?.length);

            // æ£€æµ‹æ˜¯å¦æœ‰æ‰§è¡Œä¸­çš„æ´»åŠ¨ï¼Œå†³å®šé˜¶æ®µçŠ¶æ€
            const hasActiveActivity = data.activities.some(a => a.status === 'in-progress');
            const hasCompletedActivity = data.activities.some(a => a.status === 'completed');
            const detectedStatus = (hasActiveActivity || hasCompletedActivity) ? 'active' : 'planning';
            console.log("æ£€æµ‹åˆ°çš„çŠ¶æ€:", detectedStatus);

            // è½¬æ¢ä¸º Phase å¯¹è±¡ï¼ˆä¿ç•™åŸæœ‰çš„ actualStart, actualEnd ç­‰æ•°æ®ï¼‰
            return {
                id: data.id,
                created: data.created,
                startTime: data.startTime,
                plannedDuration: data.plannedDuration,
                status: detectedStatus,  // æ ¹æ®æ´»åŠ¨çŠ¶æ€åŠ¨æ€æ£€æµ‹
                activities: data.activities.map(a => ({
                    ...a,
                    originalTimestamp: a.id,
                    experience: a.experience || "",
                    rating: a.rating || 0,
                    // æ³¨æ„ï¼šactualStart å’Œ actualEnd åº”è¯¥ä» JSON æ•°æ®ä¸­ä¿ç•™
                    // é¢„ç•™ä½ï¼šæœªæ¥å¯æ‰©å±•çš„è‡ªå®šä¹‰å­—æ®µ
                })),
                totalExpectedDuration: data.activities.reduce((sum, a) => sum + a.expectedDuration, 0),
                lastTransitionTime: new Date(data.startTime)
            };
        } else {
            console.log("æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å› null");
        }
    } catch (e) {
        console.error("ä» JSON åŠ è½½è®¡åˆ’å¤±è´¥:", e);
        console.error("é”™è¯¯è¯¦æƒ…:", e.message, e.stack);
    }
    return null;
}

// å†å²è®°å½•æ–‡ä»¶è·¯å¾„ï¼ˆä¸ PLAN_FILE ä½¿ç”¨ç›¸åŒé€»è¾‘ï¼‰
const HISTORY_FILE = normalizedFolder
    ? `${normalizedFolder}/superplan_history.json`
    : "superplan_history.json";

// ä¿å­˜å†å²è®°å½•åˆ° JSON
async function saveHistoryToJSON(newEntry) {
    try {
        let history = [];
        if (await app.vault.adapter.exists(HISTORY_FILE)) {
            const content = await app.vault.adapter.read(HISTORY_FILE);
            history = JSON.parse(content);
        }
        history.unshift(newEntry);

        // åªä¿ç•™æœ€è¿‘ 1000 æ¡è®°å½•
        if (history.length > 1000) {
            history = history.slice(0, 1000);
        }

        const jsonString = JSON.stringify(history, null, 2);
        const file = app.vault.getAbstractFileByPath(HISTORY_FILE);
        if (file) await app.vault.modify(file, jsonString);
        else await app.vault.create(HISTORY_FILE, jsonString);
        return true;
    } catch (e) {
        console.error("ä¿å­˜å†å²è®°å½•å¤±è´¥:", e);
        return false;
    }
}

// ä» JSON åŠ è½½å†å²è®°å½•
async function loadHistoryFromJSON() {
    try {
        if (await app.vault.adapter.exists(HISTORY_FILE)) {
            const content = await app.vault.adapter.read(HISTORY_FILE);
            return JSON.parse(content);
        }
    } catch (e) {
        console.error("åŠ è½½å†å²è®°å½•å¤±è´¥:", e);
    }
    return [];
}

// å°è¯•ä» JSON è‡ªåŠ¨æ¢å¤
async function tryAutoRestoreFromJSON() {
    const plan = await loadPlanFromJSON();
    if (plan) {
        console.log("ä» JSON æ–‡ä»¶æ¢å¤è®¡åˆ’æˆåŠŸ");
        return plan;
    }
    return null;
}

// ç»Ÿä¸€çš„ä¿å­˜å‡½æ•°ï¼ˆæ›¿ä»£åŸæ¥çš„ saveCurrentStateï¼‰
async function saveCurrentStateJSON() {
    if (!currentPhase) return false;

    // ä¿å­˜è®¡åˆ’
    const planSuccess = await savePlanToJSON(currentPhase);
    if (!planSuccess) {
        console.error("ä¿å­˜è®¡åˆ’å¤±è´¥");
        return false;
    }

    console.log("è®¡åˆ’å·²ä¿å­˜åˆ° JSON");
    return true;
}

// ============================================================
// ä»¥ä¸Šä¸ºæ–°å¢çš„ JSON æ•°æ®å­˜å‚¨å±‚
// ============================================================

// Toast é€šçŸ¥å‡½æ•° - éé˜»å¡åé¦ˆ
function showToast(message, type = 'success', duration = 2000) {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ toast å®¹å™¨
    let toastContainer = document.querySelector('.time-planner-toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'time-planner-toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        `;
        document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    const colors = {
        success: { bg: '#4CAF50', text: '#fff' },
        error: { bg: '#f44336', text: '#fff' },
        info: { bg: '#2196F3', text: '#fff' }
    };
    const color = colors[type] || colors.success;

    toast.style.cssText = `
        background: ${color.bg};
        color: ${color.text};
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: toastSlideIn 0.3s ease;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    toast.textContent = message;
    toastContainer.appendChild(toast);

    // åŠ¨ç”»æ˜¾ç¤º
    requestAnimationFrame(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    });

    // è‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// æ·»åŠ  toast åŠ¨ç”»æ ·å¼
const toastStyle = document.createElement('style');
toastStyle.textContent = `
    @keyframes toastSlideIn {
        from { opacity: 0; transform: translateX(100%); }
        to { opacity: 1; transform: translateX(0); }
    }
`;
document.head.appendChild(toastStyle);

// åˆ›å»ºä¸»å®¹å™¨
const containerEl = this.container.createEl("div", {cls: "time-planner-container"});
containerEl.style.position = "relative"; // ç¡®ä¿å­å…ƒç´ ç»å¯¹å®šä½æ­£ç¡®
const statusEl = containerEl.createEl("div", {cls: "status-message"});

// æ·»åŠ å…¨å±€æ ·å¼
const styleEl = containerEl.createEl("style");
styleEl.textContent = `
  /* è®¡åˆ’æ´»åŠ¨å¡ç‰‡æ ·å¼ */
  .activities-card {
    background: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 10px;
    cursor: grab;
    transition: all 0.2s ease;
  }
  .activities-card:hover {
    border-color: var(--interactive-accent);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .activities-card.is-dragging {
    opacity: 0.5;
    border: 2px dashed var(--interactive-accent);
  }
  .activities-card.drag-over {
    border: 2px dashed var(--interactive-accent);
    background: rgba(var(--interactive-accent-rgb), 0.05);
  }

  /* æ‰§è¡Œé˜¶æ®µå¡ç‰‡æ ·å¼ */
  .execution-card {
    background: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
  }
  .execution-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .execution-card.is-dragging {
    opacity: 0.5;
    border: 2px dashed var(--interactive-accent);
  }
  .execution-card.drag-over {
    border: 2px dashed var(--interactive-accent);
    background: rgba(var(--interactive-accent-rgb), 0.05);
  }
  /* å½“å‰è¿›è¡Œä¸­å¡ç‰‡çš„è¿›åº¦èƒŒæ™¯æ¡ */
  .activity-progress {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
  }
  .activity-progress-bar {
    position: absolute;
    inset: 0;
    width: 0%;
    background: linear-gradient(90deg, rgba(76,175,80,0.35), rgba(76,175,80,0.15));
    z-index: 0;
    transition: width 0.6s ease;
  }
  .activity-progress-content {
    position: relative;
    z-index: 1;
  }
  .activity-rating-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    background: rgba(76, 175, 80, 0.12);
  }
  .activity-review-block {
    margin-bottom: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    background: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
  }
  .activity-review-block.in-progress {
    background: linear-gradient(90deg, rgba(76,175,80,0.20), rgba(76,175,80,0.08));
    border-color: rgba(76,175,80,0.45);
  }
  .activity-review-block.in-progress .activity-review-title {
    color: #2e7d32;
  }
  .activity-review-title {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 6px;
    font-weight: 600;
  }
  .activity-review-content {
    font-size: 13px;
    color: var(--text-normal);
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.5;
  }
  .activity-review-empty {
    font-size: 13px;
    color: var(--text-muted);
    font-style: italic;
  }

  /* ç¼–è¾‘å¼¹çª—æ ·å¼ */
  .edit-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .edit-modal-content {
    background: var(--background-primary);
    border-radius: 12px;
    padding: 24px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  }

  /* æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ */
  .dragging {
    opacity: 0.5;
    transform: scale(0.98);
  }
`;

// åˆ›å»ºé˜¶æ®µè§„åˆ’è¡¨å•
const phaseFormEl = containerEl.createEl("div", {cls: "phase-form"});
const phaseTitle = phaseFormEl.createEl("h3", {text: "åˆ›å»ºæ–°çš„æ—¶é—´è§„åˆ’é˜¶æ®µ"});

// å¼€å§‹æ—¶é—´é€‰æ‹©
const startTimeDiv = phaseFormEl.createEl("div", {cls: "form-group"});
const startTimeLabel = startTimeDiv.createEl("label", {text: "å¼€å§‹æ—¶é—´:"});
const now = new Date();
const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
const startTimeInput = startTimeDiv.createEl("input", {
  attr: {
    type: "time", 
    value: timeString
  }
});

// è®¡åˆ’æ€»æ—¶é•¿
const durationDiv = phaseFormEl.createEl("div", {cls: "form-group"});
const durationLabel = durationDiv.createEl("label", {text: "è®¡åˆ’æ€»æ—¶é•¿(åˆ†é’Ÿ):"});
const durationInput = phaseFormEl.createEl("input", {attr: {type: "number", min: "1", value: "60"}});

// åˆ›å»ºé˜¶æ®µæŒ‰é’®
const createPhaseBtn = phaseFormEl.createEl("button", {text: "åˆ›å»ºæ—¶é—´é˜¶æ®µ"});

// ä» JSON æ¢å¤æŒ‰é’®
const restoreFromJSONBtn = phaseFormEl.createEl("button", {
    text: "ğŸ“‚ ä» JSON æ¢å¤",
    attr: {
        style: "margin-left: 10px; background-color: #9c27b0; color: white;",
        title: "ä» superplan_data.json æ¢å¤ä¹‹å‰çš„è®¡åˆ’"
    }
});
restoreFromJSONBtn.addEventListener("click", async () => {
    const restored = await tryAutoRestoreFromJSON();
    if (restored) {
        currentPhase = restored;
        initUIBasedOnPhaseStatus();
        showToast("âœ… å·²ä» JSON æ¢å¤æ•°æ®", "success");
    } else {
        showToast("âŒ æœªæ‰¾åˆ°å¯æ¢å¤çš„æ•°æ®", "error");
    }
});

// æ´»åŠ¨è§„åˆ’åŒºåŸŸ
const activitiesFormEl = containerEl.createEl("div", {cls: "activities-form", attr: {style: "display: none;"}});
const activitiesTitle = activitiesFormEl.createEl("h3", {text: "æ·»åŠ è®¡åˆ’æ´»åŠ¨"});
const phaseSummary = activitiesFormEl.createEl("div", {cls: "phase-summary"});

// æ·»åŠ æ´»åŠ¨è¡¨å•
const addActivityForm = activitiesFormEl.createEl("div", {cls: "add-activity-form"});
const projectLabel = addActivityForm.createEl("label", {text: "æ´»åŠ¨åç§°:"});
const projectInput = addActivityForm.createEl("input", {attr: {type: "text"}});
const projectDurationLabel = addActivityForm.createEl("label", {text: "å¿ƒç†é¢„æœŸæ—¶é•¿(åˆ†é’Ÿ):"});
const projectDurationInput = addActivityForm.createEl("input", {attr: {type: "number", min: "1", value: "15"}});
const addActivityBtn = addActivityForm.createEl("button", {text: "æ·»åŠ æ´»åŠ¨"});

// è®¡åˆ’æ´»åŠ¨åˆ—è¡¨ - ç°ä»£å¡ç‰‡å¼å¸ƒå±€
const activitiesListEl = activitiesFormEl.createEl("div", {cls: "activities-list"});
activitiesListEl.createEl("h4", {text: "å·²è§„åˆ’æ´»åŠ¨ï¼ˆå¯æ‹–æ‹½è°ƒæ•´é¡ºåºï¼‰"});

// æ´»åŠ¨å¡ç‰‡å®¹å™¨ï¼ˆä½¿ç”¨ div æ›¿ä»£è¡¨æ ¼ï¼‰
const activitiesTableBody = activitiesListEl.createEl("div", {
    cls: "activities-cards-wrapper",
    attr: {style: "margin-top: 15px;"}
});

// æ˜¾ç¤ºæ€»åˆ†é…æƒ…å†µ
const allocationSummary = activitiesFormEl.createEl("div", {cls: "allocation-summary"});

// å¼€å§‹æ‰§è¡Œè®¡åˆ’æŒ‰é’®
const startPhaseBtn = activitiesFormEl.createEl("button", {
  text: "å¼€å§‹æ‰§è¡Œè®¡åˆ’", 
  attr: {style: "margin-top: 15px; background-color: #4CAF50; color: white;"}
});

// æ‰‹åŠ¨ä¿å­˜æŒ‰é’®ï¼ˆè§„åˆ’é¡µé¢ï¼‰- ä½¿ç”¨ JSON å­˜å‚¨
const savePlanBtn = activitiesFormEl.createEl("button", {
  text: "ä¿å­˜åˆ°å¤‡ä»½",
  attr: {
    style: "margin-top: 15px; margin-left: 10px; background-color: #2196F3; color: white;",
    title: "ä¿å­˜å½“å‰æ´»åŠ¨è§„åˆ’åˆ° JSON æ–‡ä»¶"
  }
});
savePlanBtn.addEventListener("click", async () => {
  const success = await saveCurrentStateJSON();
  if (success) {
    showToast("âœ… è®¡åˆ’å·²ä¿å­˜åˆ° JSON", "success");
  } else {
    showToast("âŒ ä¿å­˜å¤±è´¥", "error");
  }
});

// æ‰§è¡Œè®¡åˆ’çš„æ§åˆ¶é¢æ¿
const executionPanelEl = containerEl.createEl("div", {cls: "execution-panel", attr: {style: "display: none;"}});
const executionTitle = executionPanelEl.createEl("h3", {text: "è®¡åˆ’æ‰§è¡Œ"});

// ä¿®æ”¹åçš„è¿›åº¦æ¡å®¹å™¨
const progressBarContainer = executionPanelEl.createEl("div", {
  cls: "progress-container",
  attr: {
    style: "position: relative; height: 40px; margin-bottom: 15px; background-color: #f5f5f5; border-radius: 4px; overflow: visible;"
  }
});

// è¿›åº¦æ¡
const progressBar = progressBarContainer.createEl("div", {
  cls: "progress-bar",
  attr: {
    style: "position: absolute; height: 100%; background-color: rgba(76, 175, 80, 0.7); transition: width 0.5s ease;"
  }
});

// è¿›åº¦æ–‡æœ¬
const progressText = progressBarContainer.createEl("div", {
  cls: "progress-text",
  attr: {
    style: "position: absolute; width: 100%; text-align: center; padding: 10px 0; z-index: 2; color: #333; font-weight: bold;"
  }
});

// å½“å‰æ´»åŠ¨ä¿¡æ¯
const currentActivityEl = executionPanelEl.createEl("div", {cls: "current-activity"});
const currentActivityTitle = currentActivityEl.createEl("h4", {text: "å½“å‰è¿›è¡Œä¸­çš„æ´»åŠ¨"});
const currentActivityName = currentActivityEl.createEl("div", {cls: "current-activity-name"});
const currentActivityTime = currentActivityEl.createEl("div", {cls: "current-activity-time"});

// æ´»åŠ¨æ‰§è¡Œåˆ—è¡¨ - ç°ä»£å¡ç‰‡å¼å¸ƒå±€
const executionListEl = executionPanelEl.createEl("div", {cls: "execution-list"});
executionListEl.createEl("h4", {text: "æ´»åŠ¨è®¡åˆ’è¡¨"});

// å¡ç‰‡å®¹å™¨ï¼ˆä½¿ç”¨ div æ›¿ä»£è¡¨æ ¼ï¼‰
const executionCardsWrapper = executionListEl.createEl("div", {
    cls: "execution-cards-wrapper",
    attr: {style: "margin-top: 15px;"}
});

// ç§»é™¤æ—§çš„è¡¨æ ¼ç»“æ„
// const executionTable = executionListEl.createEl("table", {cls: "execution-table"});
// const executionTableHead = executionTable.createEl("thead");


// ç§»é™¤è¡¨æ ¼è¡¨å¤´
// const executionHeadRow = executionHeadRow = executionTableHead.createEl("tr");
// [
//   {text: "å›ºå®š", width: "5%"},
//   {text: "é¢„è®¡å¼€å§‹æ—¶é—´", width: "8%"},
//   {text: "é¢„è®¡ç»“æŸæ—¶é—´", width: "8%"},
//   {text: "äº‹é¡¹åç§°", width: "23%"},
//   {text: "å¿ƒç†é¢„æœŸ", width: "7%"},
//   {text: "å®é™…åˆ†é…", width: "9%"},
//   {text: "ä½“éªŒæè¿°", width: "24%"},
//   {text: "è¯„åˆ†", width: "6%"},
//   {text: "æ“ä½œ", width: "10%"}
// ].forEach(header => {
//   const th = executionHeadRow.createEl("th", {text: header.text});
//   th.style.width = header.width;
// });

// const executionTableBody = executionTable.createEl("tbody");

// ä¸‹ä¸€ä¸ªæ´»åŠ¨ä¿¡æ¯
const nextActivityEl = executionPanelEl.createEl("div", {cls: "next-activity"});
const nextActivityTitle = nextActivityEl.createEl("h4", {text: "ä¸‹ä¸€ä¸ªæ´»åŠ¨"});
const nextActivityName = nextActivityEl.createEl("div", {cls: "next-activity-name"});

// æ§åˆ¶æŒ‰é’®
const controlsEl = executionPanelEl.createEl("div", {cls: "controls"});
const nextActivityBtn = controlsEl.createEl("button", {text: "å¼€å§‹ä¸‹ä¸€ä¸ªæ´»åŠ¨"});

// æ‰‹åŠ¨ä¿å­˜æŒ‰é’®ï¼ˆè®¡åˆ’æ‰§è¡Œé¡µé¢ï¼‰
const saveExecutionBtn = controlsEl.createEl("button", {
  text: "ä¿å­˜å½“å‰çŠ¶æ€",
  attr: {
    style: "background-color: #2196F3; color: white; margin-left: 10px; font-weight: bold;",
    title: "æ‰‹åŠ¨ä¿å­˜å½“å‰æ‰€æœ‰çŠ¶æ€åˆ°å¤‡ä»½"
  }
});

// ç»‘å®šä¿å­˜å½“å‰çŠ¶æ€æŒ‰é’®äº‹ä»¶
saveExecutionBtn.addEventListener("click", async () => {
  const success = await saveCurrentStateJSON();
  if (success) {
    showToast("âœ… è®¡åˆ’å·²ä¿å­˜åˆ° JSON", "success");
  } else {
    showToast("âŒ ä¿å­˜å¤±è´¥", "error");
  }
});

// æ·»åŠ æ–°åŠŸèƒ½ï¼šå»¶é•¿æ€»æ—¶é•¿æŒ‰é’®ï¼ˆæ”¾åœ¨æ§åˆ¶æŒ‰é’®ä¸­ï¼‰
const extendDurationBtn = controlsEl.createEl("button", {
  text: "å»¶é•¿æ€»æ—¶é•¿", 
  attr: {
    style: "background-color: #9c27b0; color: white; margin-left: 10px;",
    title: "å»¶é•¿è®¡åˆ’æ€»æ—¶é•¿"
  }
});

// ç»“æŸå½“å‰æ—¶é—´é˜¶æ®µ
const finishPhaseBtn = executionPanelEl.createEl("button", {
  text: "ç»“æŸæ—¶é—´é˜¶æ®µ", 
  attr: {style: "margin-top: 15px; background-color: #f44336; color: white;"}
});

// å®Œæˆè¯„ä»·è¡¨å•
const reviewFormEl = containerEl.createEl("div", {cls: "review-form", attr: {style: "display: none;"}});
const reviewTitle = reviewFormEl.createEl("h3", {text: "æ´»åŠ¨è¯„ä»·"});
const activityToReviewName = reviewFormEl.createEl("h4", {text: ""});
// åœ¨åˆå§‹åŒ–ä»£ç ä¸­æ›¿æ¢experienceInputçš„åˆ›å»ºéƒ¨åˆ†
const experienceLabel = reviewFormEl.createEl("label", {text: "ä½“éªŒæè¿°:"});
experienceLabel.style.display = "block";
experienceLabel.style.marginBottom = "5px";
experienceLabel.style.fontWeight = "bold";

const experienceInput = reviewFormEl.createEl("textarea");
experienceInput.style.width = "100%";
experienceInput.style.height = "300px"; // æ˜¾è‘—å¢åŠ é«˜åº¦
experienceInput.style.padding = "10px";
experienceInput.style.fontSize = "16px";
experienceInput.style.resize = "vertical"; // å…è®¸å‚ç›´è°ƒæ•´å¤§å°
experienceInput.style.marginBottom = "15px";
experienceInput.setAttribute("placeholder", "è¯·æè¿°æ‚¨çš„ä½“éªŒï¼ˆå¯è¾“å…¥æœ€å¤š1000å­—ï¼‰");
experienceInput.setAttribute("maxlength", "1000"); // é™åˆ¶æœ€å¤§å­—ç¬¦æ•°

// è®¾ç½®è¯„ä»·è¡¨å•æ•´ä½“æ ·å¼
reviewFormEl.style.maxWidth = "800px";
reviewFormEl.style.margin = "20px auto";
reviewFormEl.style.padding = "20px";
reviewFormEl.style.backgroundColor = "#f9f9f9";
reviewFormEl.style.borderRadius = "5px";
reviewFormEl.style.boxShadow = "0 2px 5px rgba(0,0,0,0.1)";
// ä¿®å¤ï¼šæ·»åŠ å®šä½å’Œ z-index ç¡®ä¿è¡¨å•æ­£ç¡®æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚
reviewFormEl.style.position = "absolute";
reviewFormEl.style.top = "50%";
reviewFormEl.style.left = "50%";
reviewFormEl.style.transform = "translate(-50%, -50%)";
reviewFormEl.style.zIndex = "1000";
reviewFormEl.style.width = "90%";
const ratingLabel = reviewFormEl.createEl("label", {text: "è¯„åˆ†(1-5):"});
const ratingInput = reviewFormEl.createEl("select");
for (let i = 1; i <= 5; i++) {
  ratingInput.createEl("option", {text: String(i), attr: {value: String(i)}});
}
ratingInput.value = "3";

// æäº¤æŒ‰é’®æ ·å¼
let submitReviewBtn = reviewFormEl.createEl("button", {
  text: "æäº¤è¯„ä»·",
  attr: {
    style: "padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;"
  }
});

// ==================== ã€æ–°å¢ã€‘ç¼–è¾‘æ´»åŠ¨å¼¹çª— ====================
const editModalEl = containerEl.createEl("div", {cls: "edit-modal"});
const editModalContent = editModalEl.createEl("div", {cls: "edit-modal-content"});
editModalContent.createEl("h3", {text: "ç¼–è¾‘æ´»åŠ¨", attr: {style: "margin-top: 0; margin-bottom: 20px; border-bottom: 2px solid var(--interactive-accent); padding-bottom: 10px;"}});

const editForm = editModalContent.createEl("div", {attr: {style: "display: flex; flex-direction: column; gap: 16px;"}});

// æ´»åŠ¨åç§°è¾“å…¥
const editNameLabel = editForm.createEl("label", {text: "äº‹é¡¹åç§°:", attr: {style: "font-weight: 600;"}});
const editNameInput = editForm.createEl("input", {attr: {type: "text", style: "width: 100%; padding: 10px; border: 1px solid var(--background-modifier-border); border-radius: 6px; font-size: 15px;"}});

// ä½“éªŒæè¿°è¾“å…¥
const editExperienceLabel = editForm.createEl("label", {text: "ä½“éªŒæè¿°:", attr: {style: "font-weight: 600;"}});
const editExperienceTextarea = editForm.createEl("textarea", {attr: {style: "width: 100%; height: 120px; padding: 10px; border: 1px solid var(--background-modifier-border); border-radius: 6px; font-size: 14px; resize: vertical;"}});

// é¢„æœŸæ—¶é—´è¾“å…¥
const editTimeLabel = editForm.createEl("label", {text: "å¿ƒç†é¢„æœŸæ—¶é•¿ (åˆ†é’Ÿ):", attr: {style: "font-weight: 600;"}});
const editTimeInput = editForm.createEl("input", {attr: {type: "number", min: "1", style: "width: 100%; padding: 10px; border: 1px solid var(--background-modifier-border); border-radius: 6px; font-size: 15px;"}});

// æŒ‰é’®è¡Œ
const editBtnRow = editForm.createEl("div", {attr: {style: "display: flex; gap: 10px; margin-top: 10px;"}});
const saveEditBtn = editBtnRow.createEl("button", {text: "ä¿å­˜", attr: {style: "flex: 1; padding: 12px; background: var(--interactive-accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;"}});
const cancelEditBtn = editBtnRow.createEl("button", {text: "å–æ¶ˆ", attr: {style: "flex: 1; padding: 12px; background: var(--background-modifier-border); color: var(--text-normal); border: none; border-radius: 6px; cursor: pointer; font-size: 15px;"}});

// ç¼–è¾‘å¼¹çª—æ§åˆ¶
let currentEditingActivity = null;

function showEditModal(activity) {
    if (!activity) return;
    currentEditingActivity = activity;
    editNameInput.value = activity.project || "";
    editExperienceTextarea.value = activity.experience || "";
    editTimeInput.value = activity.expectedDuration || 30;
    editModalEl.style.display = "flex";
}

function hideEditModal() {
    editModalEl.style.display = "none";
    currentEditingActivity = null;
}

function saveEdit() {
    if (!currentEditingActivity) return;

    const newName = editNameInput.value.trim();
    const newExperience = editExperienceTextarea.value.trim();
    const newDuration = parseInt(editTimeInput.value, 10);

    if (!newName) {
        new Notice("è¯·è¾“å…¥äº‹é¡¹åç§°");
        return;
    }
    if (isNaN(newDuration) || newDuration < 1) {
        new Notice("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿");
        return;
    }

    // æ›´æ–°æ•°æ®
    currentEditingActivity.project = newName;
    currentEditingActivity.experience = newExperience;
    currentEditingActivity.expectedDuration = newDuration;

    // é‡æ–°è®¡ç®—æ—¶é—´åˆ†é…
    allocateRemainingTime();

    // åˆ·æ–°ç•Œé¢
    renderExecutionList();
    hideEditModal();
    debouncedSave();

    new Notice(`å·²æ›´æ–°: ${newName}`);
}

// ç»‘å®šç¼–è¾‘å¼¹çª—äº‹ä»¶
cancelEditBtn.addEventListener("click", hideEditModal);
saveEditBtn.addEventListener("click", saveEdit);
editModalEl.addEventListener("click", (e) => {
    if (e.target === editModalEl) hideEditModal();
});

// ç»Ÿè®¡ä¸è®°å½•åŒºåŸŸ
const statsEl = containerEl.createEl("div", {cls: "stats-container", attr: {style: "margin-top: 20px;"}});
const entriesEl = containerEl.createEl("div", {cls: "entries-container", attr: {style: "margin-top: 20px;"}});

// æ ¼å¼åŒ–æ—¶é—´ä¸ºyyyy/MM/dd HH:mm:ssæ ¼å¼
function formatDateForTimestamp(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
}

// è®¡åˆ’å®Œæˆæ—¶è½¬æ¢ä¸ºè®°å½• - ä¿®å¤è¯„ä»·è®°å½•åˆ°å½“å‰æ´»åŠ¨è€Œéä¸‹ä¸€æ´»åŠ¨
// è®¡åˆ’å®Œæˆæ—¶è½¬æ¢ä¸ºè®°å½• - ä¿®å¤è¯„ä»·è®°å½•åˆ°å½“å‰æ´»åŠ¨è€Œéä¸‹ä¸€æ´»åŠ¨
function convertPhaseToEntries(phase) {
  const newEntries = [];
  
  // è·å–æ‰€æœ‰å·²å®Œæˆçš„æ´»åŠ¨
  const completedActivities = phase.activities.filter(activity => 
    activity.status === 'completed' && activity.actualStart && activity.actualEnd
  ).sort((a, b) => new Date(b.actualStart) - new Date(a.actualStart)); // æŒ‰å¼€å§‹æ—¶é—´å€’åºæ’åº
  
  // æ·»åŠ ç‰¹æ®Šçš„ç»“å°¾è®°å½•ï¼Œæ ‡è®°æ—¶é—´é˜¶æ®µå®Œæˆ
  const endTime = new Date();
  const endEntry = {
    timestamp: formatDateForTimestamp(endTime),
    project: "**é˜¶æ®µç»“æŸ**æœªè®°å½•", // ä¿®æ”¹ï¼šæ·»åŠ é˜¶æ®µç»“æŸæ ‡è®°
    prevExperience: "ä¸€ä¸ªæ—¶é—´æ®µå®Œæˆäº†",
    prevRating: 5
  };
  
  // å°†æœ€åä¸€ä¸ªå®Œæˆæ´»åŠ¨çš„è¯„ä»·æ”¾åˆ°"æœªè®°å½•"æ¡ç›®ä¸­
  if (completedActivities.length > 0) {
    const lastActivity = completedActivities[0]; // æœ€è¿‘å®Œæˆçš„æ´»åŠ¨
    endEntry.prevExperience = lastActivity.experience || "æœªè®°å½•";
    endEntry.prevRating = lastActivity.rating || 3;
  }
  
  newEntries.push(endEntry);
  
  // å¤„ç†æ‰€æœ‰å®Œæˆçš„æ´»åŠ¨ï¼Œå°†æ¯ä¸ªæ´»åŠ¨çš„è¯„ä»·èµ‹ç»™ä¸‹ä¸€ä¸ªæ´»åŠ¨çš„prevExperience
  for (let i = 0; i < completedActivities.length; i++) {
    const currentActivity = completedActivities[i];
    const startTime = new Date(currentActivity.actualStart);
    
    const newEntry = {
      timestamp: formatDateForTimestamp(startTime),
      project: currentActivity.project,
      prevExperience: "æœªè®°å½•",
      prevRating: 3
    };
    
    // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªæ´»åŠ¨ï¼Œåˆ™ä½¿ç”¨å‰ä¸€ä¸ªæ´»åŠ¨çš„è¯„ä»·
    if (i < completedActivities.length - 1) {
      const prevActivity = completedActivities[i + 1]; // å› ä¸ºæ˜¯å€’åºï¼Œæ‰€ä»¥i+1æ˜¯å‰ä¸€ä¸ª
      newEntry.prevExperience = prevActivity.experience || "æœªè®°å½•";
      newEntry.prevRating = prevActivity.rating || 3;
    }
    
    newEntries.push(newEntry);
  }
  
  // ä¿®æ”¹ï¼šä¸ºæœ€åä¸€ä¸ªæ¡ç›®ï¼ˆé˜¶æ®µå¼€å§‹ï¼‰æ·»åŠ æ ‡è®° - æ— æ¡ä»¶æ·»åŠ 
  if (newEntries.length > 1) {
    const lastEntry = newEntries[newEntries.length - 1];
    // æ— æ¡ä»¶ä¸ºæœ€åä¸€ä¸ªæ¡ç›®æ·»åŠ é˜¶æ®µå¼€å§‹æ ‡è®°
    lastEntry.project = "**é˜¶æ®µå¼€å§‹**" + lastEntry.project;
  }
  
  return newEntries;
}

// ä»YAMLæ¢å¤æ´»åŠ¨è®¡åˆ’ï¼ˆå¢å¼ºä¿®å¤ç‰ˆ - ä¿®å¤äº†æ— æ³•æ‰¾åˆ°activityPlanæ•°ç»„çš„é—®é¢˜ï¼‰
async function restoreFromActivityPlan() {
  // ä¿å­˜å½“å‰çŠ¶æ€ä»¥ä¾¿é”™è¯¯æ—¶æ¢å¤
  const backupPhase = currentPhase ? JSON.parse(JSON.stringify(currentPhase)) : null;
  const backupUIState = JSON.parse(JSON.stringify(lastUIState));
  
  try {
    // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
    statusEl.innerHTML = '';
    statusEl.createEl("div", {
      text: "æ­£åœ¨ä»å¤‡ä»½æ¢å¤...",
      attr: {style: "color: blue; background-color: #e3f2fd; padding: 8px; border-radius: 3px; margin: 10px 0;"}
    });
    
    // æ£€æŸ¥Obsidian APIæ˜¯å¦å¯ç”¨
    if (typeof app === 'undefined' || !app) {
      throw new Error("æ— æ³•è®¿é—®Obsidian API (appæœªå®šä¹‰)");
    }
    
    if (!app.vault) {
      throw new Error("æ— æ³•è®¿é—®Obsidianæ–‡ä»¶ç³»ç»Ÿ (app.vaultæœªå®šä¹‰)");
    }
    
 const currentFile = await getTargetFile();
    
    // å®‰å…¨è¯»å–æ–‡ä»¶å†…å®¹
    let fileContent;
    try {
      fileContent = await app.vault.read(currentFile);
    } catch (readError) {
      console.error("è¯»å–æ–‡ä»¶å†…å®¹å¤±è´¥:", readError);
      throw new Error("æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹: " + (readError.message || "æœªçŸ¥é”™è¯¯"));
    }
    
    if (!fileContent || fileContent.trim() === "") {
      throw new Error("æ–‡ä»¶å†…å®¹ä¸ºç©º");
    }
    
    if (!fileContent.startsWith('---\n')) {
      throw new Error("æœªæ‰¾åˆ°YAMLå‰ç½®å…ƒæ•°æ® (æ–‡ä»¶æœªä»¥---\\nå¼€å¤´)");
    }
    
    // æå–YAMLéƒ¨åˆ†
    const yamlEnd = fileContent.indexOf('\n---\n');
    if (yamlEnd <= 0) {
      throw new Error("YAMLæ ¼å¼é”™è¯¯ (æ‰¾ä¸åˆ°ç»“æŸæ ‡è®°)");
    }
    
    // æå–æ•´ä¸ªYAMLå†…å®¹
    const yamlSection = fileContent.substring(4, yamlEnd);
    console.log("æå–çš„YAMLå†…å®¹é•¿åº¦:", yamlSection.length, "å­—èŠ‚");
    
    // é¦–å…ˆå°è¯•æŸ¥æ‰¾activityPlanæ ‡è®°
    if (!yamlSection.includes('activityPlan:')) {
      throw new Error("YAMLä¸­æœªåŒ…å«activityPlanå…³é”®å­—");
    }
    
    // ä½¿ç”¨å¤šç§æ­£åˆ™è¡¨è¾¾å¼å°è¯•ä¸åŒæ ¼å¼çš„åŒ¹é…
    let activityPlanData = null;
    
    // æ–¹æ³•1: ä½¿ç”¨æ›´å®½æ¾çš„æ­£åˆ™è¡¨è¾¾å¼
    try {
      // æ–¹æ³•1: åŒ¹é… activityPlan: åé¢çš„æ‰€æœ‰å†…å®¹ç›´åˆ°ç»“æŸæˆ–ä¸‹ä¸€ä¸ªé¡¶çº§å±æ€§
      const looserRegex = /activityPlan:\s*($$[\s\S]*?)(?:\n\S+:|$)/;
      const match1 = yamlSection.match(looserRegex);
      
      if (match1 && match1[1]) {
        const jsonStr = match1[1].trim();
        console.log("æ–¹æ³•1æ‰¾åˆ°çš„å¯èƒ½JSONé•¿åº¦:", jsonStr.length);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„å¼€å§‹
        if (jsonStr.startsWith('[') && (jsonStr.endsWith(']') || jsonStr.includes(']'))) {
          // å¦‚æœJSONå­—ç¬¦ä¸²ä¸ä»¥]ç»“å°¾ï¼Œå°è¯•æŸ¥æ‰¾æœ€åçš„]
          let validJsonStr = jsonStr;
          if (!jsonStr.endsWith(']')) {
            const lastBracketPos = jsonStr.lastIndexOf(']');
            if (lastBracketPos > 0) {
              validJsonStr = jsonStr.substring(0, lastBracketPos + 1);
            } else {
              // æ²¡æœ‰æ‰¾åˆ°ç»“æŸæ‹¬å·ï¼Œå°è¯•æ·»åŠ 
              validJsonStr = jsonStr + ']';
            }
          }
          
          try {
            activityPlanData = JSON.parse(validJsonStr);
            console.log("æ–¹æ³•1æˆåŠŸè§£æJSONæ•°ç»„ï¼Œé•¿åº¦:", activityPlanData.length);
          } catch (parseErr) {
            console.error("æ–¹æ³•1è§£æJSONå¤±è´¥:", parseErr);
          }
        }
      }
    } catch (regexErr1) {
      console.error("æ–¹æ³•1æ­£åˆ™åŒ¹é…å¤±è´¥:", regexErr1);
    }
    
    // æ–¹æ³•2: æ›´ç²¾ç¡®çš„æ•°ç»„åŒ¹é…
    if (!activityPlanData) {
      try {
        const regex2 = /activityPlan:\s*(\[\s*[\s\S]*?\n\s*$$)/m;
        const match2 = yamlSection.match(regex2);
        
        if (match2 && match2[1]) {
          try {
            activityPlanData = JSON.parse(match2[1]);
            console.log("æ–¹æ³•2æˆåŠŸè§£æJSONæ•°ç»„ï¼Œé•¿åº¦:", activityPlanData.length);
          } catch (parseErr) {
            console.error("æ–¹æ³•2è§£æJSONå¤±è´¥:", parseErr);
          }
        }
      } catch (regexErr2) {
        console.error("æ–¹æ³•2æ­£åˆ™åŒ¹é…å¤±è´¥:", regexErr2);
      }
    }
    
    // æ–¹æ³•3: æ‰‹åŠ¨å¤„ç†YAMLæ–‡æœ¬
    if (!activityPlanData) {
      try {
        // æ‰¾åˆ°activityPlan:å¼€å§‹çš„ä½ç½®
        const startPos = yamlSection.indexOf('activityPlan:');
        if (startPos >= 0) {
          // ä»è¿™ä¸ªä½ç½®å¼€å§‹æŸ¥æ‰¾[
          const arrayStartPos = yamlSection.indexOf('[', startPos);
          if (arrayStartPos > 0) {
            // æ‰¾åˆ°å¯¹åº”çš„ç»“æŸæ‹¬å·
            let bracketCount = 1;
            let arrayEndPos = -1;
            
            for (let i = arrayStartPos + 1; i < yamlSection.length; i++) {
              if (yamlSection[i] === '[') bracketCount++;
              if (yamlSection[i] === ']') bracketCount--;
              
              if (bracketCount === 0) {
                arrayEndPos = i;
                break;
              }
            }
            
            if (arrayEndPos > arrayStartPos) {
              const jsonArrayStr = yamlSection.substring(arrayStartPos, arrayEndPos + 1);
              console.log("æ–¹æ³•3æå–çš„JSONé•¿åº¦:", jsonArrayStr.length);
              
              try {
                // æ¸…ç†æ ¼å¼
                const cleanedStr = jsonArrayStr
                  .replace(/\n\s*/g, ' ') // ç§»é™¤æ¢è¡Œå’Œå‰å¯¼ç©ºæ ¼
                  .trim();
                
                activityPlanData = JSON.parse(cleanedStr);
                console.log("æ–¹æ³•3æˆåŠŸè§£æJSONæ•°ç»„ï¼Œé•¿åº¦:", activityPlanData.length);
              } catch (parseErr) {
                console.error("æ–¹æ³•3è§£æJSONå¤±è´¥:", parseErr);
              }
            }
          }
        }
      } catch (err3) {
        console.error("æ–¹æ³•3å¤„ç†å¤±è´¥:", err3);
      }
    }
    
    // æ–¹æ³•4: å°è¯•ç›´æ¥ä»ç”¨æˆ·æä¾›çš„ç¤ºä¾‹ä¸­æŠ½å–
    if (!activityPlanData && yamlSection.includes('"project": "è®¡åˆ’å¼€å§‹"')) {
      try {
        // åœ¨YAMLä¸­ç›´æ¥æŸ¥æ‰¾ç¤ºä¾‹ä¸­çš„ç‰¹å®šæ ¼å¼
        const sampleStart = yamlSection.indexOf('"timestamp": "2025/05/15 01:29:02"');
        if (sampleStart > 0) {
          // å°è¯•å‘å‰æ‰¾åˆ°[
          let arrayStart = -1;
          for (let i = sampleStart; i >= 0; i--) {
            if (yamlSection[i] === '[') {
              arrayStart = i;
              break;
            }
          }
          
          if (arrayStart > 0) {
            // å‘åæ‰¾åˆ°å¯¹åº”çš„]
            let bracketCount = 1;
            let arrayEnd = -1;
            
            for (let i = arrayStart + 1; i < yamlSection.length; i++) {
              if (yamlSection[i] === '[') bracketCount++;
              if (yamlSection[i] === ']') bracketCount--;
              
              if (bracketCount === 0) {
                arrayEnd = i;
                break;
              }
            }
            
            if (arrayEnd > arrayStart) {
              const jsonArrayStr = yamlSection.substring(arrayStart, arrayEnd + 1);
              console.log("æ–¹æ³•4æå–çš„JSONé•¿åº¦:", jsonArrayStr.length);
              
              try {
                activityPlanData = JSON.parse(jsonArrayStr);
                console.log("æ–¹æ³•4æˆåŠŸè§£æJSONæ•°ç»„ï¼Œé•¿åº¦:", activityPlanData.length);
              } catch (parseErr) {
                console.error("æ–¹æ³•4è§£æJSONå¤±è´¥:", parseErr);
                
                // å°è¯•æ¸…ç†æ ¼å¼åå†è§£æ
                try {
                  const cleanedStr = jsonArrayStr
                    .replace(/\n\s*/g, ' ') // ç§»é™¤æ¢è¡Œå’Œå‰å¯¼ç©ºæ ¼
                    .trim();
                  
                  activityPlanData = JSON.parse(cleanedStr);
                  console.log("æ–¹æ³•4(æ¸…ç†å)æˆåŠŸè§£æJSONæ•°ç»„ï¼Œé•¿åº¦:", activityPlanData.length);
                } catch (cleanErr) {
                  console.error("æ–¹æ³•4(æ¸…ç†å)è§£æJSONå¤±è´¥:", cleanErr);
                }
              }
            }
          }
        }
      } catch (err4) {
        console.error("æ–¹æ³•4å¤„ç†å¤±è´¥:", err4);
      }
    }
    
    // æœ€åæ£€æŸ¥æ˜¯å¦æˆåŠŸæå–
    if (!activityPlanData || !Array.isArray(activityPlanData) || activityPlanData.length === 0) {
      // æ˜¾ç¤ºYAMLå†…å®¹çš„ä¸€éƒ¨åˆ†ç”¨äºè°ƒè¯•
      const yamlPreview = yamlSection.substring(0, Math.min(500, yamlSection.length)) + 
        (yamlSection.length > 500 ? '...' : '');
      console.error("æœªèƒ½è§£æactivityPlanæ•°ç»„ï¼ŒYAMLé¢„è§ˆ:", yamlPreview);
      
      throw new Error("æ— æ³•è§£æYAMLä¸­çš„activityPlanæ•°ç»„");
    }
    
    // å¤„ç†è§£æåçš„æ•°æ®
    const success = processActivityPlanData(activityPlanData);
    
    if (!success) {
      throw new Error("å¤„ç†æ´»åŠ¨è®¡åˆ’æ•°æ®å¤±è´¥");
    }
    
    return true;
  } catch (error) {
    console.error("ä»å¤‡ä»½æ¢å¤æ´»åŠ¨è®¡åˆ’å¤±è´¥:", error);
    
    // æ¢å¤å¤‡ä»½çŠ¶æ€
    if (backupPhase) {
      currentPhase = backupPhase;
    }
    lastUIState = backupUIState;
    
    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
    statusEl.innerHTML = '';
    statusEl.createEl("div", {
      text: "æ¢å¤å¤±è´¥: " + (error.message || "æœªçŸ¥é”™è¯¯"),
      attr: {style: "color: white; background-color: #d32f2f; padding: 8px; border-radius: 3px; margin: 10px 0;"}
    });
    
    // æ·»åŠ å¸®åŠ©ä¿¡æ¯
    const helpDiv = statusEl.createEl("div", {
      attr: {style: "margin-top: 8px; font-size: 0.9em; color: #555;"}
    });
    
    helpDiv.innerHTML = `
      <p>å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ³•:</p>
      <ul>
        <li>ç¡®è®¤å½“å‰æ–‡ä»¶æœ‰æ­£ç¡®çš„YAMLå‰ç½®æ•°æ®ï¼ŒåŒ…å«activityPlanæ•°ç»„</li>
        <li>æ£€æŸ¥YAMLæ ¼å¼æ˜¯å¦æ­£ç¡®</li>
        <li>åˆ·æ–°é¡µé¢åé‡è¯•</li>
        <li>å¦‚æœé—®é¢˜æŒç»­ï¼Œå°è¯•æ‰‹åŠ¨åˆ›å»ºæ–°çš„æ—¶é—´é˜¶æ®µ</li>
      </ul>
    `;
    
    // ç¡®ä¿UIä¸€è‡´
    restoreUIState();
    
    return false;
  }
}

// ================== â–²â–²â–² ADD THIS NEW FUNCTION â–²â–²â–² ==================
window.timePlannerDisplayIntervalId = window.timePlannerDisplayIntervalId || null; window.timePlannerDebounceSaveTimer = window.timePlannerDebounceSaveTimer || null;
function debouncedSave() {
  // Clear the previous timeout to reset the waiting period
  clearTimeout(window.timePlannerDebounceSaveTimer);

  // If a save is already happening, don't queue another one
  if (window.timePlannerIsSaving) return;

  // Set a new timeout with minimal delay for near-instant saving
  window.timePlannerDebounceSaveTimer = setTimeout(() => {
    console.log("Saving to JSON immediately.");
    saveCurrentStateJSON(); // ä½¿ç”¨ JSON å­˜å‚¨
  }, 100); // Nearly instant save with 100ms delay to batch rapid operations
}


window.timePlannerAutoSaveId = window.timePlannerAutoSaveId || null;


// è½¬æ¢å½“å‰é˜¶æ®µä¸ºæ´»åŠ¨è®¡åˆ’æ ¼å¼ï¼ˆå¢å¼ºç‰ˆï¼šåŒ…å« isStartTimeFixedï¼‰
function convertPhaseToActivityPlan(phase) {
  // æ·±æ‹·è´ä»¥é¿å…ç›´æ¥å¼•ç”¨
  const snapshot = JSON.parse(JSON.stringify(phase));

  // ç”Ÿæˆentriesæ•°ç»„ï¼ˆå†™å…¥åˆ° YAML çš„ activityPlanï¼‰
  const entries = [];

  // æ·»åŠ è®¡åˆ’å¼€å§‹æ ‡è®°
  const startTime = new Date(phase.startTime);
  entries.push({
    timestamp: formatDateForTimestamp(startTime),
    project: "è®¡åˆ’å¼€å§‹",
    status: "å¼€å§‹",
    duration: phase.plannedDuration
  });

  // æ·»åŠ æ¯ä¸ªæ´»åŠ¨çš„çŠ¶æ€
  phase.activities.forEach((activity) => {
    const entry = {
      // ä¼˜å…ˆä½¿ç”¨å®é™…å¼€å§‹æ—¶é—´ï¼Œå…¶æ¬¡é¢„è®¡å¼€å§‹æ—¶é—´ï¼Œæœ€åå›é€€åˆ°å½“å‰æ—¶é—´
      timestamp: activity.actualStart
        ? formatDateForTimestamp(new Date(activity.actualStart))
        : activity.expectedStart
        ? formatDateForTimestamp(new Date(activity.expectedStart))
        : formatDateForTimestamp(new Date()),
      project: activity.project,
      status: activity.status,
      expectedDuration: activity.expectedDuration,
      allocatedDuration: activity.allocatedDuration || activity.expectedDuration,
      experience: activity.experience || "æœªè®°å½•",
      rating: activity.rating || 3,
      // ä¿å­˜å®é™…ç»“æŸæ—¶é—´ï¼Œæœ‰åŠ©äºæ›´ç²¾ç¡®çš„æ¢å¤
      actualEnd: activity.actualEnd
        ? formatDateForTimestamp(new Date(activity.actualEnd))
        : null,
      // ä¿å­˜æœ€åè¯„ä»·æ—¶é—´ï¼Œç”¨äºæ£€æµ‹æœ€æ–°è¯„ä»·
      lastReviewTime: activity.lastReviewTime,
      // æ–°å¢ï¼šä¿å­˜â€œå¼€å§‹æ—¶é—´æ˜¯å¦å›ºå®šâ€çš„çŠ¶æ€ï¼Œç¡®ä¿æ¢å¤åèƒ½è¿˜åŸ
      isStartTimeFixed: !!activity.isStartTimeFixed
    };

    entries.push(entry);
  });

  return entries;
}


// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
function formatDuration(minutes) {
  if (minutes < 1) {
    return `${Math.max(0, Math.round(minutes * 60))}ç§’`;
  }
  if (minutes < 10) {
    return `${minutes.toFixed(1)}åˆ†é’Ÿ`;
  }
  if (minutes < 60) {
    return `${Math.round(minutes)}åˆ†é’Ÿ`;
  }
  const hours = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  return `${hours}å°æ—¶${mins > 0 ? ` ${mins}åˆ†é’Ÿ` : ''}`;
}

// æ ¼å¼åŒ–æ—¶é—´ç‚¹
function formatTime(date) {
  return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
}

// ç”Ÿæˆå”¯ä¸€ID
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// ç¡®ä¿æ‰§è¡Œé˜¶æ®µçš„å®æ—¶åˆ·æ–°è®¡æ—¶å™¨å­˜åœ¨
function ensureExecutionTicker() {
  if (window.timePlannerDisplayIntervalId) {
    clearInterval(window.timePlannerDisplayIntervalId);
  }
  window.timePlannerDisplayIntervalId = setInterval(updateExecutionDisplay, 1000);
}

// æ ¹æ®å¿ƒç†é¢„æœŸæ—¶é—´åˆ†é…å®é™…æ—¶é—´
function allocateTimeByExpectation() {
  if (!currentPhase) return;
  
  // è®¡ç®—æ€»å¿ƒç†é¢„æœŸæ—¶é—´
  let totalExpectedMinutes = 0;
  currentPhase.activities.forEach(activity => {
    totalExpectedMinutes += activity.expectedDuration;
  });
  
  currentPhase.totalExpectedDuration = totalExpectedMinutes;
  
  // å¦‚æœæ²¡æœ‰æ´»åŠ¨ï¼Œä¸éœ€è¦åˆ†é…
  if (totalExpectedMinutes === 0) return;
  
  // æŒ‰ç…§å¿ƒç†é¢„æœŸæ—¶é—´æ¯”ä¾‹åˆ†é…å®é™…æ—¶é—´
  const totalPlannedMinutes = currentPhase.plannedDuration;
  
  currentPhase.activities.forEach(activity => {
    const ratio = activity.expectedDuration / totalExpectedMinutes;
    activity.allocatedDuration = Math.round(totalPlannedMinutes * ratio);
  });
  
  // æ›´æ–°é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´ - è§„åˆ’é˜¶æ®µä¹Ÿè®¡ç®—é¢„è®¡æ—¶é—´
  calculateExpectedTimesForPlanning();
  
  // æ›´æ–°åˆ†é…ä¿¡æ¯
  updateAllocationSummary();
}

// æ›´æ–°åˆ†é…ä¿¡æ¯æ˜¾ç¤º
function updateAllocationSummary() {
  allocationSummary.innerHTML = '';
  
  if (!currentPhase || currentPhase.activities.length === 0) return;
  
  allocationSummary.createEl("h4", {text: "æ—¶é—´åˆ†é…æ±‡æ€»"});
  
  // æ€»è®¡åˆ’æ—¶é—´
  const totalPlan = allocationSummary.createEl("div", {cls: "summary-item"});
  totalPlan.createEl("span", {text: "æ€»è®¡åˆ’æ—¶é—´: "});
  totalPlan.createEl("strong", {text: formatDuration(currentPhase.plannedDuration)});
  
  // æ€»å¿ƒç†é¢„æœŸæ—¶é—´
  const totalExpected = allocationSummary.createEl("div", {cls: "summary-item"});
  totalExpected.createEl("span", {text: "æ€»å¿ƒç†é¢„æœŸæ—¶é—´: "});
  totalExpected.createEl("strong", {text: formatDuration(currentPhase.totalExpectedDuration)});
  
  // åˆ†é…ç³»æ•°
  const factor = currentPhase.plannedDuration / currentPhase.totalExpectedDuration;
  const factorText = factor < 1 ? "å‹ç¼©" : "æ‰©å±•";
  const factorDisplay = allocationSummary.createEl("div", {cls: "summary-item"});
  factorDisplay.createEl("span", {text: `æ—¶é—´${factorText}ç³»æ•°: `});
  factorDisplay.createEl("strong", {text: factor.toFixed(2)});
  factorDisplay.createEl("span", {text: ` (æ¯1åˆ†é’Ÿå¿ƒç†é¢„æœŸåˆ†é…${factor.toFixed(2)}åˆ†é’Ÿå®é™…æ—¶é—´)`});
}

// è®¡ç®—è§„åˆ’é˜¶æ®µçš„é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´
// ä¿®æ”¹calculateExpectedTimesForPlanningå‡½æ•°
function calculateExpectedTimesForPlanning() {
  if (!currentPhase || currentPhase.status !== 'planning' || !currentPhase.activities || currentPhase.activities.length === 0) {
    return;
  }
  
  let currentTime = new Date(currentPhase.startTime);
  
  // é¦–å…ˆå¤„ç†å·²å›ºå®šå¼€å§‹æ—¶é—´çš„æ´»åŠ¨
  const fixedActivities = currentPhase.activities.filter(a => a.isStartTimeFixed);
  const unfixedActivities = currentPhase.activities.filter(a => !a.isStartTimeFixed);
  
  // æŒ‰ç´¢å¼•æ’åºæ‰€æœ‰æ´»åŠ¨
  const allActivities = [...currentPhase.activities];
  const activityIndices = {};
  allActivities.forEach((a, idx) => {
    activityIndices[a.id] = idx;
  });
  
  // ä¸ºå·²å›ºå®šå¼€å§‹æ—¶é—´çš„æ´»åŠ¨è®¾ç½®é¢„æœŸç»“æŸæ—¶é—´
  fixedActivities.forEach(activity => {
    // å¦‚æœå·²æœ‰expectedStartï¼Œåˆ™ä½¿ç”¨å®ƒï¼Œå¦åˆ™è®¾ç½®ä¸ºå½“å‰æ—¶é—´ç‚¹
    if (!activity.expectedStart) {
      activity.expectedStart = new Date(currentTime);
    }
    
    // è®¡ç®—é¢„æœŸç»“æŸæ—¶é—´
    const allocatedTime = activity.allocatedDuration || activity.expectedDuration;
    activity.expectedEnd = new Date(activity.expectedStart.getTime() + allocatedTime * 60 * 1000);
  });
  
  // æŒ‰æ´»åŠ¨ç´¢å¼•é¡ºåºåˆ›å»ºæ—¶é—´æ®µ
  let timeSegments = [];
  
  if (fixedActivities.length === 0) {
    // æ²¡æœ‰å›ºå®šæ´»åŠ¨ï¼Œæ•´ä¸ªè®¡åˆ’æ˜¯ä¸€ä¸ªæ—¶é—´æ®µ
    timeSegments.push({
      startTime: new Date(currentPhase.startTime),
      endTime: null, // ç»“æŸæ—¶é—´ä¼šæ ¹æ®æ€»æ—¶é•¿åŠ¨æ€è®¡ç®—
      activities: unfixedActivities
    });
  } else {
    // æœ‰å›ºå®šæ´»åŠ¨ï¼Œéœ€è¦åˆ†æ®µ
    
    // æŒ‰ç´¢å¼•æ’åºå›ºå®šæ´»åŠ¨
    fixedActivities.sort((a, b) => activityIndices[a.id] - activityIndices[b.id]);
    
    // åˆ›å»ºæ—¶é—´æ®µ
    let lastEndTime = new Date(currentPhase.startTime);
    let lastIndex = -1;
    
    for (const fixedActivity of fixedActivities) {
      const currentIndex = activityIndices[fixedActivity.id];
      
      // è·å–ä¸¤ä¸ªå›ºå®šæ´»åŠ¨ä¹‹é—´çš„æœªå›ºå®šæ´»åŠ¨
      const activitiesBetween = unfixedActivities.filter(a => {
        const aIndex = activityIndices[a.id];
        return aIndex > lastIndex && aIndex < currentIndex;
      });
      
      // å¦‚æœæœ‰æœªå›ºå®šæ´»åŠ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ—¶é—´æ®µ
      if (activitiesBetween.length > 0) {
        timeSegments.push({
          startTime: new Date(lastEndTime),
          endTime: new Date(fixedActivity.expectedStart),
          activities: activitiesBetween
        });
      }
      
      lastEndTime = new Date(fixedActivity.expectedEnd);
      lastIndex = currentIndex;
    }
    
    // å¤„ç†æœ€åä¸€ä¸ªå›ºå®šæ´»åŠ¨ä¹‹åçš„æ´»åŠ¨
    const remainingActivities = unfixedActivities.filter(a => 
      activityIndices[a.id] > lastIndex
    );
    
    if (remainingActivities.length > 0) {
      timeSegments.push({
        startTime: new Date(lastEndTime),
        endTime: null,
        activities: remainingActivities
      });
    }
  }
  
  // è®¡ç®—è®¡åˆ’çš„æ€»ç»“æŸæ—¶é—´
  const plannedEndTime = new Date(currentPhase.startTime);
  plannedEndTime.setMinutes(plannedEndTime.getMinutes() + currentPhase.plannedDuration);
  
  // ä¸ºæ¯ä¸ªæ—¶é—´æ®µå†…çš„æ´»åŠ¨åˆ†é…æ—¶é—´
  timeSegments.forEach((segment, segmentIndex) => {
    // è®¡ç®—è¿™ä¸ªæ—¶é—´æ®µçš„æŒç»­æ—¶é—´
    let segmentDuration;
    
    if (segment.endTime) {
      // å¦‚æœæœ‰å›ºå®šç»“æŸæ—¶é—´ï¼Œè®¡ç®—æ®µæŒç»­æ—¶é—´
      segmentDuration = (segment.endTime - segment.startTime) / (60 * 1000);
    } else {
      // æœ€åä¸€æ®µçš„ç»“æŸæ—¶é—´æ˜¯è®¡åˆ’ç»“æŸæ—¶é—´
      segment.endTime = plannedEndTime;
      segmentDuration = (segment.endTime - segment.startTime) / (60 * 1000);
    }
    
    // è®¡ç®—è¿™ä¸ªæ®µå†…æ‰€æœ‰æ´»åŠ¨çš„æ€»å¿ƒç†é¢„æœŸ
    const totalExpectedInSegment = segment.activities.reduce(
      (sum, activity) => sum + (activity.expectedDuration || 0), 0
    );
    
    let currentSegmentTime = new Date(segment.startTime);
    
    // ä¸ºæ®µå†…çš„æ¯ä¸ªæ´»åŠ¨åˆ†é…æ—¶é—´
    segment.activities.forEach(activity => {
      activity.expectedStart = new Date(currentSegmentTime);
      
      // æ ¹æ®å¿ƒç†é¢„æœŸæ¯”ä¾‹åˆ†é…æ—¶é—´
      let allocatedTime;
      if (totalExpectedInSegment > 0) {
        const ratio = activity.expectedDuration / totalExpectedInSegment;
        allocatedTime = segmentDuration * ratio;
        activity.allocatedDuration = allocatedTime;
      } else {
        allocatedTime = activity.expectedDuration;
        activity.allocatedDuration = allocatedTime;
      }
      
      // è®¡ç®—é¢„æœŸç»“æŸæ—¶é—´
      activity.expectedEnd = new Date(currentSegmentTime.getTime() + allocatedTime * 60 * 1000);
      
      // æ›´æ–°å½“å‰æ—¶é—´ç‚¹
      currentSegmentTime = new Date(activity.expectedEnd);
    });
  });
  
  // æŒ‰åŸå§‹é¡ºåºé‡æ–°è®¾ç½®æ‰€æœ‰æ´»åŠ¨
  currentPhase.activities.sort((a, b) => activityIndices[a.id] - activityIndices[b.id]);
}

// è®¡ç®—æ‰§è¡Œé˜¶æ®µçš„é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´
// è®¡ç®—æ‰§è¡Œé˜¶æ®µçš„é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´ - æ”¯æŒå›ºå®šå¼€å§‹æ—¶é—´
// è®¡ç®—æ‰§è¡Œé˜¶æ®µçš„é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´ - æ”¯æŒå›ºå®šå¼€å§‹æ—¶é—´ (ä¿®å¤)
// è®¡ç®—æ‰§è¡Œé˜¶æ®µçš„é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´ - æ”¹è¿›ç‰ˆæœ¬
// è®¡ç®—æ‰§è¡Œé˜¶æ®µçš„é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´ - æœ€ç»ˆä¿®æ­£ç‰ˆ
function calculateExpectedTimes() {
  if (!currentPhase || currentPhase.status !== 'active' || !currentPhase.activities || currentPhase.activities.length === 0) {
    return;
  }
  
  // è®¡åˆ’ç»“æŸæ—¶é—´
  const plannedEndTime = new Date(currentPhase.startTime);
  plannedEndTime.setMinutes(plannedEndTime.getMinutes() + currentPhase.plannedDuration);
  
  // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„æ´»åŠ¨çš„ç´¢å¼•
  const firstPendingIndex = currentPhase.activities.findIndex(a => a.status !== 'completed');
  
  // å¦‚æœæ‰€æœ‰æ´»åŠ¨éƒ½å·²å®Œæˆæˆ–æ²¡æœ‰æ´»åŠ¨ï¼Œè¿”å›
  if (firstPendingIndex === -1) return;
  
  // æŒ‰åŸå§‹ç´¢å¼•è®°å½•æ‰€æœ‰æ´»åŠ¨
  const activityIndices = {};
  currentPhase.activities.forEach((a, idx) => {
    activityIndices[a.id] = idx;
  });
  
  // è·å–æ‰€æœ‰æ—¶é—´ç‚¹
  let timePoints = [];
  
  // æ·»åŠ å½“å‰æ—¶é—´ç‚¹
  let currentTime;
  if (firstPendingIndex > 0) {
    // ä½¿ç”¨æœ€åä¸€ä¸ªå·²å®Œæˆæ´»åŠ¨çš„ç»“æŸæ—¶é—´
    const lastCompletedActivity = currentPhase.activities[firstPendingIndex - 1];
    currentTime = new Date(lastCompletedActivity.actualEnd);
  } else {
    // ä½¿ç”¨è®¡åˆ’å¼€å§‹æ—¶é—´
    currentTime = new Date(currentPhase.startTime);
  }
  
  // æ·»åŠ å½“å‰æ—¶é—´ä½œä¸ºç¬¬ä¸€ä¸ªæ—¶é—´ç‚¹
  timePoints.push({
    time: new Date(currentTime),
    type: 'current',
    activityId: null
  });
  
  // å¤„ç†è¿›è¡Œä¸­çš„æ´»åŠ¨
  const inProgressActivity = currentPhase.activities.find(a => a.status === 'in-progress');
  if (inProgressActivity) {
    // è®¾ç½®è¿›è¡Œä¸­æ´»åŠ¨çš„é¢„æœŸå¼€å§‹æ—¶é—´ä¸ºå®é™…å¼€å§‹æ—¶é—´
    inProgressActivity.expectedStart = new Date(inProgressActivity.actualStart);
    
    const now = new Date();
    const elapsedTime = (now - new Date(inProgressActivity.actualStart)) / (60 * 1000);
    const allocatedTime = inProgressActivity.allocatedDuration || inProgressActivity.expectedDuration;
    const remainingTime = Math.max(0, allocatedTime - elapsedTime);
    
    // è®¾ç½®é¢„æœŸç»“æŸæ—¶é—´
    const expectedEnd = new Date(now.getTime() + remainingTime * 60 * 1000);
    inProgressActivity.expectedEnd = expectedEnd;
    
    // æ·»åŠ è¿›è¡Œä¸­æ´»åŠ¨ç»“æŸæ—¶é—´ä½œä¸ºæ—¶é—´ç‚¹
    timePoints.push({
      time: new Date(expectedEnd),
      type: 'in-progress-end',
      activityId: inProgressActivity.id,
      activity: inProgressActivity
    });
    
    // æ›´æ–°å½“å‰æ—¶é—´
    currentTime = new Date(expectedEnd);
  }
  
  // æ”¶é›†æ‰€æœ‰å›ºå®šå¼€å§‹æ—¶é—´çš„æœªå®Œæˆæ´»åŠ¨
  const fixedStartActivities = currentPhase.activities.filter(a => 
    a.isStartTimeFixed && 
    (a.status === 'pending' || (a.status === 'in-progress' && !a.expectedStart))
  );
  
  // æ·»åŠ å›ºå®šå¼€å§‹æ—¶é—´ç‚¹ï¼ˆæŒ‰åŸå§‹é¡ºåºæ’åºï¼‰
  fixedStartActivities.sort((a, b) => activityIndices[a.id] - activityIndices[b.id]);
  
  fixedStartActivities.forEach(activity => {
    if (!activity.expectedStart) {
      // å¦‚æœæ²¡æœ‰é¢„è®¾å¼€å§‹æ—¶é—´ä½†æ ‡è®°ä¸ºå›ºå®šï¼Œè®¾ç½®ä¸ºå½“å‰æ—¶é—´ç‚¹ä¹‹å
      activity.expectedStart = new Date(currentTime);
    }
    
    // ç¡®ä¿å›ºå®šå¼€å§‹æ—¶é—´ä¸æ—©äºå½“å‰æ—¶é—´ç‚¹
    if (activity.expectedStart < currentTime) {
      activity.expectedStart = new Date(currentTime);
    }
    
    timePoints.push({
      time: new Date(activity.expectedStart),
      type: 'fixed-start',
      activityId: activity.id,
      activity: activity
    });
  });
  
  // æ·»åŠ è®¡åˆ’ç»“æŸæ—¶é—´ç‚¹
  timePoints.push({
    time: new Date(plannedEndTime),
    type: 'plan-end',
    activityId: null
  });
  
  // æŒ‰æ—¶é—´æ’åºæ‰€æœ‰æ—¶é—´ç‚¹
  timePoints.sort((a, b) => a.time - b.time);
  
  // ä¸ºæ¯ä¸ªæ—¶é—´æ®µåˆ†é…æ´»åŠ¨
  const timeSegments = [];
  
  for (let i = 0; i < timePoints.length - 1; i++) {
    const startPoint = timePoints[i];
    const endPoint = timePoints[i + 1];
    
    // è·³è¿‡é•¿åº¦ä¸º0çš„æ—¶é—´æ®µ
    if (startPoint.time.getTime() === endPoint.time.getTime()) continue;
    
    // è·å–æ—¶é—´æ®µä¸­åº”åŒ…å«çš„æ´»åŠ¨ï¼ˆç‰¹æ®Šå¤„ç†ç¬¬ä¸€ä¸ªæ—¶é—´æ®µï¼‰
    let activitiesInSegment = [];
    
    if (i === 0 && startPoint.type === 'current') {
      // ç¬¬ä¸€ä¸ªæ—¶é—´æ®µçš„ç‰¹æ®Šå¤„ç†ï¼šè·å–ä»å¼€å§‹åˆ°ç¬¬ä¸€ä¸ªå›ºå®šç‚¹ä¹‹é—´çš„æ‰€æœ‰æœªå®Œæˆã€æœªå›ºå®šæ´»åŠ¨
      const endIndex = endPoint.type === 'fixed-start' ? 
                       activityIndices[endPoint.activityId] : 
                       currentPhase.activities.length;
      
      for (let j = firstPendingIndex; j < endIndex; j++) {
        const activity = currentPhase.activities[j];
        if (activity && activity.status === 'pending' && !activity.isStartTimeFixed) {
          activitiesInSegment.push(activity);
        }
      }
      
      // å¦‚æœå½“å‰æœ‰è¿›è¡Œä¸­æ´»åŠ¨ï¼Œè·³è¿‡å®ƒ
      if (inProgressActivity) {
        activitiesInSegment = activitiesInSegment.filter(a => a.id !== inProgressActivity.id);
      }
    } else if (startPoint.type === 'fixed-start' || startPoint.type === 'in-progress-end') {
      // å…¶ä»–æ—¶é—´æ®µï¼šæ·»åŠ å¼€å§‹ç‚¹å¯¹åº”çš„æ´»åŠ¨ï¼ˆå¦‚æœæ˜¯å›ºå®šå¼€å§‹ç‚¹ï¼‰
      if (startPoint.type === 'fixed-start') {
        activitiesInSegment.push(startPoint.activity);
      }
      
      // æ‰¾å‡ºè¿™ä¸ªå›ºå®šç‚¹ä¹‹åã€ä¸‹ä¸€ä¸ªå›ºå®šç‚¹ä¹‹å‰çš„æœªå®Œæˆã€æœªå›ºå®šæ´»åŠ¨
      const startIndex = startPoint.activityId ? 
                        activityIndices[startPoint.activityId] + 1 : 
                        (inProgressActivity ? activityIndices[inProgressActivity.id] + 1 : 0);
      
      const endIndex = endPoint.type === 'fixed-start' ? 
                       activityIndices[endPoint.activityId] : 
                       currentPhase.activities.length;
      
      for (let j = startIndex; j < endIndex; j++) {
        const activity = currentPhase.activities[j];
        if (activity && activity.status === 'pending' && !activity.isStartTimeFixed) {
          activitiesInSegment.push(activity);
        }
      }
    }
    
    // æ·»åŠ æ—¶é—´æ®µ
    timeSegments.push({
      startTime: new Date(startPoint.time),
      endTime: new Date(endPoint.time),
      startPoint: startPoint,
      endPoint: endPoint,
      activities: activitiesInSegment
    });
  }
  
  // ä¸ºæ¯ä¸ªæ—¶é—´æ®µåˆ†é…æ—¶é—´
  timeSegments.forEach(segment => {
    const segmentDuration = (segment.endTime - segment.startTime) / (60 * 1000);
    
    // å¦‚æœæ®µæŒç»­æ—¶é—´è¿‡çŸ­ï¼Œè·³è¿‡
    if (segmentDuration < 0.1) return;
    
    // è®¡ç®—è¿™ä¸ªæ®µå†…æ‰€æœ‰æ´»åŠ¨çš„æ€»å¿ƒç†é¢„æœŸ
    const totalExpectedInSegment = segment.activities.reduce(
      (sum, activity) => sum + (activity.expectedDuration || 0), 0
    );
    
    // æŒ‰åŸå§‹é¡ºåºæ’åºæ´»åŠ¨
    segment.activities.sort((a, b) => activityIndices[a.id] - activityIndices[b.id]);
    
    let currentSegmentTime = new Date(segment.startTime);
    
    // ä¸ºæ®µå†…çš„æ¯ä¸ªæ´»åŠ¨åˆ†é…æ—¶é—´
    segment.activities.forEach((activity, index) => {
      // è®¾ç½®é¢„æœŸå¼€å§‹æ—¶é—´ï¼ˆå¦‚æœä¸æ˜¯å›ºå®šå¼€å§‹æ—¶é—´çš„æ´»åŠ¨ï¼Œæˆ–æ˜¯è¯¥æ®µçš„å¼€å§‹å›ºå®šæ´»åŠ¨ï¼‰
      if (!activity.isStartTimeFixed || 
          (segment.startPoint.type === 'fixed-start' && segment.startPoint.activityId === activity.id)) {
        activity.expectedStart = new Date(currentSegmentTime);
      }
      
      // æ ¹æ®å¿ƒç†é¢„æœŸæ¯”ä¾‹åˆ†é…æ—¶é—´
      let allocatedTime;
      if (totalExpectedInSegment > 0) {
        // æŒ‰å¿ƒç†é¢„æœŸæ¯”ä¾‹åˆ†é…
        const ratio = activity.expectedDuration / totalExpectedInSegment;
        allocatedTime = segmentDuration * ratio;
      } else {
        // å¦‚æœæ²¡æœ‰é¢„æœŸæ—¶é—´ï¼Œå¹³å‡åˆ†é…
        allocatedTime = segmentDuration / segment.activities.length;
      }
      
      // ä¿å­˜åˆ†é…çš„æ—¶é—´
      activity.allocatedDuration = allocatedTime;
      
      // æœ€åä¸€ä¸ªæ´»åŠ¨ç‰¹æ®Šå¤„ç†
      if (index === segment.activities.length - 1) {
        const expectedEnd = new Date(currentSegmentTime.getTime() + allocatedTime * 60 * 1000);
        if (expectedEnd > segment.endTime) {
          allocatedTime = (segment.endTime - currentSegmentTime) / (60 * 1000);
          activity.allocatedDuration = Math.max(0, allocatedTime);
        }
      }
      
      // è®¡ç®—é¢„æœŸç»“æŸæ—¶é—´
      activity.expectedEnd = new Date(currentSegmentTime.getTime() + allocatedTime * 60 * 1000);
      
      // æ›´æ–°æ®µå†…çš„å½“å‰æ—¶é—´
      currentSegmentTime = new Date(activity.expectedEnd);
    });
  });
}

// ä¸ºæ—¶é—´æ®µåˆ†é…æ—¶é—´ï¼ˆç‹¬ç«‹å‡½æ•°ï¼Œä¾¿äºå¤ç”¨ï¼‰
function allocateTimeForSegments(timeSegments, activityIndices) {
  timeSegments.forEach(segment => {
    const segmentDuration = (segment.endTime - segment.startTime) / (60 * 1000);
    
    // å¦‚æœæ®µæŒç»­æ—¶é—´è¿‡çŸ­ï¼Œè·³è¿‡
    if (segmentDuration < 0.1) return;
    
    // è®¡ç®—è¿™ä¸ªæ®µå†…æ‰€æœ‰æ´»åŠ¨çš„æ€»å¿ƒç†é¢„æœŸ
    const totalExpectedInSegment = segment.activities.reduce(
      (sum, activity) => sum + (activity.expectedDuration || 0), 0
    );
    
    // æŒ‰åŸå§‹é¡ºåºæ’åºæ´»åŠ¨
    segment.activities.sort((a, b) => activityIndices[a.id] - activityIndices[b.id]);
    
    let currentSegmentTime = new Date(segment.startTime);
    
    // ä¸ºæ®µå†…çš„æ¯ä¸ªæ´»åŠ¨åˆ†é…æ—¶é—´
    segment.activities.forEach((activity, index) => {
      // è®¾ç½®é¢„æœŸå¼€å§‹æ—¶é—´ï¼ˆå¦‚æœä¸æ˜¯å›ºå®šå¼€å§‹æ—¶é—´çš„æ´»åŠ¨ï¼‰
      if (!activity.isStartTimeFixed || segment.startPoint.activityId === activity.id) {
        activity.expectedStart = new Date(currentSegmentTime);
      }
      
      // æ ¹æ®å¿ƒç†é¢„æœŸæ¯”ä¾‹åˆ†é…æ—¶é—´
      let allocatedTime;
      if (totalExpectedInSegment > 0) {
        // æŒ‰å¿ƒç†é¢„æœŸæ¯”ä¾‹åˆ†é…
        const ratio = activity.expectedDuration / totalExpectedInSegment;
        allocatedTime = segmentDuration * ratio;
      } else {
        // å¦‚æœæ²¡æœ‰é¢„æœŸæ—¶é—´ï¼Œå¹³å‡åˆ†é…
        allocatedTime = segmentDuration / segment.activities.length;
      }
      
      // ä¿å­˜åˆ†é…çš„æ—¶é—´
      activity.allocatedDuration = allocatedTime;
      
      // æœ€åä¸€ä¸ªæ´»åŠ¨ç‰¹æ®Šå¤„ç†
      if (index === segment.activities.length - 1) {
        const expectedEnd = new Date(currentSegmentTime.getTime() + allocatedTime * 60 * 1000);
        if (expectedEnd > segment.endTime) {
          allocatedTime = (segment.endTime - currentSegmentTime) / (60 * 1000);
          activity.allocatedDuration = Math.max(0, allocatedTime);
        }
      }
      
      // è®¡ç®—é¢„æœŸç»“æŸæ—¶é—´
      activity.expectedEnd = new Date(currentSegmentTime.getTime() + allocatedTime * 60 * 1000);
      
      // æ›´æ–°æ®µå†…çš„å½“å‰æ—¶é—´
      currentSegmentTime = new Date(activity.expectedEnd);
    });
  });
}

// ============================================================
// ğŸ“Š æ—¶é—´åˆ†é…ç®—æ³• - åˆ†æ®µç¼©æ”¾ç‰ˆ
// æ ¸å¿ƒé€»è¾‘ï¼š
// 1) ä»¥å›ºå®šå¼€å§‹æ—¶é—´ä¸ºé”šï¼ŒæŠŠæ‰§è¡Œé˜¶æ®µåˆ‡æˆå¤šä¸ªæ—¶é—´æ®µï¼›
// 2) æ¯æ®µå†…çš„(è¿›è¡Œä¸­ + å¾…åŠ)æŒ‰ç…§å¿ƒç†é¢„æœŸæ¯”ä¾‹åˆ†é…è¯¥æ®µæ—¶é—´ï¼›
// 3) å½“å‰è¿›è¡Œä¸­çš„æ´»åŠ¨ä½¿ç”¨â€œå®é™…å¼€å§‹æ—¶é—´â€ä½œä¸ºæ®µèµ·ç‚¹ï¼Œè€Œä¸æ˜¯é¢„ä¼°ç»“æŸæ—¶é—´ã€‚
// ============================================================

function allocateRemainingTime() {
  if (!currentPhase || currentPhase.status !== 'active') return;

  const now = new Date();
  const activities = currentPhase.activities;

  // è®¡åˆ’ç»“æŸæ—¶é—´
  const plannedEndTime = new Date(currentPhase.startTime);
  plannedEndTime.setMinutes(plannedEndTime.getMinutes() + currentPhase.plannedDuration);

  // æ‰¾å‡ºè¿›è¡Œä¸­ä¸é¦–ä¸ªå¾…åŠçš„ç´¢å¼•
  const inProgressIdx = activities.findIndex(a => a.status === 'in-progress');
  const firstPendingIdx = activities.findIndex(a => a.status === 'pending');
  const startIdx = inProgressIdx >= 0 ? inProgressIdx : firstPendingIdx;
  if (startIdx === -1) return; // æ²¡æœ‰éœ€è¦åˆ†é…çš„æ´»åŠ¨

  // æ®µèµ·ç‚¹ï¼šè¿›è¡Œä¸­ç”¨ actualStartï¼Œå¦åˆ™ç”¨è®¡åˆ’å¼€å§‹/ä¸Šä¸€å·²å®Œæˆç»“æŸ
  let currentTime;
  if (inProgressIdx >= 0) {
    currentTime = new Date(activities[inProgressIdx].actualStart || now);
  } else if (startIdx > 0 && activities[startIdx - 1].actualEnd) {
    currentTime = new Date(activities[startIdx - 1].actualEnd);
  } else {
    currentTime = new Date(currentPhase.startTime);
  }

  // æ„å»ºæœªæ¥å›ºå®šé”šç‚¹ï¼ˆåªçœ‹æœªå®Œæˆçš„å›ºå®šæ´»åŠ¨ï¼‰
  const futureAnchors = activities
    .map((a, idx) => ({ idx, time: a.expectedStart ? new Date(a.expectedStart) : null, activity: a }))
    .filter(item => item.activity.isStartTimeFixed && item.activity.status !== 'completed' && item.time)
    .filter(item => item.time >= currentTime)
    .sort((a, b) => a.time - b.time);

  let anchorPos = 0;
  let nextAnchor = futureAnchors[anchorPos];
  let nextAnchorTime = nextAnchor ? nextAnchor.time : plannedEndTime;

  let cursor = startIdx;

  // æŒ‰æ®µåˆ†é…ç›´åˆ°è€—å°½æ´»åŠ¨æˆ–åˆ°è¾¾è®¡åˆ’ç»“æŸ
  while (cursor < activities.length && currentTime < plannedEndTime) {
    const segmentActivities = [];

    // æ”¶é›†æœ¬æ®µå†…çš„æ´»åŠ¨ï¼šä» cursor å¼€å§‹ç›´åˆ°ä¸‹ä¸€ä¸ªé”šç‚¹çš„æ´»åŠ¨ï¼ˆä¸åŒ…å«é”šç‚¹æ´»åŠ¨æœ¬èº«ï¼‰
    while (cursor < activities.length && (!nextAnchor || cursor < nextAnchor.idx)) {
      const act = activities[cursor];
      if (act.status !== 'completed') segmentActivities.push(act);
      cursor++;
    }

    // è‹¥å½“å‰é”šç‚¹æ˜¯è¿›è¡Œä¸­æ´»åŠ¨æœ¬èº«ï¼Œåº”è®©å®ƒå‚ä¸å½“å‰æ®µ
    if (nextAnchor && cursor === nextAnchor.idx && nextAnchor.activity.status === 'in-progress') {
      segmentActivities.push(nextAnchor.activity);
      cursor++;
      anchorPos++;
      nextAnchor = futureAnchors[anchorPos];
      nextAnchorTime = nextAnchor ? nextAnchor.time : plannedEndTime;
    }

    const segmentEnd = nextAnchor ? nextAnchorTime : plannedEndTime;
    const segmentMinutes = Math.max(0, (segmentEnd - currentTime) / (60 * 1000));

    // æ€»å¿ƒç†é¢„æœŸï¼ˆè¿›è¡Œä¸­æŒ‰å¿ƒç†é¢„æœŸè®¡å…¥æ¯”ä¾‹ï¼‰
    const totalExpected = segmentActivities.reduce((sum, a) => sum + (a.expectedDuration || 0), 0);

    // è‹¥æ²¡æœ‰æ—¶é—´æˆ–æ²¡æœ‰æ´»åŠ¨ï¼Œç›´æ¥è·³åˆ°ä¸‹ä¸€é”šç‚¹
    if (segmentMinutes <= 0 || totalExpected === 0) {
      currentTime = new Date(segmentEnd);
      if (nextAnchor && currentTime >= nextAnchorTime) {
        anchorPos++;
        nextAnchor = futureAnchors[anchorPos];
        nextAnchorTime = nextAnchor ? nextAnchor.time : plannedEndTime;
      }
      continue;
    }

    // æŒ‰æ¯”ä¾‹åˆ†é…æœ¬æ®µæ—¶é—´
    let timeCursor = new Date(currentTime);
    segmentActivities.forEach(act => {
      // æ®µå†…æ¯”ä¾‹
      let alloc = segmentMinutes * ((act.expectedDuration || 0) / totalExpected);

      // å¯¹è¿›è¡Œä¸­ï¼šè‡³å°‘è¦†ç›–å·²è€—æ—¶é—´ï¼Œé¿å…è´Ÿå‰©ä½™
      if (act.status === 'in-progress') {
        const elapsed = (now - new Date(act.actualStart || now)) / (60 * 1000);
        alloc = Math.max(alloc, elapsed);
      }

      act.allocatedDuration = alloc;
      act.expectedStart = act.status === 'in-progress'
        ? new Date(act.actualStart || timeCursor)
        : new Date(timeCursor);

      timeCursor = new Date(act.expectedStart.getTime() + alloc * 60 * 1000);
      act.expectedEnd = new Date(timeCursor);
    });

    // æ®µç»“æŸå¯¹é½åˆ°é”šç‚¹
    currentTime = new Date(segmentEnd);

    // è¿›å…¥ä¸‹ä¸€é”šç‚¹
    if (nextAnchor && currentTime >= nextAnchorTime) {
      anchorPos++;
      nextAnchor = futureAnchors[anchorPos];
      nextAnchorTime = nextAnchor ? nextAnchor.time : plannedEndTime;
    }
  }

  // è‹¥è¿˜æœ‰å‰©ä½™å¾…åŠä¸”æ²¡æœ‰é”šç‚¹ï¼Œåˆ†é…è‡³è®¡åˆ’ç»“æŸ
  if (cursor < activities.length && currentTime < plannedEndTime) {
    const tailActivities = activities.slice(cursor).filter(a => a.status !== 'completed');
    const tailMinutes = Math.max(0, (plannedEndTime - currentTime) / (60 * 1000));
    const tailExpected = tailActivities.reduce((s, a) => s + (a.expectedDuration || 0), 0);

    if (tailMinutes > 0 && tailExpected > 0) {
      let timeCursor = new Date(currentTime);
      tailActivities.forEach(act => {
        const alloc = tailMinutes * ((act.expectedDuration || 0) / tailExpected);
        act.allocatedDuration = alloc;
        act.expectedStart = new Date(timeCursor);
        timeCursor = new Date(timeCursor.getTime() + alloc * 60 * 1000);
        act.expectedEnd = new Date(timeCursor);
      });
    }
  }

  // ä½¿ç”¨é¡ºåºé‡ç®— expectedStart/expectedEndï¼Œç¡®ä¿é”šç‚¹ä¸åˆ†é…åŒæ­¥
  recalculateExpectedTimes();

  renderExecutionList();
  debouncedSave();
}

// é¡ºåºé‡ç®—é¢„è®¡æ—¶é—´ï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰
// è¦ç‚¹ï¼š
// - ä»è¿›è¡Œä¸­æ´»åŠ¨çš„ actualStart ä½œä¸ºæ—¶é—´è½´èµ·ç‚¹ï¼›
// - é‡åˆ°å›ºå®šå¼€å§‹æ—¶é—´æ´»åŠ¨ï¼Œå¼ºåˆ¶å¯¹é½åˆ°å…¶ expectedStartï¼›
// - ä¿æŒåŸæœ‰é¡ºåºï¼Œä¸å†æŠŠå›ºå®šæ´»åŠ¨æå‰æ’åºï¼Œé¿å…æ®µé”™ä½ã€‚
function recalculateExpectedTimes() {
  if (!currentPhase) return;

  const activities = currentPhase.activities;
  let currentTime = new Date(currentPhase.startTime);

  // æ—¶é—´è½´èµ·ç‚¹
  const inProgressIdx = activities.findIndex(a => a.status === 'in-progress');
  if (inProgressIdx >= 0) {
    currentTime = new Date(activities[inProgressIdx].actualStart || currentTime);
  }

  for (let i = 0; i < activities.length; i++) {
    const act = activities[i];
    if (act.status === 'completed') continue;

    // å›ºå®šå¼€å§‹æ—¶é—´å¯¹é½
    if (act.isStartTimeFixed && act.expectedStart) {
      currentTime = new Date(act.expectedStart);
    }

    // è¿›è¡Œä¸­æ´»åŠ¨ä¿æŒå®é™…å¼€å§‹
    act.expectedStart = act.status === 'in-progress'
      ? new Date(act.actualStart || currentTime)
      : new Date(currentTime);

    const duration = act.allocatedDuration || act.expectedDuration || 0;
    currentTime = new Date(act.expectedStart.getTime() + duration * 60 * 1000);
    act.expectedEnd = new Date(currentTime);
  }
}

// è®¡ç®—æ‰§è¡Œé˜¶æ®µçš„é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´ - å¢å¼ºç‰ˆï¼šæ”¯æŒæ—¶é—´å¯¹é½


// ============================================================
// ğŸ¨ æ‹–æ‹½åŠŸèƒ½ - å‚è€ƒ GTD å¾…åŠäº‹é¡¹ç®¡ç†ç³»ç»Ÿ
// ============================================================

// æ‹–æ‹½å¤„ç†å‡½æ•°
function handleDragStart(e) {
    window.smpDraggedId = e.target.getAttribute("data-activity-id");
    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/plain", window.smpDraggedId);
    e.target.classList.add("dragging");
}

function handleDragEnd(e) {
    window.smpDraggedId = null;
    e.target.classList.remove("dragging");
    // ç§»é™¤æ‰€æœ‰æ”¾ç½®æŒ‡ç¤ºå™¨
    document.querySelectorAll(".activity-card").forEach(card => {
        card.classList.remove("drag-over");
    });
}

function handleDragOver(e) {
    e.preventDefault(); // å¿…é¡»é˜»æ­¢é»˜è®¤è¡Œä¸ºæ‰èƒ½æ¥æ”¶ drop
    e.dataTransfer.dropEffect = "move";
    const card = e.target.closest(".activity-card");
    if (card && card.getAttribute("data-activity-id") !== window.smpDraggedId) {
        card.classList.add("drag-over");
    }
}

function handleDragLeave(e) {
    const card = e.target.closest(".activity-card");
    if (card) {
        card.classList.remove("drag-over");
    }
}

async function handleActivityDrop(e) {
    e.preventDefault();
    const targetCard = e.target.closest(".activity-card");
    if (!targetCard) return;

    targetCard.classList.remove("drag-over");

    const draggedId = e.dataTransfer.getData("text/plain");
    const targetId = targetCard.getAttribute("data-activity-id");

    if (!draggedId || draggedId === targetId) return;

    // æ‰§è¡Œæ‹–æ‹½æ’åº
    await reorderActivities(draggedId, targetId);
}

// é‡æ–°æ’åºæ´»åŠ¨
async function reorderActivities(draggedId, targetId) {
    if (!currentPhase || !currentPhase.activities) return;

    const draggedIndex = currentPhase.activities.findIndex(a => a.id === draggedId);
    const targetIndex = currentPhase.activities.findIndex(a => a.id === targetId);

    if (draggedIndex < 0 || targetIndex < 0) return;

    // ä»åŸä½ç½®ç§»é™¤
    const [draggedItem] = currentPhase.activities.splice(draggedIndex, 1);
    // æ’å…¥åˆ°ç›®æ ‡ä½ç½®
    currentPhase.activities.splice(targetIndex, 0, draggedItem);

    // é‡æ–°è®¡ç®—æ—¶é—´åˆ†é…ï¼ˆæ ¹æ®é˜¶æ®µé€‰æ‹©ä¸åŒå‡½æ•°ï¼‰
    if (currentPhase.status === 'active') {
      // æ‰§è¡Œé˜¶æ®µï¼šä»å½“å‰æ´»åŠ¨é¢„è®¡ç»“æŸæ—¶é—´å¼€å§‹é‡æ–°åˆ†é…
      allocateRemainingTime();
    } else {
      // è§„åˆ’é˜¶æ®µï¼šæŒ‰å¿ƒç†é¢„æœŸæ¯”ä¾‹åˆ†é…
      allocateTimeByExpectation();
    }

    // é‡æ–°æ¸²æŸ“å¹¶ä¿å­˜
    renderActivitiesList();
    debouncedSave();

    // æ˜¾ç¤ºæç¤º
    statusEl.innerHTML = '';
    statusEl.createEl("div", {
        text: "âœ… å·²è°ƒæ•´é¡ºåºï¼Œæ—¶é—´å·²é‡æ–°åˆ†é…",
        attr: {style: "color: #4CAF50; background-color: #e8f5e9; padding: 5px; border-radius: 3px;"}
    });
}

// ============================================================
// ğŸ¨ æ¸²æŸ“æ´»åŠ¨åˆ—è¡¨(è§„åˆ’é˜¶æ®µ) - å¡ç‰‡å¼å¸ƒå±€ + æ‹–æ‹½æ”¯æŒ
// ============================================================

function renderActivitiesList() {
    // æ¸…é™¤ç°æœ‰çš„è¡¨æ ¼ï¼Œä½¿ç”¨å¡ç‰‡å®¹å™¨
    activitiesTableBody.innerHTML = '';

    // æ›´æ–°é˜¶æ®µä¿¡æ¯
    phaseSummary.innerHTML = '';

    if (!currentPhase) return;

    const phaseDuration = phaseSummary.createEl("div", {cls: "phase-duration"});
    const startDate = new Date(currentPhase.startTime);
    phaseDuration.createEl("strong", {
        text: `è®¡åˆ’é˜¶æ®µ: ${formatTime(startDate)} - ${formatDuration(currentPhase.plannedDuration)}`
    });

    if (!currentPhase.activities || currentPhase.activities.length === 0) {
        activitiesTableBody.createEl("div", {
            text: "å°šæœªæ·»åŠ ä»»ä½•æ´»åŠ¨",
            attr: {style: "text-align: center; color: var(--text-muted); padding: 40px;"}
        });
        return;
    }

    // ç¡®ä¿é¢„è®¡æ—¶é—´å·²è®¡ç®—
    calculateExpectedTimesForPlanning();

    // åˆ›å»ºå¡ç‰‡å®¹å™¨
    const cardsContainer = activitiesTableBody.createEl("div", {
        cls: "activity-cards-container",
        attr: {style: "display: flex; flex-direction: column; gap: 12px; padding: 10px 0;"}
    });

    // æ·»åŠ æ‹–æ‹½æ ·å¼
    const style = document.createElement("style");
    style.textContent = `
        .activity-card {
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            padding: 12px 16px;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .activity-card:hover {
            background: var(--background-modifier-hover);
            border-color: var(--interactive-accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .activity-card.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        .activity-card.drag-over {
            border: 2px dashed var(--interactive-accent);
            background: rgba(var(--interactive-accent-rgb), 0.05);
        }
        .activity-card .drag-handle {
            color: var(--text-muted);
            font-size: 18px;
            cursor: grab;
        }
        .activity-card .time-info {
            flex-shrink: 0;
            width: 80px;
            text-align: center;
        }
        .activity-card .time-info .time {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-normal);
        }
        .activity-card .time-info .duration {
            font-size: 11px;
            color: var(--text-muted);
        }
        .activity-card .activity-content {
            flex: 1;
            min-width: 0;
        }
        .activity-card .activity-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-normal);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .activity-card .activity-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .activity-card .activity-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .activity-card .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .activity-card .action-btn.pin-btn {
            background: transparent;
            font-size: 16px;
        }
        .activity-card .action-btn.pin-btn.pinned {
            color: #f44336;
        }
        .activity-card .action-btn.review-btn {
            background: var(--background-modifier-border);
            color: var(--text-normal);
        }
        .activity-card .action-btn.delete-btn {
            background: transparent;
            color: #f44336;
        }
        .activity-card .action-btn:hover {
            opacity: 0.8;
        }
    `;
    cardsContainer.appendChild(style);

    // æ¸²æŸ“æ¯ä¸ªæ´»åŠ¨å¡ç‰‡
    currentPhase.activities.forEach((activity, index) => {
        const card = cardsContainer.createEl("div", {
            cls: "activity-card",
            attr: {
                "data-activity-id": activity.id,
                draggable: "true"
            }
        });

        // æ‹–æ‹½äº‹ä»¶
        card.addEventListener("dragstart", handleDragStart);
        card.addEventListener("dragend", handleDragEnd);
        card.addEventListener("dragover", handleDragOver);
        card.addEventListener("dragleave", handleDragLeave);
        card.addEventListener("drop", handleActivityDrop);

        // æ‹–æ‹½æ‰‹æŸ„
        card.createEl("div", {
            cls: "drag-handle",
            text: "â‹®â‹®",
            attr: {title: "æ‹–æ‹½è°ƒæ•´é¡ºåº"}
        });

        // æ—¶é—´ä¿¡æ¯
        const timeInfo = card.createEl("div", {cls: "time-info"});
        const startTime = activity.expectedStart ?
            formatTime(new Date(activity.expectedStart)) : "å¾…å®š";
        timeInfo.createEl("div", {
            cls: "time",
            text: startTime
        });
        const expectedMins = activity.expectedDuration;
        const allocatedMins = activity.allocatedDuration || expectedMins;
        timeInfo.createEl("div", {
            cls: "duration",
            text: `${formatDuration(expectedMins)} â†’ ${formatDuration(allocatedMins)}`
        });

        // æ´»åŠ¨å†…å®¹
        const content = card.createEl("div", {cls: "activity-content"});
        content.createEl("div", {
            cls: "activity-name",
            text: activity.project
        });
        const ratio = currentPhase.plannedDuration > 0 ?
            Math.round((allocatedMins / currentPhase.plannedDuration) * 100) : 0;
        content.createEl("div", {
            cls: "activity-meta",
            text: `åˆ†é…: ${formatDuration(allocatedMins)} (${ratio}%)`
        });

        // æ“ä½œæŒ‰é’®
        const actions = card.createEl("div", {cls: "activity-actions"});

        // å›ºå®šå¼€å§‹æ—¶é—´æŒ‰é’®
        const pinBtn = actions.createEl("button", {
            cls: "action-btn pin-btn",
            text: activity.isStartTimeFixed ? "ğŸ“Œ" : "â—¯",
            title: activity.isStartTimeFixed ? "å·²å›ºå®šå¼€å§‹æ—¶é—´" : "å›ºå®šå¼€å§‹æ—¶é—´"
        });
        if (activity.isStartTimeFixed) pinBtn.classList.add("pinned");
        pinBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            activity.isStartTimeFixed = !activity.isStartTimeFixed;
            calculateExpectedTimesForPlanning();
            renderActivitiesList();
            debouncedSave();
        });

        // è¯„ä»·æŒ‰é’®
        const reviewBtn = actions.createEl("button", {
            cls: "action-btn review-btn",
            text: "è¯„ä»·",
            title: "æ·»åŠ è¯„ä»·"
        });
        reviewBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            showReviewForm(activity);
        });

        // åˆ é™¤æŒ‰é’®
        const deleteBtn = actions.createEl("button", {
            cls: "action-btn delete-btn",
            text: "âœ•",
            title: "åˆ é™¤"
        });
        deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            currentPhase.activities.splice(index, 1);
            allocateTimeByExpectation();
            renderActivitiesList();
            debouncedSave();
        });
    });
}
// ==================== æ¸²æŸ“æ‰§è¡Œåˆ—è¡¨(æ‰§è¡Œé˜¶æ®µ) - å¡ç‰‡å¼å¸ƒå±€ ====================
function renderExecutionList() {
  // æ¸…ç©ºå¡ç‰‡å®¹å™¨
  executionCardsWrapper.innerHTML = '';

  if (!currentPhase || !currentPhase.activities || currentPhase.activities.length === 0) {
    executionCardsWrapper.createEl("div", {
      text: "æ²¡æœ‰æ´»åŠ¨",
      attr: {style: "text-align: center; padding: 40px; color: var(--text-muted);"}
    });
    return;
  }

  // ç¡®ä¿é¢„è®¡å¼€å§‹å’Œç»“æŸæ—¶é—´å·²è®¡ç®—
  calculateExpectedTimes();

  // ç”¨äºè®°å½•ä¸Šä¸€ä¸ªæ´»åŠ¨çš„æ—¥æœŸ
  let previousDate = null;

  currentPhase.activities.forEach((activity, index) => {
    // æ£€æµ‹å½“å‰æ´»åŠ¨æ˜¯å¦ä¸ä¸Šä¸€ä¸ªæ´»åŠ¨åœ¨ä¸åŒæ—¥æœŸ
    let isCrossingToNewDay = false;
    let currentDate = null;

    if (activity.expectedStart) {
      currentDate = new Date(activity.expectedStart);
      currentDate.setHours(0, 0, 0, 0);

      if (previousDate && currentDate > previousDate) {
        isCrossingToNewDay = true;
      }
      if (currentDate) {
        previousDate = currentDate;
      }
    }

    // åˆ›å»ºå¡ç‰‡å®¹å™¨
    const card = executionCardsWrapper.createEl("div", {
      cls: "execution-card",
      attr: {
        "data-activity-id": activity.id,
        "data-index": index,
        style: `
          background: var(--background-primary);
          border: 1px solid var(--background-modifier-border);
          border-radius: 10px;
          padding: 16px;
          margin-bottom: 12px;
          cursor: ${activity.status === 'pending' ? 'grab' : 'default'};
          transition: all 0.2s ease;
          ${activity.status === 'in-progress' ? 'border-left: 4px solid #4CAF50; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);' : ''}
          ${activity.status === 'pending' && index > 0 && currentPhase.activities[index-1].status === 'in-progress' ? 'border-left: 4px solid #2196F3;' : ''}
          ${isCrossingToNewDay ? 'border-top: 3px solid #4CAF50; background: var(--background-secondary);' : ''}
        `
      }
    });

    // æ‹–æ‹½å¤„ç†ï¼ˆä»…å¯¹ pending çŠ¶æ€ï¼‰
    if (activity.status === 'pending') {
      card.draggable = true;
      card.addEventListener("dragstart", handleExecutionDragStart);
      card.addEventListener("dragend", handleExecutionDragEnd);
      card.addEventListener("dragover", handleExecutionDragOver);
      card.addEventListener("dragleave", handleExecutionDragLeave);
      card.addEventListener("drop", (e) => handleExecutionDrop(e, activity.id));
    }

    // å¦‚æœæ˜¯è¿›è¡Œä¸­æ´»åŠ¨ï¼ŒåŒ…è£¹ä¸€ä¸ªè¿›åº¦èƒŒæ™¯
    let hostEl = card;
    if (activity.status === 'in-progress') {
      const progressWrapper = card.createEl("div", { cls: "activity-progress" });
      progressWrapper.createEl("div", {
        cls: "activity-progress-bar",
        attr: { "data-activity-id": activity.id }
      });
      hostEl = progressWrapper.createEl("div", { cls: "activity-progress-content" });
      // åˆæ¬¡æ¸²æŸ“æ—¶åŒæ­¥ä¸€æ¬¡è¿›åº¦æ¡ï¼Œé¿å…ç­‰ä¸‹ä¸ª tick
      syncActivityProgressBar(activity);
    }

    // ==================== ç¬¬ä¸€è¡Œï¼šå¼€å§‹æ—¶é—´ - ç»“æŸæ—¶é—´ï¼ˆå¤§å­—ä½“çªå‡ºæ˜¾ç¤ºï¼‰================
    const timeRow = hostEl.createEl("div", {
      attr: {style: "display: flex; align-items: baseline; gap: 12px; margin-bottom: 10px;"}
    });

    // å¼€å§‹æ—¶é—´
    let startTimeText = "å¾…å®š";

    if (activity.status === 'completed' && activity.actualStart) {
      startTimeText = formatTime(new Date(activity.actualStart));
    } else if (activity.expectedStart) {
      const expectedStartDate = new Date(activity.expectedStart);
      startTimeText = formatTime(expectedStartDate);
      if (isCrossingToNewDay) {
        const dateStr = `${expectedStartDate.getMonth() + 1}/${expectedStartDate.getDate()}`;
        startTimeText = `ğŸŒ™ ${dateStr} ${startTimeText}`;
      }
    }

    const startTimeEl = timeRow.createEl("span", {
      text: `å¼€å§‹: ${startTimeText}`,
      attr: {
        style: `
          font-size: 16px;
          font-weight: 700;
          color: ${activity.isStartTimeFixed && activity.status !== 'completed' ? '#f44336' : 'var(--text-normal)'};
        `
      }
    });
    if (activity.isStartTimeFixed && activity.status !== 'completed') {
      startTimeEl.innerHTML += " ğŸ“Œ";
    }

    timeRow.createEl("span", {text: "â†’", attr: {style: "color: var(--text-muted); font-size: 14px;"}});

    // ç»“æŸæ—¶é—´
    let endTimeText = "å¾…å®š";
    let endTimeStyle = "font-size: 16px; font-weight: 700;";
    if (activity.status === 'completed' && activity.actualEnd) {
      endTimeText = formatTime(new Date(activity.actualEnd));
    } else if (activity.expectedEnd) {
      endTimeText = formatTime(new Date(activity.expectedEnd));
      endTimeStyle += " color: var(--text-normal);";
    }

    const endTimeEl = timeRow.createEl("span", {
      text: `ç»“æŸ: ${endTimeText}`,
      attr: {style: endTimeStyle}
    });

    // çŠ¶æ€æ ‡ç­¾ï¼ˆåœ¨æ—¶é—´åé¢ï¼‰
    const statusBadge = timeRow.createEl("span", {
      text: activity.status === 'completed' ? 'å·²å®Œæˆ' : activity.status === 'in-progress' ? 'è¿›è¡Œä¸­' : 'å¾…å¼€å§‹',
      attr: {
        style: `
          padding: 3px 8px;
          border-radius: 10px;
          font-size: 11px;
          font-weight: 600;
          margin-left: auto;
          ${activity.status === 'completed' ? 'background: #e8f5e9; color: #2e7d32;' : ''}
          ${activity.status === 'in-progress' ? 'background: #e3f2fd; color: #1565c0;' : ''}
          ${activity.status === 'pending' ? 'background: #f5f5f5; color: #616161;' : ''}
        `
      }
    });

    // ==================== ç¬¬äºŒè¡Œï¼šæ´»åŠ¨åç§°ï¼ˆå¯ç‚¹å‡»ç¼–è¾‘ï¼‰================
    const nameRow = hostEl.createEl("div", {
      attr: {style: "display: flex; align-items: center; gap: 10px; margin-bottom: 10px;"}
    });

    // æ–°ä¸€å¤©æ ‡è¯†
    if (isCrossingToNewDay) {
      const phaseStartDate = new Date(currentPhase.startTime);
      phaseStartDate.setHours(0, 0, 0, 0);
      const daysDiff = Math.floor((currentDate - phaseStartDate) / (1000 * 60 * 60 * 24));
      nameRow.createEl("span", {
        text: `ğŸŒ™ ç¬¬${daysDiff + 1}å¤©`,
        attr: {style: "font-size: 12px; color: #4CAF50; font-weight: 600;"}
      });
    }

    // æ´»åŠ¨åç§°ï¼ˆå¯ç‚¹å‡»ç¼–è¾‘ï¼‰
    const nameEl = nameRow.createEl("span", {
      text: activity.project,
      attr: {
        style: `
          font-size: 15px;
          font-weight: 600;
          color: var(--text-normal);
          ${activity.status === 'pending' ? 'cursor: pointer; text-decoration: underline dotted #888;' : ''}
          ${activity.status === 'pending' ? 'text-decoration-skip-ink: none;' : ''}
        `
      }
    });
    if (activity.status === 'pending') {
      nameEl.title = "ç‚¹å‡»ç¼–è¾‘";
      nameEl.addEventListener("click", () => showEditModal(activity));
    }

    const ratingValue = Number(activity.rating) || 0;
    const ratingStars = ratingValue > 0
      ? "â˜…".repeat(ratingValue) + "â˜†".repeat(5 - ratingValue)
      : "â˜†â˜†â˜†â˜†â˜†";
    let ratingColor = "var(--text-muted)";
    if (ratingValue >= 4) {
      ratingColor = "#2e7d32";
    } else if (ratingValue === 3) {
      ratingColor = "#f9a825";
    } else if (ratingValue > 0) {
      ratingColor = "#d32f2f";
    }

    nameRow.createEl("span", {
      cls: "activity-rating-pill",
      text: ratingValue > 0 ? `${ratingStars} ${ratingValue}/5` : `${ratingStars} å¾…è¯„ä»·`,
      attr: {
        style: `
          color: ${ratingColor};
          background: ${ratingValue > 0 ? 'rgba(76, 175, 80, 0.12)' : 'var(--background-modifier-border)'};
        `
      }
    });

    const reviewText = (activity.experience || "").trim();

    // ==================== ä¸»ä½“è¯„ä»·åŒºï¼šå®Œæ•´æ˜¾ç¤ºè¯„ä»· ====================
    const reviewBlock = hostEl.createEl("div", {cls: "activity-review-block"});
    if (activity.status === 'in-progress') {
      reviewBlock.classList.add("in-progress");
    }
    reviewBlock.createEl("div", {
      cls: "activity-review-title",
      text: "ğŸ“ å¤ç›˜è¯„ä»·"
    });

    if (reviewText) {
      reviewBlock.createEl("div", {
        cls: "activity-review-content",
        text: reviewText
      });
    } else {
      reviewBlock.createEl("div", {
        cls: "activity-review-empty",
        text: "æš‚æ— è¯„ä»·ï¼Œç‚¹å‡»å³ä¾§ã€Œè¯„ä»·ã€è¡¥å……å¤ç›˜ã€‚"
      });
    }

    // ==================== ç¬¬ä¸‰è¡Œï¼šæ—¶é•¿ä¿¡æ¯ + æ“ä½œæŒ‰é’® ====================
    const infoRow = hostEl.createEl("div", {
      attr: {style: "display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid var(--background-modifier-border);"}
    });

    // æ—¶é•¿ä¿¡æ¯
    const durationInfo = infoRow.createEl("div", {
      attr: {style: "display: flex; gap: 16px; font-size: 13px;"}
    });

    // å¿ƒç†é¢„æœŸ
    durationInfo.createEl("span", {
      text: `å¿ƒç†: ${formatDuration(activity.expectedDuration)}`,
      attr: {style: "color: var(--text-muted);"}
    });

    // å®é™…/åˆ†é…æ—¶é•¿
    let actualTimeText = "";
    if (activity.status === 'completed') {
      const start = new Date(activity.actualStart);
      const end = new Date(activity.actualEnd);
      const actualDuration = (end - start) / (60 * 1000);
      actualTimeText = `å®é™…: ${formatDuration(actualDuration)}`;
    } else if (activity.status === 'in-progress') {
      const now = new Date();
      const start = new Date(activity.actualStart);
      const elapsedTime = (now - start) / (60 * 1000);
      const totalAllocated = activity.allocatedDuration || activity.expectedDuration;
      actualTimeText = `${formatDuration(elapsedTime)} / ${formatDuration(totalAllocated)} (æœ¬æ´»åŠ¨)`;
    } else {
      actualTimeText = `åˆ†é…: ${formatDuration(activity.allocatedDuration || activity.expectedDuration)}`;
    }
    durationInfo.createEl("span", {
      text: actualTimeText,
      cls: "activity-actual-text",
      attr: {
        "data-activity-id": activity.id,
        style: "color: var(--text-normal); font-weight: 500;"
      }
    });

    // æ˜¾ç¤ºé˜¶æ®µå‰©ä½™æ€»æ—¶é—´ï¼ˆä»…å¯¹è¿›è¡Œä¸­çš„æ´»åŠ¨ï¼‰
    if (activity.status === 'in-progress' && currentPhase) {
      const plannedEndTime = new Date(currentPhase.startTime);
      plannedEndTime.setMinutes(plannedEndTime.getMinutes() + currentPhase.plannedDuration);
      const remainingMs = Math.max(0, plannedEndTime - new Date());
      const remainingMinutes = Math.ceil(remainingMs / (60 * 1000));
      durationInfo.createEl("span", {
        text: `é˜¶æ®µå‰©ä½™: ${formatDuration(remainingMinutes)}`,
        cls: "activity-phase-remaining",
        attr: {
          "data-activity-id": activity.id,
          style: "color: #2196F3; font-weight: 600; margin-left: 10px;"
        }
      });
    }

    durationInfo.createEl("span", {
      text: reviewText ? `è¯„ä»·: å·²è®°å½• Â· ${ratingValue || 'æœªè¯„åˆ†'}` : "è¯„ä»·: å¾…è¡¥å……",
      attr: {
        style: `
          color: ${reviewText ? '#4CAF50' : '#888'};
          font-weight: 500;
        `
      }
    });

    // æ“ä½œæŒ‰é’®
    const actions = infoRow.createEl("div", {
      attr: {style: "display: flex; gap: 6px;"}
    });

    // è¯„ä»·æŒ‰é’®
    const reviewBtn = actions.createEl("button", {
      text: activity.experience ? "é‡æ–°è¯„ä»·" : "è¯„ä»·",
      attr: {
        style: "padding: 5px 10px; font-size: 12px; border-radius: 4px; border: 1px solid var(--background-modifier-border); background: transparent; cursor: pointer;"
      }
    });
    reviewBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      showReviewForm(activity);
    });

    // æ’å…¥æŒ‰é’®
    const addAfterBtn = actions.createEl("button", {
      text: "+",
      attr: {
        title: "åœ¨æ­¤æ´»åŠ¨åæ·»åŠ æ–°æ´»åŠ¨",
        style: "padding: 5px 8px; font-size: 14px; border-radius: 4px; border: 1px solid var(--background-modifier-border); background: transparent; cursor: pointer;"
      }
    });
    addAfterBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      showAddActivityAfterForm(index);
    });


    // å›ºå®šå¼€å§‹æ—¶é—´æŒ‰é’®ï¼ˆä»… pending çŠ¶æ€ï¼‰
    if (activity.status === 'pending') {
      const fixTimeBtn = actions.createEl("button", {
        text: activity.isStartTimeFixed ? "ğŸ“Œå·²å›ºå®š" : "ğŸ“Œå›ºå®š",
        attr: {
          title: activity.isStartTimeFixed
            ? `å·²å›ºå®šå¼€å§‹æ—¶é—´: ${activity.expectedStart ? formatTime(new Date(activity.expectedStart)) : 'æœªçŸ¥'}ï¼ˆç‚¹å‡»ä¿®æ”¹æˆ–å–æ¶ˆï¼‰`
            : "å›ºå®šå¼€å§‹æ—¶é—´ï¼ˆå¯æŒ‡å®šå…·ä½“æ—¶é—´ï¼Œåç»­æ´»åŠ¨é‡æ–°åˆ†é…ï¼‰",
          style: `
            padding: 5px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid ${activity.isStartTimeFixed ? '#f44336' : 'var(--background-modifier-border)'};
            background: ${activity.isStartTimeFixed ? 'rgba(244, 67, 54, 0.1)' : 'transparent'};
            cursor: pointer;
            color: ${activity.isStartTimeFixed ? '#f44336' : 'var(--text-normal)'};
          `
        }
      });
      fixTimeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        // æ‰“å¼€å›ºå®šæ—¶é—´å¼¹çª—
        showFixedStartTimeModal(activity);
      });
    }

    // åˆ é™¤æŒ‰é’®ï¼ˆä»… pending çŠ¶æ€ï¼‰
    if (activity.status === 'pending') {
      const deleteBtn = actions.createEl("button", {
        text: "Ã—",
        attr: {
          title: "åˆ é™¤æ­¤æ´»åŠ¨",
          style: "padding: 5px 8px; font-size: 14px; border-radius: 4px; border: 1px solid var(--background-modifier-border); background: transparent; cursor: pointer; color: #f44336;"
        }
      });
      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        currentPhase.activities.splice(index, 1);
        allocateRemainingTime();
        debouncedSave();
        renderExecutionList();
        if (currentPhase.status === 'active') {
          updateExecutionDisplay();
        }
      });
    }
  });

  // æ¸²æŸ“å‰©ä½™æ—¶é—´ç»Ÿè®¡
  renderRemainingTimeStats();
}

// ==================== æ‰§è¡Œé˜¶æ®µæ‹–æ‹½å¤„ç†å‡½æ•° ====================
function handleExecutionDragStart(e) {
  window.smpExecutionDragId = e.target.getAttribute("data-activity-id");
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData("text/plain", window.smpExecutionDragId);
  e.target.classList.add("dragging");
}

function handleExecutionDragEnd(e) {
  window.smpExecutionDragId = null;
  e.target.classList.remove("dragging");
}

function handleExecutionDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
  const card = e.target.closest(".execution-card");
  if (card && !card.classList.contains("dragging")) {
    const status = currentPhase.activities.find(a => a.id === card.getAttribute("data-activity-id"))?.status;
    if (status === 'pending') {
      card.style.border = "2px dashed var(--interactive-accent)";
      card.style.background = "rgba(var(--interactive-accent-rgb), 0.05)";
    }
  }
}

function handleExecutionDragLeave(e) {
  const card = e.target.closest(".execution-card");
  if (card) {
    card.style.border = "";
    card.style.background = "";
  }
}

async function handleExecutionDrop(e, targetId) {
  e.preventDefault();
  const draggedId = window.smpExecutionDragId;
  if (!draggedId || draggedId === targetId) return;

  const draggedActivity = currentPhase.activities.find(a => a.id === draggedId);
  const targetActivity = currentPhase.activities.find(a => a.id === targetId);

  if (!draggedActivity || !targetActivity) return;

  // åªå…è®¸æ‹–æ‹½ pending çŠ¶æ€çš„æ´»åŠ¨
  if (draggedActivity.status !== 'pending') {
    new Notice("åªèƒ½æ‹–æ‹½å¾…å¼€å§‹çš„æ´»åŠ¨");
    return;
  }
  if (targetActivity.status !== 'pending') {
    new Notice("åªèƒ½æ”¾ç½®åˆ°å¾…å¼€å§‹çš„æ´»åŠ¨ä½ç½®");
    return;
  }

  // æ‰§è¡Œæ‹–æ‹½æ’åº
  const draggedIndex = currentPhase.activities.findIndex(a => a.id === draggedId);
  const targetIndex = currentPhase.activities.findIndex(a => a.id === targetId);

  if (draggedIndex === -1 || targetIndex === -1) return;

  // ç§»åŠ¨æ•°ç»„å…ƒç´ 
  const [removed] = currentPhase.activities.splice(draggedIndex, 1);
  currentPhase.activities.splice(targetIndex, 0, removed);

  // é‡æ–°è®¡ç®—æ—¶é—´
  allocateRemainingTime();
  debouncedSave();
  renderExecutionList();
  if (currentPhase.status === 'active') {
    updateExecutionDisplay();
  }

  new Notice(`å·²è°ƒæ•´é¡ºåº`);
}

// ==================== æ¸²æŸ“å‰©ä½™æ—¶é—´ç»Ÿè®¡ ====================
function renderRemainingTimeStats() {
  // ç§»é™¤æ—§çš„ç»Ÿè®¡åŒºåŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const oldStats = executionListEl.querySelector('.remaining-time-stats');
  if (oldStats) {
    oldStats.remove();
  }
  
  if (!currentPhase || !currentPhase.activities || currentPhase.activities.length === 0) {
    return;
  }
  
  // è®¡ç®—å‰©ä½™æœªå®Œæˆæ´»åŠ¨
 
  // è®¡ç®—å‰©ä½™æœªå®Œæˆæ´»åŠ¨ï¼ˆåŒ…æ‹¬æ­£åœ¨è¿›è¡Œçš„æ´»åŠ¨ï¼‰
const remainingActivities = currentPhase.activities.filter(a => a.status === 'pending' || a.status === 'in-progress');

  // å¦‚æœæ²¡æœ‰å‰©ä½™æ´»åŠ¨ï¼Œæ˜¾ç¤º"å…¨éƒ¨å®Œæˆ"
  if (remainingActivities.length === 0) {
    const statsContainer = executionListEl.createEl("div", {
      cls: "remaining-time-stats",
      attr: {style: "margin-top: 20px; padding: 15px; background-color: #e8f5e9; border-radius: 5px; border-left: 4px solid #4CAF50;"}
    });
    statsContainer.createEl("h4", {
      text: "âœ… æ‰€æœ‰æ´»åŠ¨å·²å®Œæˆï¼",
      attr: {style: "margin: 0; color: #2e7d32;"}
    });
    return;
  }
  
  // è®¡ç®—æ€»é¢„æœŸæ—¶é—´ï¼ˆå¿ƒç†é¢„æœŸï¼‰
  const totalExpectedTime = remainingActivities.reduce((sum, activity) => {
    return sum + (activity.expectedDuration || 0);
  }, 0);
  
  // è®¡ç®—å®é™…å‰©ä½™æ—¶é—´ï¼ˆä»å½“å‰æ—¶é—´åˆ°è®¡åˆ’ç»“æŸæ—¶é—´ï¼‰
  const now = new Date();
  const plannedEndTime = new Date(currentPhase.startTime);
  plannedEndTime.setMinutes(plannedEndTime.getMinutes() + currentPhase.plannedDuration);
  
  const actualRemainingTime = Math.max(0, (plannedEndTime - now) / (60 * 1000)); // åˆ†é’Ÿ
  
  // è®¡ç®—é¢„æœŸæ—¶é—´ä¸å®é™…æ—¶é—´çš„æ¯”ä¾‹
  const ratio = actualRemainingTime > 0 ? (totalExpectedTime / actualRemainingTime) : 0;
  
  // åˆ›å»ºç»Ÿè®¡æ˜¾ç¤ºåŒºåŸŸ
  const statsContainer = executionListEl.createEl("div", {
    cls: "remaining-time-stats",
    attr: {
      style: "margin-top: 20px; padding: 20px; background-color: #f5f5f5; border-radius: 8px; border-left: 4px solid #2196F3;"
    }
  });
  
  // æ ‡é¢˜
  statsContainer.createEl("h4", {
    text: "ğŸ“Š å‰©ä½™æ—¶é—´ç»Ÿè®¡",
    attr: {style: "margin-top: 0; margin-bottom: 15px; color: #1976D2;"}
  });
  
  // ç»Ÿè®¡è¡¨æ ¼
  const statsTable = statsContainer.createEl("table", {
    attr: {style: "width: 100%; border-collapse: collapse;"}
  });
  
  // è¡Œ1ï¼šå‰©ä½™æœªå®Œæˆé¡¹ç›®æ•°é‡
  const row1 = statsTable.createEl("tr");
  row1.createEl("td", {
    text: "å‰©ä½™æœªå®Œæˆé¡¹ç›®ï¼š",
    attr: {style: "padding: 8px; font-weight: bold; width: 40%;"}
  });
  row1.createEl("td", {
    text: `${remainingActivities.length} ä¸ª`,
    attr: {style: "padding: 8px; color: #1976D2; font-size: 16px;"}
  });
  
  // è¡Œ2ï¼šé¢„æœŸæ—¶é—´æ€»å’Œ
  const row2 = statsTable.createEl("tr");
  row2.createEl("td", {
    text: "é¢„æœŸæ—¶é—´æ€»å’Œï¼ˆå¿ƒç†é¢„æœŸï¼‰ï¼š",
    attr: {style: "padding: 8px; font-weight: bold; background-color: #e3f2fd;"}
  });
  row2.createEl("td", {
    text: formatDuration(totalExpectedTime),
    attr: {style: "padding: 8px; background-color: #e3f2fd; color: #0d47a1; font-size: 16px; font-weight: bold;"}
  });
  
  // è¡Œ3ï¼šå®é™…å‰©ä½™æ—¶é—´
  const row3 = statsTable.createEl("tr");
  row3.createEl("td", {
    text: "å®é™…å‰©ä½™æ—¶é—´ï¼ˆåˆ°è®¡åˆ’ç»“æŸï¼‰ï¼š",
    attr: {style: "padding: 8px; font-weight: bold;"}
  });
  const actualTimeColor = actualRemainingTime < totalExpectedTime ? "#d32f2f" : "#388e3c";
  row3.createEl("td", {
    text: formatDuration(actualRemainingTime),
    attr: {style: `padding: 8px; color: ${actualTimeColor}; font-size: 16px; font-weight: bold;`}
  });
  
  // è¡Œ4ï¼šæ—¶é—´å·®ï¼ˆå®é™…-é¢„æœŸï¼‰
  const timeDifference = actualRemainingTime - totalExpectedTime;
  const row4 = statsTable.createEl("tr");
  row4.createEl("td", {
    text: "æ—¶é—´å·®ï¼ˆå®é™…-é¢„æœŸï¼‰ï¼š",
    attr: {style: "padding: 8px; font-weight: bold; background-color: #f5f5f5;"}
  });
  const diffColor = timeDifference >= 0 ? "#388e3c" : "#d32f2f";
  const diffSign = timeDifference >= 0 ? "+" : "";
  row4.createEl("td", {
    text: `${diffSign}${formatDuration(Math.abs(timeDifference))} ${timeDifference >= 0 ? "(å……è£•)" : "(ç´§å¼ )"}`,
    attr: {style: `padding: 8px; background-color: #f5f5f5; color: ${diffColor}; font-size: 16px; font-weight: bold;`}
  });
  
  // è¡Œ5ï¼šå æ¯”åˆ†æ
  const row5 = statsTable.createEl("tr");
  row5.createEl("td", {
    text: "é¢„æœŸ/å®é™… æ¯”ä¾‹ï¼š",
    attr: {style: "padding: 8px; font-weight: bold;"}
  });
  let ratioText, ratioColor, ratioDescription;
  if (actualRemainingTime === 0) {
    ratioText = "âš ï¸ æ—¶é—´å·²ç”¨å®Œ";
    ratioColor = "#d32f2f";
    ratioDescription = "è®¡åˆ’æ—¶é—´å·²è€—å°½";
  } else if (ratio > 1.2) {
    ratioText = `${(ratio * 100).toFixed(1)}%`;
    ratioColor = "#d32f2f";
    ratioDescription = "é¢„æœŸæ—¶é—´è¶…å‡ºå‰©ä½™æ—¶é—´ï¼Œéœ€è¦å‹ç¼©";
  } else if (ratio > 0.9 && ratio <= 1.2) {
    ratioText = `${(ratio * 100).toFixed(1)}%`;
    ratioColor = "#ff9800";
    ratioDescription = "é¢„æœŸæ—¶é—´ä¸å‰©ä½™æ—¶é—´åŸºæœ¬åŒ¹é…";
  } else {
    ratioText = `${(ratio * 100).toFixed(1)}%`;
    ratioColor = "#388e3c";
    ratioDescription = "é¢„æœŸæ—¶é—´å°äºå‰©ä½™æ—¶é—´ï¼Œæ—¶é—´å……è£•";
  }
  
  const ratioCell = row5.createEl("td", {
    attr: {style: "padding: 8px;"}
  });
  ratioCell.createEl("span", {
    text: ratioText,
    attr: {style: `color: ${ratioColor}; font-size: 18px; font-weight: bold;`}
  });
  ratioCell.createEl("br");
  ratioCell.createEl("span", {
    text: ratioDescription,
    attr: {style: `color: #666; font-size: 12px; font-style: italic;`}
  });
  
  // å¦‚æœæ—¶é—´ç´§å¼ ï¼Œæ·»åŠ è­¦å‘Šæç¤º
  if (ratio > 1.1) {
    const warningDiv = statsContainer.createEl("div", {
      attr: {
        style: "margin-top: 15px; padding: 10px; background-color: #fff3e0; border-left: 4px solid #ff9800; border-radius: 3px;"
      }
    });
    warningDiv.createEl("strong", {
      text: "âš ï¸ å»ºè®®ï¼š",
      attr: {style: "color: #e65100;"}
    });
    warningDiv.createEl("span", {
      text: " é¢„æœŸæ—¶é—´è¶…å‡ºå‰©ä½™æ—¶é—´ï¼Œå»ºè®®è€ƒè™‘å»¶é•¿æ€»æ—¶é•¿æˆ–è°ƒæ•´æ´»åŠ¨ä¼˜å…ˆçº§ã€‚",
      attr: {style: "color: #666;"}
    });
  }
}

// ===================================================================
//  AddActivityModal ç±» (ç¬¦åˆ Obsidian 1.9+ è§„èŒƒ) - ã€æœªä¿®æ”¹ã€‘
// ===================================================================
// æ˜¾ç¤ºåœ¨ç‰¹å®šæ´»åŠ¨åæ·»åŠ æ–°æ´»åŠ¨çš„è¡¨å•
// ===================================================================
//  ç¬¬ 1 éƒ¨åˆ†: æ–°çš„ AddActivityModal ç±» (ç¬¦åˆ Obsidian 1.9+ è§„èŒƒ)
// ===================================================================
// ç¡®ä¿æ‚¨åœ¨è„šæœ¬çš„é¡¶éƒ¨æˆ–é€‚å½“çš„ä½œç”¨åŸŸä¸­å¯ä»¥è®¿é—®åˆ° Obsidian çš„ API
// const { Modal, App, Notice } = require('obsidian'); // å¦‚æœåœ¨æ’ä»¶å¼€å‘ä¸­ï¼Œéœ€è¦è¿™æ ·å¼•å…¥
// åœ¨ DataviewJS ä¸­ï¼Œ`app` å’Œ `Notice` é€šå¸¸æ˜¯å…¨å±€å¯ç”¨çš„
const { Modal, Notice } = require('obsidian');


class AddActivityModal extends Modal {
  // æ„é€ å‡½æ•°æ¥æ”¶ app å®ä¾‹, ç›®æ ‡ç´¢å¼•, ä»¥åŠä¸€ä¸ªæˆåŠŸæäº¤åçš„å›è°ƒå‡½æ•°
  constructor(app, afterIndex, onSubmit) {
    super(app);
    this.afterIndex = afterIndex;
    this.onSubmit = onSubmit;
  }

  // onOpen æ˜¯ Modal çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå½“çª—å£æ‰“å¼€æ—¶è‡ªåŠ¨æ‰§è¡Œ
  onOpen() {
    const { contentEl } = this; // contentEl æ˜¯ Modal æä¾›çš„ä¸€ä¸ªå®‰å…¨çš„ã€ç”¨äºå¡«å……å†…å®¹çš„ HTML å…ƒç´ 

    // --- å¼€å§‹æ„å»ºæ¨¡æ€çª—å£çš„å†…éƒ¨ UI ---

    // 1. è®¾ç½®æ ‡é¢˜
    const targetActivity = currentPhase.activities[this.afterIndex];
    if (!targetActivity) {
      // è¿™æ˜¯ä¸€ä¸ªé¢å¤–çš„å®‰å…¨æ£€æŸ¥ï¼Œå°½ç®¡å¤–éƒ¨å·²åšè¿‡
      contentEl.createEl('h4', { text: 'é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç›®æ ‡æ´»åŠ¨' });
      return;
    }
    contentEl.createEl('h4', { 
      text: `åœ¨ "${targetActivity.project}" åæ·»åŠ æ–°æ´»åŠ¨`,
      cls: 'modal-title' // å¯ä»¥æ·»åŠ è‡ªå®šä¹‰ç±»åä»¥ä¾¿CSSç¾åŒ–
    }).style.marginBottom = "15px";

    // 2. æ·»åŠ æ´»åŠ¨åç§°è¾“å…¥åŒºåŸŸ (ä½¿ç”¨ textarea)
    contentEl.createEl('label', { 
      text: 'æ´»åŠ¨åç§°:', 
      cls: 'modal-label' 
    }).style.fontWeight = "bold";
    
    const nameInput = contentEl.createEl('textarea');
    nameInput.setAttrs({
      "placeholder": "è¯·è¾“å…¥æ´»åŠ¨åç§°ï¼ˆå¯è¾“å…¥æœ€å¤š1000å­—ï¼‰",
      "maxlength": "1000"
    });
    // è®¾ç½®æ ·å¼
    Object.assign(nameInput.style, {
      width: "100%",
      height: "200px",
      padding: "10px",
      fontSize: "16px",
      resize: "vertical",
      marginTop: "5px",
      marginBottom: "15px"
    });

    // 3. æ·»åŠ æ—¶é•¿è¾“å…¥åŒºåŸŸ
    contentEl.createEl('label', { 
      text: 'å¿ƒç†é¢„æœŸæ—¶é•¿(åˆ†é’Ÿ):', 
      cls: 'modal-label' 
    }).style.fontWeight = "bold";

    const durationInput = contentEl.createEl('input', { type: 'number' });
    durationInput.setAttrs({ min: '1', value: '10' });
    Object.assign(durationInput.style, {
      width: "100%",
      padding: "8px",
      marginTop: "5px",
      marginBottom: "20px"
    });
    
    // 4. åˆ›å»ºæŒ‰é’®å®¹å™¨
    const buttonContainer = contentEl.createEl('div', { cls: 'modal-button-container' });
    Object.assign(buttonContainer.style, {
      display: "flex",
      justifyContent: "flex-end",
      gap: "10px"
    });

    // 5. åˆ›å»ºç¡®è®¤æŒ‰é’®
    const confirmBtn = buttonContainer.createEl('button', { text: 'æ·»åŠ ' });
    Object.assign(confirmBtn.style, {
      padding: "8px 15px",
      backgroundColor: "#4CAF50",
      color: "white"
    });
    confirmBtn.addEventListener('click', () => {
      const projectName = nameInput.value.trim();
      const duration = parseInt(durationInput.value, 10);
      
      if (!projectName || isNaN(duration) || duration <= 0) {
        new Notice('è¯·è¾“å…¥æœ‰æ•ˆçš„æ´»åŠ¨åç§°å’Œæ—¶é•¿ï¼', 3000); // ä½¿ç”¨Obsidiançš„Noticeæç¤º
        return;
      }
      
      this.onSubmit(projectName, duration); // è°ƒç”¨ä¼ å…¥çš„å›è°ƒå‡½æ•°ï¼Œå°†æ•°æ®ä¼ å‡º
      this.close(); // å…³é—­æ¨¡æ€çª—å£
    });

    // 6. åˆ›å»ºå–æ¶ˆæŒ‰é’®
    const cancelBtn = buttonContainer.createEl('button', { text: 'å–æ¶ˆ' });
    cancelBtn.style.padding = "8px 15px";
    cancelBtn.addEventListener('click', () => {
      this.close(); // å…³é—­æ¨¡æ€çª—å£
    });

    // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥è¾“å…¥
    // ä½¿ç”¨ setTimeout ç¡®ä¿å…ƒç´ å®Œå…¨æ¸²æŸ“åå†èšç„¦
    setTimeout(() => nameInput.focus(), 50);
  }

  // onClose æ˜¯ Modal çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå½“çª—å£å…³é—­æ—¶è‡ªåŠ¨æ‰§è¡Œ
  onClose() {
    // æ¸…ç©ºå†…å®¹ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼å’ŒUIæ®‹ç•™
    this.contentEl.empty();
  }
}

// =========================================================================
//  ç¬¬ 2 éƒ¨åˆ†: æ–°çš„ã€ç²¾ç®€çš„ showAddActivityAfterForm å‡½æ•°
// =========================================================================
function showAddActivityAfterForm(afterIndex) {
  // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ç›®æ ‡ç´¢å¼•æœ‰æ•ˆ
  const targetActivity = currentPhase.activities[afterIndex];
  if (!targetActivity) {
    console.error("showAddActivityAfterForm è°ƒç”¨å¤±è´¥ï¼šæ— æ•ˆçš„ç´¢å¼•", afterIndex);
    new Notice("æ— æ³•æ·»åŠ æ´»åŠ¨ï¼Œå› ä¸ºæ‰¾ä¸åˆ°ç›®æ ‡ä½ç½®ã€‚", 4000);
    return;
  }

  // å®šä¹‰å½“ç”¨æˆ·åœ¨æ¨¡æ€çª—å£ä¸­ç‚¹å‡»â€œç¡®è®¤â€åè¦æ‰§è¡Œçš„æ“ä½œ
  const handleSubmit = (projectName, duration) => {
    const newActivity = {
      id: generateId(), // ç¡®ä¿æ‚¨çš„ generateId() å‡½æ•°å¯ç”¨
      project: projectName,
      expectedDuration: duration,
      status: 'pending',
      isStartTimeFixed: false
    };
    
    // 1. åœ¨æŒ‡å®šä½ç½®åæ’å…¥æ–°æ´»åŠ¨
    currentPhase.activities.splice(afterIndex + 1, 0, newActivity);
    
    // 2. é‡æ–°è®¡ç®—å’Œä¿å­˜
    allocateRemainingTime(); // ç¡®ä¿æ‚¨çš„ allocateRemainingTime() å‡½æ•°å¯ç”¨
    debouncedSave();         // ç¡®ä¿æ‚¨çš„ debouncedSave() å‡½æ•°å¯ç”¨
    
    // 3. æ›´æ–°æ‰§è¡Œåˆ—è¡¨çš„UI (å¦‚æœæ‚¨æœ‰è¿™ä¸ªå‡½æ•°)
    // å¦‚æœæ²¡æœ‰ renderExecutionListï¼Œè¯·ç¡®ä¿æœ‰å…¶ä»–æœºåˆ¶æ¥åˆ·æ–°åˆ—è¡¨
    renderExecutionList();
    if (currentPhase.status === 'active') {
      updateExecutionDisplay();
    }

    // 4. æ˜¾ç¤ºæˆåŠŸæç¤º
    statusEl.innerHTML = ''; // ç¡®ä¿ statusEl å…ƒç´ å¯ç”¨
    statusEl.createEl("div", {
      text: "âœ… æ´»åŠ¨å·²æ·»åŠ ï¼Œæ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ° JSON",
      attr: {style: "color: #4CAF50; background-color: #e8f5e9; padding: 5px; border-radius: 3px;"}
    });

    new Notice(`å·²æˆåŠŸæ·»åŠ æ´»åŠ¨: "${projectName}"`, 3000);
  };
  
  // åˆ›å»ºå¹¶æ‰“å¼€æ–°çš„æ¨¡æ€çª—å£å®ä¾‹
  new AddActivityModal(app, afterIndex, handleSubmit).open();
}


// æ˜¾ç¤ºå»¶é•¿æ—¶é—´çš„å¼¹çª—
// ===================================================================
//  ç¬¬ 1 éƒ¨åˆ†: æ–°çš„ ExtendDurationModal ç±» (ç¬¦åˆ Obsidian 1.9+ è§„èŒƒ)
// ===================================================================

// â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘ç¡®ä¿ Modal å’Œ Notice å·²ä» Obsidian æ ¸å¿ƒåº“ä¸­åŠ è½½ â–¼â–¼â–¼
// å¦‚æœæ‚¨åœ¨è„šæœ¬é¡¶éƒ¨å·²ç»æœ‰äº†è¿™è¡Œä»£ç ï¼Œå¯ä»¥è·³è¿‡ï¼›å¦åˆ™è¯·ä¿ç•™

// â–²â–²â–² ã€æ ¸å¿ƒä¿®å¤ã€‘â–²â–²â–²

class ExtendDurationModal extends Modal {
  // æ„é€ å‡½æ•°æ¥æ”¶ app å®ä¾‹å’Œä¸€ä¸ªæˆåŠŸæäº¤åçš„å›è°ƒå‡½æ•°
  constructor(app, onSubmit) {
    super(app);
    this.onSubmit = onSubmit;
  }

  // onOpen æ˜¯ Modal çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå½“çª—å£æ‰“å¼€æ—¶è‡ªåŠ¨æ‰§è¡Œ
  onOpen() {
    const { contentEl } = this;

    // --- å¼€å§‹æ„å»ºæ¨¡æ€çª—å£çš„å†…éƒ¨ UI ---

    // 1. è®¾ç½®æ ‡é¢˜
    contentEl.createEl('h4', { text: 'å»¶é•¿è®¡åˆ’æ€»æ—¶é•¿' });

    // 2. æ˜¾ç¤ºå½“å‰æ€»æ—¶é•¿
    contentEl.createEl('div', {
      cls: 'modal-info-text' // æ·»åŠ ä¸€ä¸ªç±»åæ–¹ä¾¿æ ·å¼è°ƒæ•´
    }).innerHTML = `<span>å½“å‰æ€»æ—¶é•¿: <strong>${formatDuration(currentPhase.plannedDuration)}</strong></span>`;
    contentEl.lastChild.style.marginBottom = '10px';

    // 3. æ·»åŠ æ—¶é•¿è¾“å…¥åŒºåŸŸ
    contentEl.createEl('label', { text: 'å»¶é•¿æ—¶é—´(åˆ†é’Ÿ):' });
    const durationInput = contentEl.createEl('input', { type: 'number' });
    durationInput.setAttrs({ min: '1', value: '15' });
    durationInput.style.marginTop = '5px';

    // 4. åˆ›å»ºæŒ‰é’®å®¹å™¨
    const buttonContainer = contentEl.createEl('div', { cls: 'modal-button-container' });
    buttonContainer.style.marginTop = '15px';

    // 5. åˆ›å»ºç¡®è®¤æŒ‰é’®
    const confirmBtn = buttonContainer.createEl('button', { 
      text: 'ç¡®è®¤å»¶é•¿', 
      cls: 'mod-cta' // ä½¿ç”¨ Obsidian çš„æ¨èç±»åï¼Œä½¿å…¶çœ‹èµ·æ¥åƒä¸€ä¸ªä¸»æ“ä½œæŒ‰é’®
    }); 
    confirmBtn.addEventListener('click', () => {
      const extraMinutes = parseInt(durationInput.value, 10);
      
      if (isNaN(extraMinutes) || extraMinutes <= 0) {
        new Notice('è¯·è¾“å…¥æœ‰æ•ˆçš„å»¶é•¿æ—¶é—´ï¼', 3000);
        return;
      }
      
      this.onSubmit(extraMinutes); // è°ƒç”¨ä¼ å…¥çš„å›è°ƒå‡½æ•°
      this.close();
    });

    // 6. åˆ›å»ºå–æ¶ˆæŒ‰é’®
    const cancelBtn = buttonContainer.createEl('button', { text: 'å–æ¶ˆ' });
    cancelBtn.addEventListener('click', () => {
      this.close();
    });

    // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
    setTimeout(() => durationInput.focus(), 50);
  }

  // onClose æ˜¯ Modal çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå½“çª—å£å…³é—­æ—¶è‡ªåŠ¨æ‰§è¡Œ
  onClose() {
    this.contentEl.empty();
  }
}

// =========================================================================
// å›ºå®šå¼€å§‹æ—¶é—´å¼¹çª—
// =========================================================================
class FixedStartTimeModal extends Modal {
  // æ„é€ å‡½æ•°æ¥æ”¶ app å®ä¾‹ã€æ´»åŠ¨å¯¹è±¡ã€ä»¥åŠå›è°ƒå‡½æ•°
  constructor(app, activity, onSubmit) {
    super(app);
    this.activity = activity;
    this.onSubmit = onSubmit;
  }

  // onOpen æ˜¯ Modal çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå½“çª—å£æ‰“å¼€æ—¶è‡ªåŠ¨æ‰§è¡Œ
  onOpen() {
    const { contentEl } = this;

    // --- å¼€å§‹æ„å»ºæ¨¡æ€çª—å£çš„å†…éƒ¨ UI ---

    // 1. è®¾ç½®æ ‡é¢˜
    contentEl.createEl('h4', {
      text: `å›ºå®š "${this.activity.project}" çš„å¼€å§‹æ—¶é—´`,
      cls: 'modal-title'
    }).style.marginBottom = "15px";

    // 2. æ˜¾ç¤ºå½“å‰æ´»åŠ¨ä¿¡æ¯
    contentEl.createEl('div', {
      cls: 'modal-info-text'
    }).innerHTML = `
      <span>å¿ƒç†é¢„æœŸ: <strong>${formatDuration(this.activity.expectedDuration)}</strong></span>
      <br>
      <span style="color: #666; font-size: 12px;">è®¾ç½®æ­¤æ´»åŠ¨çš„å›ºå®šå¼€å§‹æ—¶é—´ï¼Œåç»­æ´»åŠ¨å°†ä»è¯¥æ—¶é—´ç‚¹é‡æ–°åˆ†é…</span>
    `;
    contentEl.lastChild.style.marginBottom = '15px';

    // 3. æ·»åŠ æ—¶é—´é€‰æ‹©åŒºåŸŸ
    contentEl.createEl('label', {
      text: 'å›ºå®šå¼€å§‹æ—¶é—´:',
      cls: 'modal-label'
    }).style.fontWeight = "bold";

    // é»˜è®¤å€¼ï¼šå¦‚æœå·²æœ‰å›ºå®šæ—¶é—´åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰æ—¶é—´
    const now = new Date();
    const defaultTime = this.activity.expectedStart
      ? `${new Date(this.activity.expectedStart).getHours().toString().padStart(2, '0')}:${new Date(this.activity.expectedStart).getMinutes().toString().padStart(2, '0')}`
      : `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

    const timeInput = contentEl.createEl('input', { type: 'time' });
    timeInput.setAttrs({ value: defaultTime });
    timeInput.style.marginTop = '5px';
    timeInput.style.marginBottom = '15px';
    timeInput.style.padding = '8px';
    timeInput.style.width = '100%';

    // 4. åˆ›å»ºæŒ‰é’®å®¹å™¨
    const buttonContainer = contentEl.createEl('div', { cls: 'modal-button-container' });
    buttonContainer.style.marginTop = '15px';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.gap = '10px';

    // 5. åˆ›å»ºç¡®è®¤æŒ‰é’®
    const confirmBtn = buttonContainer.createEl('button', {
      text: 'ç¡®è®¤å›ºå®š',
      cls: 'mod-cta'
    });
    confirmBtn.style.flex = '1';
    confirmBtn.style.padding = '8px 15px';

    // 6. åˆ›å»ºå–æ¶ˆæŒ‰é’®
    const cancelBtn = buttonContainer.createEl('button', { text: 'å–æ¶ˆ' });
    cancelBtn.style.flex = '1';
    cancelBtn.style.padding = '8px 15px';

    // 7. å¦‚æœå·²å›ºå®šï¼Œæä¾›"å–æ¶ˆå›ºå®š"é€‰é¡¹
    if (this.activity.isStartTimeFixed) {
      const unsetBtn = buttonContainer.createEl('button', {
        text: 'å–æ¶ˆå›ºå®š',
        cls: 'mod-warning'
      });
      unsetBtn.style.flex = '1';
      unsetBtn.style.padding = '8px 15px';
      unsetBtn.style.backgroundColor = '#f44336';
      unsetBtn.style.color = 'white';

      unsetBtn.addEventListener('click', () => {
        this.onSubmit(null); // null è¡¨ç¤ºå–æ¶ˆå›ºå®š
        this.close();
      });
    }

    confirmBtn.addEventListener('click', () => {
      const timeValue = timeInput.value;

      if (!timeValue) {
        new Notice('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´ï¼', 3000);
        return;
      }

      // è§£ææ—¶é—´
      const [hours, minutes] = timeValue.split(':').map(Number);
      const fixedTime = new Date();
      fixedTime.setHours(hours, minutes, 0, 0);

      // éªŒè¯æ—¶é—´æ˜¯å¦åœ¨è®¡åˆ’èŒƒå›´å†…
      const plannedEndTime = new Date(currentPhase.startTime);
      plannedEndTime.setMinutes(plannedEndTime.getMinutes() + currentPhase.plannedDuration);

      if (fixedTime < new Date(currentPhase.startTime)) {
        new Notice('å›ºå®šæ—¶é—´ä¸èƒ½æ—©äºè®¡åˆ’å¼€å§‹æ—¶é—´ï¼', 3000);
        return;
      }

      if (fixedTime > plannedEndTime) {
        new Notice('å›ºå®šæ—¶é—´ä¸èƒ½æ™šäºè®¡åˆ’ç»“æŸæ—¶é—´ï¼', 3000);
        return;
      }

      this.onSubmit(fixedTime); // ä¼ å…¥å›ºå®šçš„ Date å¯¹è±¡
      this.close();
    });

    cancelBtn.addEventListener('click', () => {
      this.close();
    });

    // è‡ªåŠ¨èšç„¦åˆ°æ—¶é—´è¾“å…¥æ¡†
    setTimeout(() => timeInput.focus(), 50);
  }

  // onClose æ˜¯ Modal çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå½“çª—å£å…³é—­æ—¶è‡ªåŠ¨æ‰§è¡Œ
  onClose() {
    this.contentEl.empty();
  }
}

// =========================================================================
// æ˜¾ç¤ºå›ºå®šå¼€å§‹æ—¶é—´å¼¹çª—
// =========================================================================
function showFixedStartTimeModal(activity) {
  // å®‰å…¨æ£€æŸ¥
  if (!currentPhase || currentPhase.status !== 'active') {
    statusEl.innerHTML = '';
    statusEl.createEl("div", {
      text: "æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„è®¡åˆ’",
      attr: {style: "color: red; background-color: #ffebee; padding: 8px; border-radius: 3px; margin: 10px 0;"}
    });
    return;
  }

  if (!activity || activity.status !== 'pending') {
    new Notice('åªèƒ½å›ºå®šå¾…å¼€å§‹æ´»åŠ¨çš„å¼€å§‹æ—¶é—´', 3000);
    return;
  }

  // å®šä¹‰å½“ç”¨æˆ·åœ¨æ¨¡æ€çª—å£ä¸­ç‚¹å‡»"ç¡®è®¤å›ºå®š"åè¦æ‰§è¡Œçš„æ“ä½œ
  const handleSubmit = (fixedTime) => {
    if (fixedTime === null) {
      // å–æ¶ˆå›ºå®š
      activity.isStartTimeFixed = false;
      activity.expectedStart = null;
      new Notice('å·²å–æ¶ˆå›ºå®šå¼€å§‹æ—¶é—´');
    } else {
      // è®¾ç½®å›ºå®šæ—¶é—´
      activity.isStartTimeFixed = true;
      activity.expectedStart = new Date(fixedTime);
      new Notice(`å·²å›ºå®šå¼€å§‹æ—¶é—´: ${formatTime(fixedTime)}`);
    }

    // é‡æ–°åˆ†é…æ—¶é—´
    allocateRemainingTime();
    debouncedSave();
    renderExecutionList();
    if (currentPhase.status === 'active') {
      updateExecutionDisplay();
    }
  };

  // åˆ›å»ºå¹¶æ‰“å¼€æ¨¡æ€çª—å£
  new FixedStartTimeModal(app, activity, handleSubmit).open();
}


// =========================================================================
//  ç¬¬ 2 éƒ¨åˆ†: æ–°çš„ã€ç²¾ç®€çš„ showExtendDurationModal å‡½æ•°
// =========================================================================
function showExtendDurationModal() {
  // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿å½“å‰æœ‰æ­£åœ¨æ‰§è¡Œçš„è®¡åˆ’
  if (!currentPhase || currentPhase.status !== 'active') {
    statusEl.innerHTML = '';
    statusEl.createEl("div", {
      text: "æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„è®¡åˆ’",
      attr: {style: "color: red; background-color: #ffebee; padding: 8px; border-radius: 3px; margin: 10px 0;"}
    });
    return;
  }
  
  // å®šä¹‰å½“ç”¨æˆ·åœ¨æ¨¡æ€çª—å£ä¸­ç‚¹å‡»â€œç¡®è®¤å»¶é•¿â€åè¦æ‰§è¡Œçš„æ“ä½œ
  // æ³¨æ„ï¼šè¿™é‡Œçš„é€»è¾‘ç›´æ¥è°ƒç”¨æ‚¨åŸæ¥çš„ extendPhaseDuration å‡½æ•°
  const handleSubmit = (extraMinutes) => {
    // è°ƒç”¨æ‚¨åŸæ¥çš„æ ¸å¿ƒé€»è¾‘å‡½æ•°
    extendPhaseDuration(extraMinutes); 
  };
  
  // åˆ›å»ºå¹¶æ‰“å¼€æ–°çš„æ¨¡æ€çª—å£å®ä¾‹
  new ExtendDurationModal(app, handleSubmit).open();
}


// å»¶é•¿é˜¶æ®µæ€»æ—¶é•¿çš„å‡½æ•°
function extendPhaseDuration(extraMinutes) {
  if (!currentPhase) return;
  
  // ä¿å­˜åŸå§‹æ—¶é•¿ç”¨äºæ¶ˆæ¯æ˜¾ç¤º
  const originalDuration = currentPhase.plannedDuration;
  
  // æ›´æ–°æ€»æ—¶é•¿
  currentPhase.plannedDuration += extraMinutes;
  
  // é‡æ–°åˆ†é…å‰©ä½™æ—¶é—´
  allocateRemainingTime();
  debouncedSave();
  // æ›´æ–°UI
  updateExecutionDisplay();
  

  
  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  statusEl.innerHTML = '';
  statusEl.createEl("div", {
    text: `æ€»æ—¶é•¿å·²ä» ${formatDuration(originalDuration)} å»¶é•¿è‡³ ${formatDuration(currentPhase.plannedDuration)}`,
    attr: {style: "color: green; background-color: #e8f5e9; padding: 8px; border-radius: 3px; margin: 10px 0;"}
  });
  
  // æç¤ºä¿å­˜
  const savePrompt = statusEl.createEl("div", {
    text: "è¯·ç‚¹å‡»ã€Œä¿å­˜å½“å‰çŠ¶æ€ã€æŒ‰é’®ä»¥ä¿å­˜æ›´æ”¹åˆ°å¤‡ä»½",
    attr: {style: "color: #ff9800; margin-top: 5px;"}
  });
}

// æ˜¾ç¤ºè¯„ä»·è¡¨å•ï¼ˆä¼˜åŒ–ç‰ˆï¼šè§£å†³é—ªå›é—®é¢˜ï¼‰
function showReviewForm(activity) {
  // ä¿å­˜å½“å‰è¯„ä»·çš„æ´»åŠ¨IDï¼Œç¡®ä¿æäº¤æ—¶è¯„ä»·æ­£ç¡®çš„æ´»åŠ¨
  reviewFormEl.setAttribute("data-activity-id", activity.id);
  
  // æ˜¾ç¤ºè¯„ä»·è¡¨å•
  reviewFormEl.style.display = "block";
  activityToReviewName.setText(`è¯„ä»·æ´»åŠ¨: ${activity.project}`);
  
  // å¡«å…¥ç°æœ‰çš„è¯„ä»·å’Œè¯„åˆ†ï¼ˆæ”¯æŒé‡æ–°è¯„ä»·ï¼‰
  experienceInput.value = activity.experience || "";
  ratingInput.value = activity.rating || "3";
  
  // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
  const oldBtn = submitReviewBtn;
  const newBtn = oldBtn.cloneNode(true);
  if (oldBtn.parentNode) {
    oldBtn.parentNode.replaceChild(newBtn, oldBtn);
  } else {
    reviewFormEl.appendChild(newBtn);
  }
  submitReviewBtn = newBtn;
  
  // æ·»åŠ ä¼˜åŒ–åçš„äº‹ä»¶ç›‘å¬å™¨
  newBtn.addEventListener("click", () => {
    const activityId = reviewFormEl.getAttribute("data-activity-id");
    const targetActivity = currentPhase.activities.find(a => a.id === activityId);
    
    if (!targetActivity) {
      statusEl.innerHTML = '';
      statusEl.createEl("div", {
        text: "æ‰¾ä¸åˆ°è¦è¯„ä»·çš„æ´»åŠ¨",
        attr: {style: "color: red; padding: 8px; border-radius: 3px; margin: 10px 0; background-color: #ffebee;"}
      });
      return;
    }

    // ä¿å­˜æ—§å€¼ç”¨äºçŠ¶æ€æ¯”è¾ƒ
    const oldExperience = targetActivity.experience;
    const oldRating = targetActivity.rating;
    
    // æ›´æ–°æ´»åŠ¨çš„è¯„ä»·å’Œè¯„åˆ†
    targetActivity.experience = experienceInput.value.trim();
    targetActivity.rating = parseInt(ratingInput.value);
    
    // æ·»åŠ è¯„ä»·æ—¶é—´æˆ³ï¼Œç”¨äºæ£€æµ‹æœ€æ–°è¯„ä»·
    targetActivity.lastReviewTime = new Date().getTime();
    
 
    
    // å…³é—­è¯„ä»·è¡¨å•
    reviewFormEl.style.display = "none";
    
    // æ›´æ–°UIä»¥åæ˜ æ–°è¯„ä»·
    if (currentPhase.status === 'planning') {
      renderActivitiesList();
    } else {
      renderExecutionList();
    }
    debouncedSave();
    // æ˜¾ç¤ºä¿å­˜æç¤º
    statusEl.innerHTML = '';
    statusEl.createEl("div", {
      text: `âœ… è¯„ä»·å·²æ·»åŠ ï¼Œæ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ° JSON`,
      attr: {style: "color: #4CAF50; background-color: #e8f5e9; padding: 8px; border-radius: 3px; margin: 10px 0;"}
    });
    
    // æ˜¾ç¤ºä¿®æ”¹å‰åçš„å¯¹æ¯”
    const changesMsg = statusEl.createEl("div", {
      attr: {style: "margin-top: 5px; font-size: 0.9em; color: #555;"}
    });
    
    if (oldExperience !== targetActivity.experience || oldRating !== targetActivity.rating) {
      changesMsg.innerHTML = `
        <span>è¯„ä»·å·²æ›´æ–°:</span>
        ${oldRating !== targetActivity.rating ? 
          `<span>è¯„åˆ†: ${oldRating || 'æ— '} â†’ ${targetActivity.rating}</span><br>` : ''}
        ${oldExperience !== targetActivity.experience ? 
          `<span>æè¿°: ${oldExperience ? 'å·²ä¿®æ”¹' : 'æ–°å¢'}</span>` : ''}
      `;
    } else {
      changesMsg.textContent = "è¯„ä»·æœªå˜æ›´";
    }
  });
}

// åŒæ­¥å•ä¸ªæ´»åŠ¨è¿›åº¦æ¡å®½åº¦
function syncActivityProgressBar(activity) {
  if (!activity || activity.status !== 'in-progress') return;
  const barEl = containerEl.querySelector(`.activity-progress-bar[data-activity-id=\"${activity.id}\"]`);
  if (!barEl) return;
  const now = new Date();
  const start = activity.actualStart ? new Date(activity.actualStart) : now;
  const elapsed = (now - start) / (60 * 1000);
  const total = activity.allocatedDuration || activity.expectedDuration || 0;
  if (total <= 0) {
    barEl.style.width = '0%';
    return;
  }
  const pct = Math.min(100, Math.max(0, (elapsed / total) * 100));
  barEl.style.width = `${pct}%`;
}

// åˆ·æ–°å½“å‰æ´»åŠ¨å¡ç‰‡ä¸Šçš„æ•°å­—/å‰©ä½™æ˜¾ç¤º
function updateActivityLiveUI(activity, phaseRemainingMinutes = null) {
  if (!activity || activity.status !== 'in-progress') return;

  const now = new Date();
  const start = activity.actualStart ? new Date(activity.actualStart) : now;
  const elapsed = (now - start) / (60 * 1000);
  const total = activity.allocatedDuration || activity.expectedDuration || 0;
  const remaining = Math.max(0, total - elapsed);

  // æ›´æ–°æ—¶é—´æ–‡æœ¬
  const actualEl = containerEl.querySelector(`.activity-actual-text[data-activity-id=\"${activity.id}\"]`);
  if (actualEl) {
    actualEl.textContent = `${formatDuration(elapsed)} / ${formatDuration(total)} (æœ¬æ´»åŠ¨)`;
  }

  // æ›´æ–°é˜¶æ®µå‰©ä½™æ–‡æœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const phaseEl = containerEl.querySelector(`.activity-phase-remaining[data-activity-id=\"${activity.id}\"]`);
  if (phaseEl) {
    const text = phaseRemainingMinutes != null
      ? `é˜¶æ®µå‰©ä½™: ${formatDuration(phaseRemainingMinutes)}`
      : phaseEl.textContent; // fallback
    phaseEl.textContent = text;
  }

  // åŒæ­¥è¿›åº¦æ¡
  syncActivityProgressBar(activity);
}

// æ›´æ–°æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º - ä¿®å¤è¿›åº¦æ¡æ˜¾ç¤ºé—®é¢˜
// æ›´æ–°æ‰§è¡Œæ˜¾ç¤º(åŒ…æ‹¬è¿›åº¦æ¡å’Œå½“å‰æ´»åŠ¨) - ä¼˜åŒ–ç‰ˆï¼šæ›´æ¸…æ™°çš„è¿›åº¦æ˜¾ç¤º
function updateExecutionDisplay() {
  if (!currentPhase || currentPhase.status !== 'active') return;
  
  const now = new Date();
  const startTime = new Date(currentPhase.startTime);
  const plannedEndTime = new Date(startTime.getTime() + currentPhase.plannedDuration * 60 * 1000);
  
  // è®¡ç®—æ€»è¿›åº¦
  const totalDuration = currentPhase.plannedDuration * 60 * 1000; // æ¯«ç§’
  const elapsed = now - startTime;
  const progress = Math.min(100, (elapsed / totalDuration) * 100);
  
  // æ›´æ–°è¿›åº¦æ¡
  progressBar.style.width = `${progress}%`;
  progressBar.setAttribute("aria-valuenow", Math.floor(progress));
  
  // è®¡ç®—å‰©ä½™æ—¶é—´
  const remainingMs = Math.max(0, plannedEndTime - now);
  const remainingMinutes = Math.ceil(remainingMs / (60 * 1000));
  const elapsedMinutes = Math.max(0, elapsed / (60 * 1000));
  const totalMinutes = currentPhase.plannedDuration;

  // æ›´æ–°è¿›åº¦æ–‡æœ¬ï¼ŒåŒ…å«æ›´å¤šä¿¡æ¯
  progressText.innerHTML = `å¼€å§‹: ${formatTime(startTime)} | ç»“æŸ: ${formatTime(plannedEndTime)} | ` +
                         `å·²è¿›è¡Œ: ${formatDuration(elapsedMinutes)} | æ€»æ—¶é•¿: ${formatDuration(totalMinutes)} | ` +
                         `å‰©ä½™: ${formatDuration(remainingMinutes)} | ` +
                         `è¿›åº¦: ${Math.floor(progress)}%`;

  // æŸ¥æ‰¾å½“å‰è¿›è¡Œä¸­çš„æ´»åŠ¨
  const currentActivity = currentPhase.activities.find(a => a.status === 'in-progress');
  
  // æ›´æ–°å½“å‰æ´»åŠ¨å¡ç‰‡çš„å®æ—¶æ•°å€¼ä¸è¿›åº¦èƒŒæ™¯
  if (currentActivity) {
    updateActivityLiveUI(currentActivity, remainingMinutes);
  }
  
  // æ˜¾ç¤ºå½“å‰æ´»åŠ¨ä¿¡æ¯
  if (currentActivity) {
    currentActivityName.innerHTML = `<strong>${currentActivity.project}</strong>`;
    
    // å¦‚æœç¼ºå°‘ actualStartï¼Œç«‹å³è¡¥é½ï¼Œé¿å…è¯»/é¢„è§ˆæ¨¡å¼ä¸åˆ·æ–°
    if (!currentActivity.actualStart) {
      currentActivity.actualStart = new Date();
      debouncedSave();
    }

    // è®¡ç®—å½“å‰æ´»åŠ¨å·²è¿›è¡Œæ—¶é—´
    const activityElapsed = (now - new Date(currentActivity.actualStart)) / (60 * 1000);
    const allocatedTime = currentActivity.allocatedDuration || currentActivity.expectedDuration;
    const activityRemaining = Math.max(0, allocatedTime - activityElapsed);
    
    // æ›´æ–°å½“å‰æ´»åŠ¨å¡ç‰‡ä¸Šçš„è¿›åº¦èƒŒæ™¯
    syncActivityProgressBar(currentActivity);

    // æ˜¾ç¤ºå½“å‰æ´»åŠ¨çš„æ—¶é—´ä¿¡æ¯
    currentActivityTime.innerHTML = `å·²è¿›è¡Œ: ${formatDuration(activityElapsed)} | ` +
                                   `é¢„è®¡å‰©ä½™: ${formatDuration(activityRemaining)} | ` +
                                   `æ€»è®¡åˆ’: ${formatDuration(allocatedTime)}`;
  } else {
    currentActivityName.textContent = "æ— è¿›è¡Œä¸­çš„æ´»åŠ¨";
    currentActivityTime.textContent = "";
  }
  
  // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„æ´»åŠ¨
  const nextActivityIndex = currentPhase.activities.findIndex(a => a.status === 'pending');
  
  // æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ´»åŠ¨ä¿¡æ¯
  if (nextActivityIndex !== -1) {
    const nextActivity = currentPhase.activities[nextActivityIndex];
    nextActivityName.innerHTML = `ä¸‹ä¸€ä¸ª: <strong>${nextActivity.project}</strong> (è®¡åˆ’æ—¶é—´: ${formatDuration(nextActivity.allocatedDuration || nextActivity.expectedDuration)})`;
  } else {
    nextActivityName.textContent = "æ²¡æœ‰æ›´å¤šå¾…å¤„ç†çš„æ´»åŠ¨";
  }
  
  // ==================== ã€æ–°å¢ã€‘å®æ—¶æ›´æ–°å‰©ä½™æ—¶é—´ç»Ÿè®¡ ====================
  renderRemainingTimeStats();
}


function startNextActivity() {
  if (!currentPhase) return;

  // å®Œæˆå½“å‰æ´»åŠ¨
  const currentActivity = currentPhase.activities.find(a => a.status === 'in-progress');
  if (currentActivity) {
    currentActivity.status = 'completed';
    currentActivity.actualEnd = new Date();
    currentPhase.lastTransitionTime = new Date();
  }

  // å¼€å§‹ä¸‹ä¸€ä¸ªæ´»åŠ¨
  const nextActivity = currentPhase.activities.find(a => a.status === 'pending');
  if (nextActivity) {
    nextActivity.status = 'in-progress';
    nextActivity.actualStart = new Date();

    // åœ¨ä¸‹ä¸€ä¸ªæ´»åŠ¨å¼€å§‹æ—¶ï¼Œç«‹å³é‡æ–°åˆ†é…å‰©ä½™æ—¶é—´
    allocateRemainingTime();
    updateExecutionDisplay(); // ç«‹å³åˆ·æ–°æ•°å­—ä¸æ¡
  } else {
    // å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªæ´»åŠ¨ï¼Œæç¤ºå®Œæˆ
    new Notice("æ‰€æœ‰æ´»åŠ¨å·²å®Œæˆï¼");
  }

  // ä¿å­˜å’Œæ›´æ–° UI
  debouncedSave();
  renderExecutionList();
  updateExecutionDisplay();
}

// æ·»åŠ æ–°æ´»åŠ¨
function addActivity() {
  if (!currentPhase) return;
  
  const project = projectInput.value.trim();
  const duration = parseInt(projectDurationInput.value);
  
  if (!project) {
    statusEl.setText("è¯·è¾“å…¥æ´»åŠ¨åç§°");
    statusEl.setAttribute("style", "color: red;");
    return;
  }
  
  if (isNaN(duration) || duration <= 0) {
    statusEl.setText("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿");
    statusEl.setAttribute("style", "color: red;");
    return;
  }
  
  const newActivity = {
    id: generateId(),
    project,
    expectedDuration: duration,  // å¿ƒç†é¢„æœŸæ—¶é•¿
    status: 'pending'
    
  };
  
  currentPhase.activities.push(newActivity);
  projectInput.value = "";
  projectDurationInput.value = "15";

  // é‡æ–°åˆ†é…æ—¶é—´ï¼ˆæ ¹æ®é˜¶æ®µé€‰æ‹©ä¸åŒå‡½æ•°ï¼‰
  if (currentPhase.status === 'active') {
    // æ‰§è¡Œé˜¶æ®µï¼šä»å½“å‰æ´»åŠ¨é¢„è®¡ç»“æŸæ—¶é—´å¼€å§‹é‡æ–°åˆ†é…
    allocateRemainingTime();
  } else {
    // è§„åˆ’é˜¶æ®µï¼šæŒ‰å¿ƒç†é¢„æœŸæ¯”ä¾‹åˆ†é…
    allocateTimeByExpectation();
  }

  renderActivitiesList();
  debouncedSave();

  // æ˜¾ç¤ºä¿å­˜æç¤º
  statusEl.innerHTML = '';
  statusEl.createEl("div", {
    text: "âœ… æ´»åŠ¨å·²æ·»åŠ ï¼Œæ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ° JSON",
    attr: {style: "color: #4CAF50; background-color: #e8f5e9; padding: 5px; border-radius: 3px;"}
  });
}

// æ‰‹åŠ¨ä¿å­˜å½“å‰çŠ¶æ€ï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰


// æ‰‹åŠ¨ä¿å­˜å½“å‰çŠ¶æ€ï¼ˆè§„åˆ’é˜¶æ®µï¼‰
// DELETE the autoSaveTick, saveCurrentState, and savePlanState functions.
// REPLACE them with this single, unified save function:

async function saveCurrentState() {
  if (window.timePlannerIsSaving) {
    console.warn("SAVE BLOCKED: A save operation is already in progress.");
    return;
  }
  if (!currentPhase) {
    console.log("No active plan to save.");
    return;
  }

  // --- Visual Feedback: Indicate Saving ---
  if (saveExecutionBtn) saveExecutionBtn.setText("ä¿å­˜ä¸­...");
  if (savePlanBtn) savePlanBtn.setText("ä¿å­˜ä¸­...");

  try {
    const success = await saveCurrentStateJSON();  // ä½¿ç”¨ JSON å­˜å‚¨
    if (success) {
      console.log("SUCCESS: Current state saved to JSON.");
      // --- Visual Feedback: Indicate Success ---
      if (saveExecutionBtn) saveExecutionBtn.setText("å·²ä¿å­˜");
      if (savePlanBtn) savePlanBtn.setText("å·²ä¿å­˜");
    } else {
      throw new Error("Failed to save activity plan to JSON.");
    }
  } catch (error) {
    console.error("Save failed:", error);
    // --- Visual Feedback: Indicate Error ---
    if (saveExecutionBtn) saveExecutionBtn.setText("ä¿å­˜å¤±è´¥");
    if (savePlanBtn) savePlanBtn.setText("ä¿å­˜å¤±è´¥");
  }
}


// åˆ›å»ºæ–°çš„æ—¶é—´é˜¶æ®µ
function createPhase() {
  const durationValue = parseInt(durationInput.value);
  const startTimeValue = startTimeInput.value;
  
  if (isNaN(durationValue) || durationValue <= 0) {
    statusEl.setText("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿");
    statusEl.setAttribute("style", "color: red;");
    return;
  }
  
  if (!startTimeValue) {
    statusEl.setText("è¯·é€‰æ‹©å¼€å§‹æ—¶é—´");
    statusEl.setAttribute("style", "color: red;");
    return;
  }
  
  // è§£æå¼€å§‹æ—¶é—´
  const [hours, minutes] = startTimeValue.split(':').map(Number);
  const startTime = new Date();
  startTime.setHours(hours, minutes, 0, 0);
  
  // åˆ›å»ºæ–°çš„æ—¶é—´é˜¶æ®µ
  currentPhase = {
    startTime,
    plannedDuration: durationValue,
    activities: [],
    status: 'planning',
    totalExpectedDuration: 0,
    lastTransitionTime: null // æ·»åŠ è½¬æ¢ç‚¹æ—¶é—´æ ‡è®°
  };
  
  // æ›´æ–°UIçŠ¶æ€
  lastUIState = { phase: 'planning', timestamp: Date.now() };
  
  // æ˜¾ç¤ºæ´»åŠ¨è§„åˆ’è¡¨å•
  phaseFormEl.style.display = "none";
  activitiesFormEl.style.display = "block";
  executionPanelEl.style.display = "none";
  
  statusEl.setText("å·²åˆ›å»ºæ–°çš„æ—¶é—´é˜¶æ®µï¼Œè¯·æ·»åŠ æ´»åŠ¨");
  statusEl.setAttribute("style", "color: green;");
  
  // ä¿å­˜åˆ°localStorage

}

// å®Œæˆæ—¶é—´é˜¶æ®µå¹¶ç”Ÿæˆè®°å½•
function completePhase() {
  if (!currentPhase) return;

  // ç»“æŸæ‰€æœ‰è¿›è¡Œä¸­çš„æ´»åŠ¨
  const activeActivity = currentPhase.activities.find(a => a.status === 'in-progress');
  if (activeActivity) {
    activeActivity.status = 'completed';
    activeActivity.actualEnd = new Date();
  }

  // å°†å½“å‰é˜¶æ®µè½¬æ¢ä¸ºæ¡ç›®è®°å½•ï¼ˆç”¨äºç”ŸæˆæŠ¥å‘Šï¼‰
  const newEntries = convertPhaseToEntries(currentPhase);

  // ä¿å­˜æœ€ç»ˆçŠ¶æ€åˆ° JSONï¼ˆåŒ…å«æ‰€æœ‰å·²å®Œæˆæ´»åŠ¨çš„æ—¶é—´è®°å½•ï¼‰
  savePlanToJSON();

  // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  statusEl.setText("å·²å®Œæˆæ—¶é—´é˜¶æ®µ");
  statusEl.setAttribute("style", "color: green;");

  // é‡ç½®UIåˆ°åˆå§‹çŠ¶æ€
  currentPhase = null;
  lastUIState = { phase: 'initial', timestamp: Date.now() };

  // æ¸…é™¤æ‰§è¡Œé¢æ¿åˆ·æ–°å®šæ—¶å™¨
  if (window.timePlannerDisplayIntervalId) {
    clearInterval(window.timePlannerDisplayIntervalId);
    window.timePlannerDisplayIntervalId = null;
  }

  // æ–°å¢ï¼šåœæ­¢è‡ªåŠ¨ä¿å­˜


  // æ¸…é™¤localStorage
  try {
    localStorage.removeItem(`time-phase-${getCurrentFilePath()}`);
  } catch (e) {
    console.warn("æ¸…é™¤localStorageæ—¶å‡ºé”™:", e);
  }

  // è¿”å›åˆ°åˆå§‹è®¡åˆ’ç•Œé¢
  phaseFormEl.style.display = "block";
  activitiesFormEl.style.display = "none";
  executionPanelEl.style.display = "none";
  reviewFormEl.style.display = "none";

  // æ¸…ç©ºè¡¨å•è¾“å…¥ï¼Œä¸ºæ–°è®¡åˆ’åšå‡†å¤‡
  durationInput.value = "120";
  startTimeInput.value = "";
  activityListEl.innerHTML = "";

  // æç¤ºç”¨æˆ·å¯ä»¥å¼€å§‹æ–°è®¡åˆ’
  new Notice("âœ… æ—¶é—´é˜¶æ®µå·²å®Œæˆï¼ŒJSONå†å²å·²æ¸…ç©ºï¼Œå¯å¼€å§‹æ–°è®¡åˆ’");

  // åˆ·æ–°è§†å›¾
  if (renderViewFn) renderViewFn();
}
// 1. å…ˆå®šä¹‰æ·»åŠ CSSæ ·å¼çš„å‡½æ•°
function addFixedButtonStyles() {
  // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ æ ·å¼ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
  if (document.getElementById('time-planner-fixed-styles')) return;
  
  const styleEl = document.createElement('style');
  styleEl.id = 'time-planner-fixed-styles';
  styleEl.textContent = `
    .fixed-time-btn {
      transition: all 0.3s ease;
    }
    
    .fixed-time-btn.fixed {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    /* å…¶ä»–å¯èƒ½éœ€è¦çš„æ ·å¼ */
    .current-activity-row {
      background-color: #e3f2fd;
    }
    
    .next-activity-row {
      background-color: #f1f8e9;
    }
  `;
  document.head.appendChild(styleEl);
}


// åˆå§‹åŒ–UIåŸºäºé˜¶æ®µçŠ¶æ€
function initUIBasedOnPhaseStatus() {
// æ·»åŠ CSSæ ·å¼
  addFixedButtonStyles();
  
  if (!currentPhase) {
    phaseFormEl.style.display = "block";
    activitiesFormEl.style.display = "none";
    executionPanelEl.style.display = "none";
    reviewFormEl.style.display = "none";
    return;
  }
  if (!currentPhase) {
    phaseFormEl.style.display = "block";
    activitiesFormEl.style.display = "none";
    executionPanelEl.style.display = "none";
    reviewFormEl.style.display = "none";
    return;
  }
  
  if (currentPhase.status === 'planning') {
    phaseFormEl.style.display = "none";
    activitiesFormEl.style.display = "block";
    executionPanelEl.style.display = "none";
    reviewFormEl.style.display = "none";
    renderActivitiesList();
    updateAllocationSummary();
  } else if (currentPhase.status === 'active') {
    phaseFormEl.style.display = "none";
    activitiesFormEl.style.display = "none";
    executionPanelEl.style.display = "block";
    reviewFormEl.style.display = "none";
    
    // ç¡®ä¿æ—¶é—´åˆ·æ–°å®šæ—¶å™¨è¿è¡Œ
    ensureExecutionTicker();
    
    calculateExpectedTimes();
    renderExecutionList();
    updateExecutionDisplay();
  } else {
    phaseFormEl.style.display = "block";
    activitiesFormEl.style.display = "none";
    executionPanelEl.style.display = "none";
    reviewFormEl.style.display = "none";
  }
}

// æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
createPhaseBtn.addEventListener("click", createPhase);
addActivityBtn.addEventListener("click", addActivity);
startPhaseBtn.addEventListener("click", () => {
  if (!currentPhase || currentPhase.activities.length === 0) {
    statusEl.setText("è¯·å…ˆæ·»åŠ æ´»åŠ¨");
    statusEl.setAttribute("style", "color: red;");
    return;
  }
  
  // æ›´æ–°é˜¶æ®µçŠ¶æ€
  currentPhase.status = 'active';
  currentPhase.startTime = new Date(); // ä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºå®é™…å¼€å§‹æ—¶é—´
  currentPhase.lastTransitionTime = new Date();
  
  // å¼€å§‹ç¬¬ä¸€ä¸ªæ´»åŠ¨
  currentPhase.activities[0].status = 'in-progress';
  currentPhase.activities[0].actualStart = new Date();
  
  // æ›´æ–°UIçŠ¶æ€
  lastUIState = { phase: 'active', timestamp: Date.now() };
  
  // æ˜¾ç¤ºæ‰§è¡Œé¢æ¿
  phaseFormEl.style.display = "none";
  activitiesFormEl.style.display = "none";
  executionPanelEl.style.display = "block";
  
  // å¯åŠ¨å®šæ—¶å™¨
  ensureExecutionTicker();
  debouncedSave();
  // æ›´æ–°é¦–æ¬¡æ˜¾ç¤º
  calculateExpectedTimes();
  renderExecutionList();
  updateExecutionDisplay();
  
  // ä¿å­˜åˆ°localStorage

});

nextActivityBtn.addEventListener("click", startNextActivity);
finishPhaseBtn.addEventListener("click", completePhase);

// ç¡®ä¿é˜…è¯»/é¢„è§ˆæ¨¡å¼ä¹Ÿæœ‰å®šæ—¶åˆ·æ–°ï¼Œå¹¶ç«‹å³åˆ·æ–°ä¸€æ¬¡
ensureExecutionTicker();
updateExecutionDisplay();
extendDurationBtn.addEventListener("click", showExtendDurationModal);

// ================== â–¼â–¼â–¼ REPLACE your final initialization logic WITH THIS â–¼â–¼â–¼ ==================
async function initialize() {
  // **THE CRITICAL FIX**: Reset the global saving flag at the start of every run.
  // This makes the script self-healing if a reload occurs mid-save.
  window.timePlannerIsSaving = false;

  // ä» JSON åŠ è½½ï¼ˆJSON æ˜¯å”¯ä¸€çš„æ•°æ®å­˜å‚¨ï¼‰
  const restored = await tryAutoRestoreFromJSON();
  if (restored) {
    currentPhase = restored;  // å…³é”®ï¼å°†æ¢å¤çš„æ•°æ®èµ‹å€¼ç»™ currentPhase
    showToast("âœ… å·²ä» JSON æ¢å¤æ•°æ®", "success");
  }

  // æ ¹æ®åŠ è½½çš„æ•°æ®è‡ªåŠ¨è¿›å…¥ç›¸åº”ç•Œé¢ï¼ˆè§„åˆ’æˆ–æ‰§è¡Œï¼‰
  initUIBasedOnPhaseStatus();
}

// Call the master initialization function to start the script.
initialize();
// ================== â–²â–²â–² REPLACE your final initialization logic WITH THIS â–²â–²â–² ==================


```
