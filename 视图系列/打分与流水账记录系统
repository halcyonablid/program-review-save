
```dataviewjs
// ============================================================
// ğŸ“Š æ—¶é—´ç»Ÿè®¡ä¸è¯„ä¼°è§†å›¾ (v6.1 JSONæé€Ÿç‰ˆ + æ‰‹åŠ¨æ—¶é—´)
// ============================================================

let startDate = null;
let endDate = null;

// --- 0. JSON å­˜å‚¨é…ç½® ---
const JSON_FILENAME = "TimeLog_Database.json";
const currentFolder = dv.current().file.folder;
const DB_PATH = currentFolder + "/" + JSON_FILENAME;
const SETTINGS_FILENAME = "TimeLog_Settings.json";
const SETTINGS_PATH = currentFolder + "/" + SETTINGS_FILENAME;
const DEFAULT_RANGE = { start: "2025-11-01", end: "2026-12-31" };
const COMMENT_FIELD = "comment";
const ITEM_FIELD = "äº‹é¡¹";

const generateId = () =>
    Date.now().toString(36) + Math.random().toString(36).slice(2, 6);

// --- 1. æ ¸å¿ƒäº¤äº’ç»„ä»¶ (UIä¿æŒä¸€è‡´) ---
class QuickSuggester extends obsidian.FuzzySuggestModal {
    constructor(app, items, onChoose) {
        super(app);
        this.items = items;
        this.onChoose = onChoose;
    }
    getItems() { return this.items; }
    getItemText(item) { return item; }
    onChooseItem(item, evt) { this.onChoose(item); }
}

class QuickPrompt extends obsidian.Modal {
    constructor(app, title, placeholder, onSubmit, defaultValue = "") {
        super(app);
        this.titleStr = title;
        this.placeholder = placeholder;
        this.defaultValue = defaultValue;
        this.onSubmit = onSubmit;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.createEl("h3", { text: this.titleStr });
        const inputContainer = contentEl.createDiv();
        const input = inputContainer.createEl("input", { type: "text", value: this.defaultValue });
        input.placeholder = this.placeholder;
        input.style.width = "100%";
        input.focus();
        
        const btnContainer = contentEl.createDiv({ style: "margin-top: 15px; text-align: right;" });
        const confirmBtn = btnContainer.createEl("button", { text: "ç¡®å®š", cls: "mod-cta" });
        const submit = () => { if(input.value) { this.close(); this.onSubmit(input.value); }};
        confirmBtn.onclick = submit;
        input.addEventListener("keypress", (e) => { if (e.key === "Enter") submit(); });
    }
    onClose() { this.contentEl.empty(); }
}

const prompt = (title, placeholder = "", defaultValue = "") => new Promise(r => new QuickPrompt(app, title, placeholder, r, defaultValue).open());
const suggester = (items) => new Promise(r => new QuickSuggester(app, items, r).open());

class RecordModal extends obsidian.Modal {
    constructor(app, existingItems, onFinish, initialRecord = null) {
        super(app);
        this.items = existingItems || [];
        this.onFinish = onFinish;
        this.submitted = false;
        this.initialRecord = initialRecord;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        const isEdit = !!this.initialRecord;
        contentEl.createEl("h3", { text: isEdit ? "âœï¸ ä¿®æ”¹æ—¶é—´è®°å½•" : "â• æ·»åŠ æ–°çš„æ—¶é—´è®°å½•" });

        if (this.modalEl) {
            this.modalEl.style.width = "720px";
            this.modalEl.style.maxWidth = "90vw";
        }

        const form = contentEl.createEl("div", {
            attr: { style: "display:flex; flex-direction:column; gap:12px; margin-top:10px;" }
        });

        const itemRow = form.createEl("div", { attr: { style: "display:flex; flex-direction:column; gap:6px;" } });
        itemRow.createEl("div", { text: "äº‹é¡¹", attr: { style: "font-weight:600;" } });
        const itemInput = itemRow.createEl("input", {
            type: "text",
            value: this.initialRecord?.item || "",
            attr: { placeholder: "ä¾‹å¦‚ï¼š3-ç¨³å¥æ‰§è¡Œ" }
        });
        itemInput.style.width = "100%";
        const dataListId = `timelog-item-list-${Date.now()}`;
        itemInput.setAttribute("list", dataListId);
        const itemList = itemRow.createEl("datalist", { attr: { id: dataListId } });
        this.items.forEach(it => itemList.createEl("option", { value: it }));

        const commentLabel = form.createEl("div", { text: "comment / è¯„è®º", attr: { style: "font-weight:600;" } });
        const commentArea = form.createEl("textarea", {
            attr: {
                rows: 10,
                maxlength: "1000",
                placeholder: "è®°å½•ä½ åšäº†ä»€ä¹ˆã€ä¸ºä»€ä¹ˆã€ç»“æœå¦‚ä½•..."
            }
        });
        commentArea.value = this.initialRecord?.comment || "";
        commentArea.style.width = "100%";
        commentArea.style.minHeight = "220px";
        commentArea.style.resize = "vertical";
        const counter = form.createEl("div", {
            text: "0/1000",
            attr: { style: "text-align:right; color:var(--text-muted); font-size:12px;" }
        });
        const updateCounter = () => { counter.textContent = `${commentArea.value.length}/1000`; };
        commentArea.addEventListener("input", updateCounter);
        updateCounter();

        const metaRow = form.createEl("div", { attr: { style: "display:flex; gap:12px; flex-wrap:wrap;" } });
        const timeCol = metaRow.createEl("div", { attr: { style: "flex:2 1 240px; display:flex; flex-direction:column; gap:6px;" } });
        timeCol.createEl("div", { text: "æ—¶é—´ (YYYY-MM-DD HH:mm)", attr: { style: "font-weight:600;" } });
        const timeInput = timeCol.createEl("input", {
            type: "text",
            value: this.initialRecord?.timestamp || moment().format("YYYY-MM-DD HH:mm"),
            attr: { placeholder: "YYYY-MM-DD HH:mm" }
        });

        const durationCol = metaRow.createEl("div", { attr: { style: "flex:1 1 120px; display:flex; flex-direction:column; gap:6px;" } });
        durationCol.createEl("div", { text: "è€—æ—¶(åˆ†é’Ÿ)", attr: { style: "font-weight:600;" } });
        const durationInput = durationCol.createEl("input", {
            type: "number",
            value: this.initialRecord?.duration ? String(this.initialRecord.duration) : "",
            attr: { placeholder: "90", min: "1" }
        });

        const scoreCol = metaRow.createEl("div", { attr: { style: "flex:1 1 120px; display:flex; flex-direction:column; gap:6px;" } });
        scoreCol.createEl("div", { text: "è¯„åˆ†(1-10)", attr: { style: "font-weight:600;" } });
        const scoreInput = scoreCol.createEl("input", {
            type: "number",
            value: this.initialRecord?.score ? String(this.initialRecord.score) : "",
            attr: { placeholder: "5", min: "1", max: "10" }
        });

        const actions = contentEl.createEl("div", { attr: { style: "display:flex; justify-content:flex-end; gap:10px; margin-top:14px;" } });
        const cancelBtn = actions.createEl("button", { text: "å–æ¶ˆ" });
        const okBtn = actions.createEl("button", { text: "ä¿å­˜", cls: "mod-cta" });

        const submit = () => {
            const comment = (commentArea.value || "").trim();
            if (!comment) { new Notice("è¯·è¾“å…¥ comment/è¯„è®º"); return; }
            if (comment.length > 1000) { new Notice("è¯„è®ºæœ€å¤š 1000 å­—"); return; }

            const item = (itemInput.value || "").trim();
            if (!item) { new Notice("è¯·è¾“å…¥äº‹é¡¹"); return; }

            const timestamp = (timeInput.value || "").trim();
            if (!moment(timestamp, "YYYY-MM-DD HH:mm", true).isValid()) {
                new Notice("æ—¶é—´æ ¼å¼åº”ä¸º YYYY-MM-DD HH:mm");
                return;
            }

            const duration = parseInt(durationInput.value, 10);
            if (!duration || duration <= 0) { new Notice("è¯·è¾“å…¥æ­£ç¡®çš„è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰"); return; }

            const score = parseInt(scoreInput.value, 10);
            if (!score || score < 1 || score > 10) { new Notice("è¯„åˆ†èŒƒå›´ 1-10"); return; }

            this.submitted = true;
            this.close();
            this.onFinish({ comment, item, timestamp, duration, score });
        };

        cancelBtn.onclick = () => { this.close(); };
        okBtn.onclick = submit;
        itemInput.focus();
    }
    onClose() {
        this.contentEl.empty();
        if (!this.submitted) this.onFinish(null);
    }
}

const openRecordModal = (existingItems = [], initialRecord = null) =>
    new Promise(res => new RecordModal(app, existingItems, res, initialRecord).open());

// --- 2. æ•°æ®å¤„ç†é€»è¾‘ (JSONæ ¸å¿ƒ) ---

const normalizeRecords = (raw) => {
    let records = {};
    let needsSave = false;

    if (Array.isArray(raw)) {
        raw.forEach(entry => {
            if (!entry || typeof entry !== "object") return;
            const id = entry.id || generateId();
            const cloned = { ...entry };
            if (cloned.id) delete cloned.id;
            records[id] = cloned;
        });
        needsSave = true;
    } else if (raw && typeof raw === "object") {
        if (raw.records && typeof raw.records === "object" && !Array.isArray(raw.records)) {
            records = { ...raw.records };
            needsSave = true;
        } else {
            records = { ...raw };
        }
    }

    Object.keys(records).forEach(id => {
        const rec = records[id];
        if (!rec || typeof rec !== "object") { delete records[id]; return; }
        if (rec.issue !== undefined && rec[COMMENT_FIELD] === undefined) {
            rec[COMMENT_FIELD] = rec.issue;
            delete rec.issue;
            needsSave = true;
        }
        if (rec.category !== undefined && rec[ITEM_FIELD] === undefined) {
            rec[ITEM_FIELD] = rec.category;
            delete rec.category;
            needsSave = true;
        }
        if (rec[COMMENT_FIELD] === undefined) { rec[COMMENT_FIELD] = ""; needsSave = true; }
        if (rec[ITEM_FIELD] === undefined) { rec[ITEM_FIELD] = ""; needsSave = true; }
        records[id] = rec;
    });

    return { records, needsSave };
};

// è¯»å– JSON
const loadData = async () => {
    if (!await app.vault.adapter.exists(DB_PATH)) return {};
    const content = await app.vault.adapter.read(DB_PATH);
    let raw = null;
    try { raw = JSON.parse(content); } catch (e) { return {}; }
    const { records, needsSave } = normalizeRecords(raw);
    if (needsSave) await saveData(records, true);
    return records;
};

// å†™å…¥ JSON
const saveData = async (newData, skipRender = false) => {
    const file = app.vault.getAbstractFileByPath(DB_PATH);
    const jsonString = JSON.stringify(newData, null, 2);
    if (file) await app.vault.modify(file, jsonString);
    else await app.vault.create(DB_PATH, jsonString);
    if (!skipRender) renderView(); // ä¿å­˜ååˆ·æ–°
};

const loadSettings = async () => {
    if (!await app.vault.adapter.exists(SETTINGS_PATH)) return { ...DEFAULT_RANGE };
    const content = await app.vault.adapter.read(SETTINGS_PATH);
    try {
        const data = JSON.parse(content);
        const start = data?.start || DEFAULT_RANGE.start;
        const end = data?.end || DEFAULT_RANGE.end;
        return { start, end };
    } catch (e) {
        return { ...DEFAULT_RANGE };
    }
};

const saveSettings = async (settings) => {
    const file = app.vault.getAbstractFileByPath(SETTINGS_PATH);
    const jsonString = JSON.stringify(settings, null, 2);
    if (file) await app.vault.modify(file, jsonString);
    else await app.vault.create(SETTINGS_PATH, jsonString);
};

const collectExistingItems = (allLogs = {}) => {
    const existingItems = new Set([
        "3-ç¨³å¥æ‰§è¡Œ", "4-ä¸ºè‡ªå·±çš„ç³»ç»Ÿè®¾è®¡", "2-å†å²çš„ä¿¡æ¯archieve", 
        "1-è§£å†³å¯¼è‡´å¡é¡¿çš„é—®é¢˜", "5-å‘å†å²çš„ä¸å®Œå¤‡åšå°å µ", 
        "6-ååŒåˆä½œç»Ÿåˆç»¼æ•ˆ", "2A-æ˜ç¡®é—®é¢˜å¸¦æ¥ä¿¡æ¯å¢é‡æ‰©å±•é—®é¢˜åœˆ"
    ]);
    Object.values(allLogs).forEach(log => {
        const item = log?.[ITEM_FIELD] || log?.category;
        if (item) existingItems.add(item);
    });
    return Array.from(existingItems).sort();
};

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ·»åŠ æ–°è®°å½•é€»è¾‘ï¼šæ”¯æŒè‡ªå®šä¹‰æ—¶é—´
async function addNewRecord() {
    let allLogs = await loadData();
    const itemList = collectExistingItems(allLogs);

    const result = await openRecordModal(itemList);
    if (!result) return;

    const newEntry = {
        timestamp: result.timestamp,
        [COMMENT_FIELD]: result.comment,
        [ITEM_FIELD]: result.item,
        duration: result.duration,
        score: Number(result.score)
    };

    const newId = generateId();
    allLogs[newId] = newEntry;

    await saveData(allLogs);
    new Notice(`âœ… è®°å½•å·²æ·»åŠ : ${result.timestamp}`);
}

async function editRecord(recordId) {
    const allLogs = await loadData();
    const oldRecord = allLogs?.[recordId];
    if (!oldRecord) {
        new Notice("æœªæ‰¾åˆ°è¯¥è®°å½•ï¼Œå¯èƒ½å·²è¢«åˆ é™¤");
        return;
    }

    const initialRecord = {
        timestamp: (oldRecord?.timestamp || "").toString(),
        comment: (oldRecord?.[COMMENT_FIELD] ?? oldRecord?.issue ?? "").toString(),
        item: (oldRecord?.[ITEM_FIELD] ?? oldRecord?.category ?? "").toString(),
        duration: Number(oldRecord?.duration) || 0,
        score: Number(oldRecord?.score) || 0
    };
    const itemList = collectExistingItems(allLogs);
    const result = await openRecordModal(itemList, initialRecord);
    if (!result) return;

    allLogs[recordId] = {
        ...oldRecord,
        timestamp: result.timestamp,
        [COMMENT_FIELD]: result.comment,
        [ITEM_FIELD]: result.item,
        duration: result.duration,
        score: Number(result.score)
    };
    delete allLogs[recordId].issue;
    delete allLogs[recordId].category;

    await saveData(allLogs);
    new Notice(`âœ… è®°å½•å·²ä¿®æ”¹: ${result.timestamp}`);
}

// --- 3. ä¸»æ¸²æŸ“é€»è¾‘ (å°è£…ä»¥ä¾¿è°ƒç”¨) ---
const renderView = async () => {
    dv.container.innerHTML = ""; // æ¸…ç©ºç”»å¸ƒ
    const rangeSettings = await loadSettings();
    const startStr = rangeSettings.start || DEFAULT_RANGE.start;
    const endStr = rangeSettings.end || DEFAULT_RANGE.end;
    const startMoment = moment(startStr, "YYYY-MM-DD", true);
    const endMoment = moment(endStr, "YYYY-MM-DD", true);
    const safeStart = startMoment.isValid() ? startMoment : moment(DEFAULT_RANGE.start, "YYYY-MM-DD", true);
    const safeEnd = endMoment.isValid() ? endMoment : moment(DEFAULT_RANGE.end, "YYYY-MM-DD", true);
    startDate = safeStart.startOf("day").toDate();
    endDate = safeEnd.endOf("day").toDate();

    if (!startMoment.isValid() || !endMoment.isValid()) {
        await saveSettings({ start: safeStart.format("YYYY-MM-DD"), end: safeEnd.format("YYYY-MM-DD") });
    }

    const logs = await loadData();
    const logEntries = Object.entries(logs || {});
    
    if (logEntries.length === 0 && !await app.vault.adapter.exists(DB_PATH)) {
        dv.paragraph(`âš ï¸ æœªæ‰¾åˆ°æ•°æ®åº“: <code>${JSON_FILENAME}</code><br>è¯·ç¡®ä¿å·²è¿è¡Œè¿ç§»è„šæœ¬ï¼Œå¹¶å°†æ–‡ä»¶æ”¾ç½®åœ¨å½“å‰ç›®å½•ã€‚`);
        return;
    }

    // é¢„å¤„ç†æ•°æ®ä»¥ä¾¿æ˜¾ç¤º
    let allEntries = [];
    for (const [recordId, log] of logEntries) {
        let logDate = new Date(log.timestamp);
        if (isNaN(logDate.getTime())) continue;
        const comment = (log?.[COMMENT_FIELD] ?? log?.issue ?? "").toString();
        const itemName = (log?.[ITEM_FIELD] ?? log?.category ?? "").toString();

        if (logDate >= startDate && logDate <= endDate) {
            allEntries.push({
                id: recordId,
                dateObj: logDate,
                dateStr: moment(logDate).format("YYYY-MM-DD"),
                timeStr: moment(logDate).format("HH:mm"),
                comment: comment,
                item: itemName,
                durationMin: Number(log.duration) || 0,
                score: Number(log.score) || 0
            });
        }
    }

    // æ ¼å¼åŒ–å‡½æ•°
    function formatMin(m) {
        if(!m) return "0m";
        if(m < 60) return `${m}m`;
        const h = Math.floor(m / 60);
        const min = m % 60;
        return min > 0 ? `${h}h ${min}m` : `${h}h`;
    }

    function goldenAngleColor(idx, total) {
        const GOLDEN_ANGLE = 137.508;
        const hue = (idx * GOLDEN_ANGLE) % 360;
        const satLevels = [60, 70, 80, 55, 85];
        const lightLevels = [58, 66, 50, 72, 44];
        const cycle = Math.floor(idx / 360);
        const sat = satLevels[cycle % satLevels.length];
        const light = lightLevels[Math.floor(cycle / satLevels.length) % lightLevels.length];
        return {
            fill: `hsl(${hue},${sat}%,${light}%)`,
            border: `hsl(${hue},${Math.min(90, sat + 10)}%,${Math.max(30, light - 18)}%)`,
        };
    }

    // æ¸²æŸ“æŒ‰é’®
    const btnContainer = dv.el("div", "", { attr: { style: "margin-bottom: 20px; padding: 15px; background: var(--background-primary-alt); border: 1px dashed var(--background-modifier-border); border-radius: 8px;" }});

    const rangeRow = btnContainer.createEl("div", {
        attr: { style: "display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;" }
    });
    rangeRow.createEl("span", { text: "ğŸ“… å±•ç¤ºèŒƒå›´:", attr: { style: "font-weight:600;" } });
    const startInput = rangeRow.createEl("input", { type: "date", value: safeStart.format("YYYY-MM-DD") });
    const endInput = rangeRow.createEl("input", { type: "date", value: safeEnd.format("YYYY-MM-DD") });
    const saveRangeBtn = rangeRow.createEl("button", { text: "ä¿å­˜èŒƒå›´", cls: "mod-cta" });

    saveRangeBtn.onclick = async () => {
        if (!startInput.value || !endInput.value) { new Notice("è¯·è¾“å…¥å¼€å§‹/ç»“æŸæ—¥æœŸ"); return; }
        if (moment(endInput.value).isBefore(moment(startInput.value))) { new Notice("ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹"); return; }
        await saveSettings({ start: startInput.value, end: endInput.value });
        renderView();
    };

    const addRow = btnContainer.createEl("div", { attr: { style: "text-align:center;" } });
    const btn = addRow.createEl("button", { text: "â• æ·»åŠ æ–°çš„æ—¶é—´è®°å½•", attr: { style: "background-color: var(--interactive-accent); color: var(--text-on-accent); padding: 8px 24px; font-weight: bold; cursor: pointer; border-radius: 6px; border: none; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" }});
    btn.onclick = addNewRecord;

    if (allEntries.length === 0) {
        dv.paragraph("ğŸ“ è¿˜æ²¡æœ‰æ•°æ®ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è®°å½•ï¼");
    } else {
        const group = allEntries.reduce((acc, e) => {
            if (!acc[e.dateStr]) acc[e.dateStr] = [];
            acc[e.dateStr].push(e);
            return acc;
        }, {});

        let allItems = Array.from(new Set(allEntries.map(e => e.item))).sort();
        const colorPairMap = {};
        allItems.forEach((item, idx) => {
            colorPairMap[item] = goldenAngleColor(idx, allItems.length);
        });

        // 1. å †å å›¾
        dv.header(3, "ğŸ“Š è´¨é‡è¯„ä¼°å †å å›¾");
        const blockHeight = 60;
        const minChartHeight = 280;
        let chartHtml = `<div style="display:flex;align-items:flex-end;gap:12px;overflow-x:auto;padding: 10px 0;">`;
        
        Object.keys(group).sort().forEach(date => {
            const entries = group[date].sort((a, b) => b.score - a.score);
            let stack = entries.map(e => {
                const color = colorPairMap[e.item] || {fill:"#ddd", border:"#444"};
                let shortItem = e.item.split('-')[1] || e.item; 
                if(shortItem.length > 4) shortItem = shortItem.substring(0,4)+"..";
                const commentTitle = (e.comment || "").replace(/\n/g, " ");
                
                return `<div style="width:50px;height:${blockHeight}px;background:${color.fill};border:2px solid ${color.border};border-radius:6px;margin-bottom:3px;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;box-sizing: border-box;transition: transform 0.1s;" 
                    data-record-id="${e.id}"
                    title="${e.timeStr} | ${e.item}\nè¯„è®º: ${commentTitle}\nè€—æ—¶: ${e.durationMin}åˆ†é’Ÿ\nè¯„åˆ†: ${e.score}\nç‚¹å‡»å¯ç¼–è¾‘" 
                    onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <span style="font-size:15px;font-weight:bold;color:#222;line-height:1.2;">${e.score}</span>
                    <span style="font-size:9px;color:#444;width:44px;text-align:center;overflow:hidden;white-space:nowrap;">${shortItem}</span>
                </div>`;
            }).join('');
            
            const dayTotal = entries.reduce((a,b)=>a+b.durationMin,0);
            chartHtml += `<div style="display:flex;flex-direction:column;justify-content:flex-end;align-items:center;min-height:${minChartHeight}px;">
                ${stack}
                <div style="margin-top:5px;font-size:12px;font-weight:bold;color:var(--text-muted);">${date.slice(5)}</div>
                <div style="font-size:10px;color:var(--text-faint);">${formatMin(dayTotal)}</div>
            </div>`;
        });
        chartHtml += `</div>`;
        const chartContainer = dv.el("div", "", { attr: { style: "margin-top: 2px;" } });
        chartContainer.innerHTML = chartHtml;
        chartContainer.querySelectorAll("[data-record-id]").forEach(block => {
            const recordId = block.getAttribute("data-record-id");
            block.addEventListener("click", (evt) => {
                evt.preventDefault();
                evt.stopPropagation();
                if (recordId) editRecord(recordId);
            });
        });

        // å›¾ä¾‹
        let legendHtml = `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;margin-bottom:30px;padding:10px;background:var(--background-secondary);border-radius:6px;">`;
        allItems.forEach(item => {
            const c = colorPairMap[item];
            legendHtml += `<span style="padding:2px 8px;border-radius:4px;background:${c.fill};border:1px solid ${c.border};font-size:12px;color:var(--text-normal);">${item}</span>`;
        });
        legendHtml += `</div>`;
        dv.paragraph(legendHtml);

        // 2. è¡¨æ ¼
        let tableData = [];
        Object.keys(group).sort().reverse().forEach(date => {
            const entries = group[date].sort((a, b) => b.dateObj - a.dateObj);
            const totalMin = entries.reduce((a, b) => a + b.durationMin, 0);
            
            entries.forEach((e, i) => {
                tableData.push([
                    i === 0 ? `**${date}**` : "",
                    e.timeStr,
                    e.item,
                    e.comment,
                    formatMin(e.durationMin),
                    e.score,
                    i === 0 ? formatMin(totalMin) : ""
                ]);
            });
        });
        const details = dv.el("details", "", { attr: { style: "margin-top:6px;" } });
        details.createEl("summary", { text: "ğŸ“‹ è¯¦ç»†è®°å½•è¡¨", attr: { style: "cursor:pointer; font-weight:600;" } });

        const headers = ["æ—¥æœŸ", "æ—¶åˆ»", "äº‹é¡¹", "comment/è¯„è®º", "è€—æ—¶", "è¯„åˆ†", "æ—¥åˆè®¡"];
        const table = details.createEl("table", { cls: "dataview table-view-table" });
        const thead = table.createEl("thead");
        const headerRow = thead.createEl("tr");
        headers.forEach(h => headerRow.createEl("th", { text: h }));

        const tbody = table.createEl("tbody");
        tableData.forEach(row => {
            const tr = tbody.createEl("tr");
            row.forEach(cell => {
                const td = tr.createEl("td");
                const text = (cell ?? "").toString();
                const boldMatch = text.match(/^\*\*(.*)\*\*$/);
                if (boldMatch) {
                    td.createEl("strong", { text: boldMatch[1] });
                } else {
                    td.setText(text);
                }
            });
        });
    }
};

// å¯åŠ¨
renderView();

```

```dataviewjs
/*
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æ‰“åˆ†ç³»ç»Ÿ - å•é¡µé¢å†…è”è¯„åˆ†è§†å›¾ v2.3                                   â•‘
â•‘  åŠŸèƒ½: æ ‡ç­¾é¡µåˆ‡æ¢ + JSONæŒä¹…åŒ– + çŠ¶æ€æ¢å¤ + å…¨å±€çŠ¶æ€ç®¡ç†               â•‘
â•‘  å¯å‘: å‚è€ƒæ—¶é—´çº¿è§†å›¾çš„ window.xxx å…¨å±€çŠ¶æ€ç®¡ç†                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨å±€çŠ¶æ€ç®¡ç† (åˆ·æ–°åä¿æŒ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æœ¬åœ°æ—¥æœŸæ ¼å¼åŒ–å‡½æ•° (é¿å… toISOString çš„ UTC æ—¶åŒºé—®é¢˜)
function getLocalDateString(date = new Date()) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

if (window.scoringTab === undefined) window.scoringTab = "score";
if (window.scoringViewMode === undefined) window.scoringViewMode = "unified";
if (window.scoringRangeMode === undefined) window.scoringRangeMode = "today";
if (window.scoringCustomDate === undefined) window.scoringCustomDate = getLocalDateString();
if (window.scoringScores === undefined) window.scoringScores = {};
// æµæ°´è´¦æ—¥æœŸç­›é€‰ (é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨ï¼Œè®¾ä¸€ä¸ªå¾ˆæ—©çš„å¼€å§‹æ—¥æœŸ)
if (window.scoringActivityStartDate === undefined) window.scoringActivityStartDate = "2024-01-01";
if (window.scoringActivityEndDate === undefined) window.scoringActivityEndDate = getLocalDateString();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é…ç½® - ä½¿ç”¨å½“å‰ç¬”è®°çš„æ–‡ä»¶å¤¹è·¯å¾„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// è·å–å½“å‰ç¬”è®°çš„æ–‡ä»¶å¯¹è±¡ï¼Œä»è€Œå¾—åˆ°å…¶æ‰€åœ¨æ–‡ä»¶å¤¹
const currentNote = dv.current().file.path;
const currentFolder = currentNote.substring(0, currentNote.lastIndexOf('/')) + '/';

const CONFIG = {
  dataPath: currentFolder,  // å½“å‰ç¬”è®°æ‰€åœ¨æ–‡ä»¶å¤¹
  scoresFile: "daily-scores.json",
  activityFile: "activity-log.json"
};

console.log("æ‰“åˆ†ç³»ç»Ÿæ•°æ®è·¯å¾„:", CONFIG.dataPath + CONFIG.scoresFile);

const DIMENSIONS = {
  D1: { name: "ç¡çœ è´¨é‡", layer: "ç‰©è´¨å±‚", icon: "ğŸŒ™", help: { 5: "â‰¥7.5h è‡ªç„¶é†’+ç²¾ç¥é¥±æ»¡", 4: "7-7.5h åŸºæœ¬è‡ªç„¶é†’", 3: "6-7h é—¹é’Ÿå«é†’", 2: "5-6h å¤šæ¬¡é—¹é’Ÿ", 1: "<5h ä¸¥é‡ä¸è¶³" }},
  D2: { name: "èƒ½é‡æ°´å¹³", layer: "ç‰©è´¨å±‚", icon: "âš¡", help: { 5: "å……æ²›æ— æ‰“å“ˆæ¬ ", 4: "å¶æœ‰ç–²å€¦èƒ½æ¢å¤", 3: "æœ‰ä¸€å®šç–²å€¦æ„Ÿ", 2: "é¢‘ç¹ç–²å€¦", 1: "å‡ ä¹æ— æ³•é›†ä¸­" }},
  D3: { name: "ç¯å¢ƒæ•´æ´åº¦", layer: "æ‰§è¡Œå±‚", icon: "ğŸ“¦", help: { 5: "ææ•´æ´æ— æ‚ç‰©", 4: "å°‘é‡ç‰©å“", 3: "æœ‰äº›ä¹±èƒ½æ‰¾", 2: "æ‚ç‰©è¾ƒå¤š", 1: "æ— æ³•å·¥ä½œ" }},
  D4: { name: "ä»»åŠ¡å¯åŠ¨æ•°", layer: "æ‰§è¡Œå±‚", icon: "ğŸš€", help: { 5: "â‰¥8ä¸ª", 4: "5-7ä¸ª", 3: "3-4ä¸ª", 2: "1-2ä¸ª", 1: "0ä¸ª" }},
  D5: { name: "ä»»åŠ¡å®Œæˆç‡", layer: "æ‰§è¡Œå±‚", icon: "âœ…", help: { 5: "â‰¥90%", 4: "70-89%", 3: "50-69%", 2: "25-49%", 1: "<25%" }},
  D6: { name: "ä¿¡æ¯æ”¶é›†é‡", layer: "å†³ç­–å±‚", icon: "ğŸ“š", help: { 5: "â‰¥5æ¬¡ä¸»åŠ¨æŸ¥è¯", 4: "3-4æ¬¡", 3: "1-2æ¬¡", 2: "ä»…è¢«åŠ¨æ¥æ”¶", 1: "æœªæ”¶é›†" }},
  D7: { name: "è®¡åˆ’è°ƒæ•´æ¬¡æ•°", layer: "å†³ç­–å±‚", icon: "ğŸ”„", help: { 5: "0æ¬¡å®Œå…¨æŒ‰è®¡åˆ’", 4: "1æ¬¡åˆç†è°ƒæ•´", 3: "2-3æ¬¡", 2: "4-5æ¬¡", 1: "â‰¥6æ¬¡å¤±æ§" }}
};

const LAYER_WEIGHTS = { "ç‰©è´¨å±‚": 0.30, "æ‰§è¡Œå±‚": 0.50, "å†³ç­–å±‚": 0.20 };
const LAYER_DIMS = { "ç‰©è´¨å±‚": ["D1", "D2"], "æ‰§è¡Œå±‚": ["D3", "D4", "D5"], "å†³ç­–å±‚": ["D6", "D7"] };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ•°æ®æ“ä½œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadData(fileName) {
  try {
    const path = CONFIG.dataPath + fileName;
    const file = app.vault.getAbstractFileByPath(path);
    if (!file) return null;
    return JSON.parse(await app.vault.read(file));
  } catch (e) { return null; }
}

// åˆå§‹åŒ–æ•°æ®æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
async function initDataFiles() {
  const initialData = { version: "1.0", records: [], lastUpdated: new Date().toISOString() };

  // æ£€æŸ¥å¹¶åˆ›å»º daily-scores.json
  const scoresPath = CONFIG.dataPath + CONFIG.scoresFile;
  try {
    const scoresFile = app.vault.getAbstractFileByPath(scoresPath);
    if (!scoresFile) {
      await app.vault.create(scoresPath, JSON.stringify(initialData, null, 2));
    }
  } catch (e) {
    if (!e.message.includes("already exists")) {
      console.error("å¤„ç† daily-scores.json å¤±è´¥:", e);
    }
  }

  // æ£€æŸ¥å¹¶åˆ›å»º activity-log.json
  const activityPath = CONFIG.dataPath + CONFIG.activityFile;
  try {
    const activityFile = app.vault.getAbstractFileByPath(activityPath);
    if (!activityFile) {
      await app.vault.create(activityPath, JSON.stringify(initialData, null, 2));
    }
  } catch (e) {
    if (!e.message.includes("already exists")) {
      console.error("å¤„ç† activity-log.json å¤±è´¥:", e);
    }
  }
}

async function saveScoreRecord(date, scores, layerScores, dailyAvg) {
  try {
    const path = CONFIG.dataPath + CONFIG.scoresFile;
    console.log("ä¿å­˜è¯„åˆ†åˆ°:", path);
    let data = { version: "1.0", records: [], lastUpdated: new Date().toISOString() };

    // é‡æ–°è·å–æ–‡ä»¶å¼•ç”¨
    let file = app.vault.getAbstractFileByPath(path);
    console.log("è¯„åˆ†æ–‡ä»¶å­˜åœ¨:", !!file);
    if (file) {
      data = JSON.parse(await app.vault.read(file));
    } else {
      console.error("æ‰¾ä¸åˆ°æ–‡ä»¶:", path);
      return false;
    }

    const existingIdx = data.records.findIndex(r => r.date === date);
    if (existingIdx >= 0) {
      data.records[existingIdx] = { ...data.records[existingIdx], scores, layer_scores: layerScores, daily_avg: dailyAvg };
    } else {
      data.records.push({ id: crypto.randomUUID(), date, scores, layer_scores: layerScores, daily_avg: dailyAvg, timestamp: new Date().toISOString() });
    }
    data.lastUpdated = new Date().toISOString();

    // å†æ¬¡è·å–æ–‡ä»¶å¼•ç”¨è¿›è¡Œä¿®æ”¹
    file = app.vault.getAbstractFileByPath(path);
    if (file) {
      await app.vault.modify(file, JSON.stringify(data, null, 2));
      return true;
    }
    return false;
  } catch (e) { console.error("ä¿å­˜è¯„åˆ†å¤±è´¥:", e); return false; }
}

async function saveActivityRecord(record) {
  try {
    const path = CONFIG.dataPath + CONFIG.activityFile;
    console.log("ä¿å­˜æµæ°´è´¦åˆ°:", path);
    let data = { version: "1.0", records: [], lastUpdated: new Date().toISOString() };

    // é‡æ–°è·å–æ–‡ä»¶å¼•ç”¨
    let file = app.vault.getAbstractFileByPath(path);
    console.log("æµæ°´è´¦æ–‡ä»¶å­˜åœ¨:", !!file);
    if (file) {
      data = JSON.parse(await app.vault.read(file));
    } else {
      console.error("æ‰¾ä¸åˆ°æ–‡ä»¶:", path);
      return false;
    }

    data.records.push({ ...record, id: crypto.randomUUID(), created_at: new Date().toISOString() });
    data.lastUpdated = new Date().toISOString();

    // å†æ¬¡è·å–æ–‡ä»¶å¼•ç”¨è¿›è¡Œä¿®æ”¹
    file = app.vault.getAbstractFileByPath(path);
    if (file) {
      await app.vault.modify(file, JSON.stringify(data, null, 2));
      return true;
    }
    return false;
  } catch (e) {
    console.error("ä¿å­˜æµæ°´è´¦å¤±è´¥:", e);
    return false;
  }
}

function getLevel(score) {
  if (score >= 4.5) return "ğŸŸ¢ å“è¶Š";
  if (score >= 3.5) return "ğŸŸ¢ è‰¯å¥½";
  if (score >= 2.5) return "ğŸŸ¡ ä¸€èˆ¬";
  if (score >= 1.5) return "ğŸŸ  æ¬ ä½³";
  return "ğŸ”´ å‘Šè­¦";
}

function getLevelClass(score) {
  if (score >= 4.5) return "level-excellent";
  if (score >= 3.5) return "level-good";
  if (score >= 2.5) return "level-normal";
  if (score >= 1.5) return "level-poor";
  return "level-bad";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸»æ¸²æŸ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function main() {
  // å…ˆåˆå§‹åŒ–æ•°æ®æ–‡ä»¶
  await initDataFiles();

  const container = dv.container;
  container.innerHTML = "";

  // å¦‚æœæ²¡æœ‰ç”¨æˆ·é€‰æ‹©çš„è¯„åˆ†ï¼Œä»ä»Šæ—¥è¯„åˆ†åŠ è½½
  let scores = { ...window.scoringScores };
  const today = getLocalDateString();

  if (Object.keys(scores).length === 0) {
    const data = await loadData(CONFIG.scoresFile);
    const todayRecord = data?.records?.find(r => r.date === today);
    if (todayRecord) scores = { ...todayRecord.scores };
  }

  let message = { text: "", type: "", show: false };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // é¡¶éƒ¨æ§åˆ¶æ 
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const header = container.createEl("div", { cls: "scoring-header" });
  header.createEl("h1", { text: "ğŸ“Š è¯„åˆ†ç³»ç»Ÿ" });

  const controls = header.createEl("div", { cls: "controls" });

  // è§†å›¾æ¨¡å¼åˆ‡æ¢
  const viewModes = [
    { id: "unified", label: "ğŸ“‹ ç»Ÿä¸€è§†å›¾" },
    { id: "separate", label: "ğŸ”€ åˆ†ç¦»è§†å›¾" }
  ];

  viewModes.forEach(mode => {
    const btn = controls.createEl("button", {
      cls: `control-btn ${window.scoringViewMode === mode.id ? "active" : ""}`,
      text: mode.label
    });
    btn.onclick = () => {
      window.scoringViewMode = mode.id;
      main();
    };
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ ‡ç­¾é¡µå¯¼èˆª (åˆ†ç¦»è§†å›¾æ¨¡å¼æ˜¾ç¤º)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const tabs = container.createEl("div", { cls: `tabs ${window.scoringViewMode === "unified" ? "hidden" : ""}` });
  const tabBtns = [
    { id: "score", label: "ğŸ“Š è¯„åˆ†" },
    { id: "activity", label: "ğŸ“‹ æµæ°´è´¦" },
    { id: "dashboard", text: "ğŸ“ˆ æ•°æ®" }
  ];

  tabBtns.forEach(tab => {
    const btn = tabs.createEl("button", {
      cls: `tab-btn ${window.scoringTab === tab.id ? "active" : ""}`,
      text: tab.label || tab.text
    });
    btn.onclick = () => { window.scoringTab = tab.id; main(); };
  });

  const content = container.createEl("div", { cls: "content" });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ¶ˆæ¯æç¤º
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function showMessage(text, type = "success") {
    message = { text, type, show: true };
    main();
    setTimeout(() => { message.show = false; main(); }, 3000);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ¸²æŸ“
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  if (window.scoringViewMode === "unified") {
    renderUnifiedView(content);
  } else {
    switch (window.scoringTab) {
      case "score": renderScoreView(content); break;
      case "activity": renderActivityView(content); break;
      case "dashboard": renderDashboardView(content); break;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç»Ÿä¸€è§†å›¾ (è¯„åˆ† + æµæ°´è´¦ + ä»ªè¡¨ç›˜ åŒå±æ˜¾ç¤º)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderUnifiedView(container) {
    const section = container.createEl("div", { cls: "unified-section" });

    // ç¬¬ä¸€è¡Œï¼šè¯„åˆ†å¡ç‰‡
    const scoreCard = section.createEl("div", { cls: "card score-card" });
    await renderScoreCard(scoreCard);

    // ç¬¬äºŒè¡Œï¼šæµæ°´è´¦ + ä»ªè¡¨ç›˜
    const bottomRow = section.createEl("div", { cls: "bottom-row" });

    const activitySection = bottomRow.createEl("div", { cls: "card half-card" });
    activitySection.createEl("h3", { text: "ğŸ“‹ æµæ°´è´¦" });
    await renderActivityForm(activitySection);

    const dashSection = bottomRow.createEl("div", { cls: "card half-card" });
    dashSection.createEl("h3", { text: "ğŸ“ˆ æ•°æ®" });
    await renderMiniDashboard(dashSection);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // è¯„åˆ†å¡ç‰‡ç»„ä»¶
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderScoreCard(container) {
    container.createEl("h2", { text: "ğŸ“Š ä»Šæ—¥è¯„åˆ†" });
    container.createEl("span", { text: getLocalDateString(), cls: "date-badge" });

    // è®¡ç®—
    const layerScores = {};
    for (const [layer, dims] of Object.entries(LAYER_DIMS)) {
      const sum = dims.reduce((s, d) => s + (scores[d] || 0), 0);
      layerScores[layer] = dims.length > 0 ? sum / dims.length : 0;
    }
    let dailyAvg = 0;
    for (const [layer, score] of Object.entries(layerScores)) {
      dailyAvg += score * LAYER_WEIGHTS[layer];
    }
    dailyAvg = Math.round(dailyAvg * 100) / 100;

    // åˆ†æ•°æ˜¾ç¤º
    const scoreDisplay = container.createEl("div", { cls: "score-display" });
    scoreDisplay.createEl("span", { text: dailyAvg.toFixed(1), cls: "big-score" });
    scoreDisplay.createEl("span", { text: "/5.0", cls: "unit" });
    scoreDisplay.createEl("span", { text: getLevel(dailyAvg), cls: `level-badge ${getLevelClass(dailyAvg)}` });

    // å±‚çº§è¿›åº¦æ¡
    const layersRow = container.createEl("div", { cls: "layers-row" });
    const layerColors = { "ç‰©è´¨å±‚": "#8b5cf6", "æ‰§è¡Œå±‚": "#06b6d4", "å†³ç­–å±‚": "#10b981" };
    for (const [layer, dims] of Object.entries(LAYER_DIMS)) {
      const item = layersRow.createEl("div", { cls: "layer-item" });
      item.createEl("div", { text: layer, cls: "layer-label" });
      const barBg = item.createEl("div", { cls: "bar-bg" });
      barBg.createEl("div", { cls: "bar-fill", style: `width: ${((layerScores[layer] || 0) / 5) * 100}%; background: ${layerColors[layer]}` });
      item.createEl("div", { text: (layerScores[layer] || 0).toFixed(2), cls: "layer-value" });
    }

    // ç»´åº¦è¯„åˆ†
    const dimsContainer = container.createEl("div", { cls: "dims-container" });

    // D1-D7 è¯´æ˜
    const helpToggle = container.createEl("div", { cls: "help-toggle" });
    const helpBtn = helpToggle.createEl("button", { text: "ğŸ“– D1-D7 è¯´æ˜", cls: "help-btn" });
    const helpContent = helpToggle.createEl("div", { cls: "help-content", style: "display: none;" });

    helpBtn.onclick = () => {
      if (helpContent.style.display === "none") {
        helpContent.style.display = "block";
        helpBtn.textContent = "ğŸ“– æ”¶èµ·è¯´æ˜";
      } else {
        helpContent.style.display = "none";
        helpBtn.textContent = "ğŸ“– D1-D7 è¯´æ˜";
      }
    };

    // ç”Ÿæˆè¯´æ˜å†…å®¹
    const helpTable = helpContent.createEl("table", { cls: "help-table" });
    helpTable.innerHTML = `
      <tr><th>ç»´åº¦</th><th>åç§°</th><th>å±‚çº§</th><th>5åˆ†æ ‡å‡†</th><th>1åˆ†æ ‡å‡†</th></tr>
      <tr><td>D1</td><td>ç¡çœ è´¨é‡</td><td>ç‰©è´¨å±‚</td><td>â‰¥7.5h è‡ªç„¶é†’+ç²¾ç¥é¥±æ»¡</td><td><5h ä¸¥é‡ä¸è¶³</td></tr>
      <tr><td>D2</td><td>èƒ½é‡æ°´å¹³</td><td>ç‰©è´¨å±‚</td><td>å……æ²›æ— æ‰“å“ˆæ¬ </td><td>å‡ ä¹æ— æ³•é›†ä¸­</td></tr>
      <tr><td>D3</td><td>ç¯å¢ƒæ•´æ´åº¦</td><td>æ‰§è¡Œå±‚</td><td>ææ•´æ´æ— æ‚ç‰©</td><td>æ— æ³•å·¥ä½œ</td></tr>
      <tr><td>D4</td><td>ä»»åŠ¡å¯åŠ¨æ•°</td><td>æ‰§è¡Œå±‚</td><td>â‰¥8ä¸ª</td><td>0ä¸ª</td></tr>
      <tr><td>D5</td><td>ä»»åŠ¡å®Œæˆç‡</td><td>æ‰§è¡Œå±‚</td><td>â‰¥90%</td><td><25%</td></tr>
      <tr><td>D6</td><td>ä¿¡æ¯æ”¶é›†é‡</td><td>å†³ç­–å±‚</td><td>â‰¥5æ¬¡ä¸»åŠ¨æŸ¥è¯</td><td>æœªæ”¶é›†</td></tr>
      <tr><td>D7</td><td>è®¡åˆ’è°ƒæ•´æ¬¡æ•°</td><td>å†³ç­–å±‚</td><td>0æ¬¡å®Œå…¨æŒ‰è®¡åˆ’</td><td>â‰¥6æ¬¡å¤±æ§</td></tr>
    `;

    ["ç‰©è´¨å±‚", "æ‰§è¡Œå±‚", "å†³ç­–å±‚"].forEach(layer => {
      const layerGroup = dimsContainer.createEl("div", { cls: "layer-group" });
      layerGroup.createEl("div", { text: `${layer} (${LAYER_WEIGHTS[layer] * 100}%)`, cls: "layer-title" });

      LAYER_DIMS[layer].forEach(dimId => {
        const dim = DIMENSIONS[dimId];
        const dimRow = layerGroup.createEl("div", { cls: "dim-row" });

        dimRow.createEl("span", { text: `${dim.icon} ${dimId}`, cls: "dim-icon" });
        dimRow.createEl("span", { text: dim.name, cls: "dim-name" });

        const btnRow = dimRow.createEl("div", { cls: "btn-row" });
        [1, 2, 3, 4, 5].forEach(s => {
          const btn = btnRow.createEl("button", {
            cls: `score-btn ${scores[dimId] === s ? "selected" : ""} score-${s}`,
            text: s
          });
          btn.onclick = () => { window.scoringScores[dimId] = s; main(); };
        });

        if (scores[dimId]) {
          dimRow.createEl("span", { text: dim.help[scores[dimId]], cls: "anchor-text" });
        }
      });
    });

    // æ“ä½œæŒ‰é’®
    const actionRow = container.createEl("div", { cls: "action-row" });
    const saveBtn = actionRow.createEl("button", { text: "ğŸ’¾ ä¿å­˜è¯„åˆ†", cls: "btn save-btn" });
    const clearBtn = actionRow.createEl("button", { text: "ğŸ—‘ï¸ æ¸…ç©º", cls: "btn clear-btn" });

    saveBtn.onclick = async () => {
      const allScored = Object.keys(DIMENSIONS).every(d => scores[d]);
      if (!allScored) { showMessage("âš ï¸ è¯·å®Œæˆæ‰€æœ‰7ä¸ªç»´åº¦çš„è¯„åˆ†", "error"); return; }
      if (await saveScoreRecord(getLocalDateString(), scores, layerScores, dailyAvg)) {
        showMessage(`âœ… å·²ä¿å­˜ï¼æ—¥å‡åˆ†: ${dailyAvg.toFixed(1)}/5.0`, "success");
      } else { showMessage("âŒ ä¿å­˜å¤±è´¥", "error"); }
    };

    clearBtn.onclick = () => { window.scoringScores = {}; main(); };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æµæ°´è´¦è¡¨å•ç»„ä»¶
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function refreshActivityList(listContainer) {
    listContainer.innerHTML = "";
    const today = getLocalDateString();
    const data = await loadData(CONFIG.activityFile);
    const todayRecords = data?.records?.filter(r => r.datetime.startsWith(today)) || [];
    todayRecords.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).slice(0, 5).forEach(r => {
      const item = listContainer.createEl("div", { cls: "activity-item-sm" });
      item.createEl("span", { text: r.datetime.slice(11, 16), cls: "item-time-sm" });
      item.createEl("span", { text: r.activity, cls: "item-desc-sm" });
    });
  }

  async function renderActivityForm(container) {
    const form = container.createEl("div", { cls: "activity-form" });

    // æ—¶é—´ + äº‹é¡¹
    const row1 = form.createEl("div", { cls: "form-row" });
    const timeInput = row1.createEl("input", { type: "time", cls: "time-input", value: new Date().toTimeString().slice(0, 5) });
    const activityInput = row1.createEl("input", { type: "text", placeholder: "åšçš„äº‹é¡¹...", cls: "activity-input" });

    // åˆ¤æ®
    const row2 = form.createEl("div", { cls: "form-row" });
    const criterionInput = row2.createEl("input", { type: "text", placeholder: "åˆ¤æ®/ä¾æ®...", cls: "criterion-input" });

    // ç»´åº¦æ ‡ç­¾
    const tagRow = form.createEl("div", { cls: "tag-row" });
    tagRow.createEl("span", { text: "ç»´åº¦:", cls: "tag-label" });
    const selectedTags = new Set();

    Object.keys(DIMENSIONS).forEach(dim => {
      const tag = tagRow.createEl("span", { cls: "dim-tag", text: dim });
      tag.onclick = () => {
        if (selectedTags.has(dim)) { selectedTags.delete(dim); tag.classList.remove("selected"); }
        else { selectedTags.add(dim); tag.classList.add("selected"); }
      };
    });

    // åæ€
    const ref1Row = form.createEl("div", { cls: "form-row" });
    ref1Row.createEl("span", { text: "äºŒæ¬¡:", cls: "ref-label" });
    const ref1Input = ref1Row.createEl("input", { type: "text", placeholder: "åæ€...", cls: "ref-input" });

    const ref2Row = form.createEl("div", { cls: "form-row" });
    ref2Row.createEl("span", { text: "ä¸‰æ¬¡:", cls: "ref-label" });
    const ref2Input = ref2Row.createEl("input", { type: "text", placeholder: "æ·±æ€è€ƒ...", cls: "ref-input" });

    // æ·»åŠ æŒ‰é’®
    const addBtnRow = form.createEl("div", { cls: "add-btn-row" });
    const addBtn = addBtnRow.createEl("button", { text: "â• æ·»åŠ ", cls: "btn add-btn" });
    const msgSpan = addBtnRow.createEl("span", { cls: "msg" });

    addBtn.onclick = async () => {
      if (!activityInput.value.trim()) { msgSpan.textContent = "âš ï¸ å¡«å†™äº‹é¡¹"; msgSpan.className = "msg error"; return; }
      const record = {
        datetime: `${getLocalDateString()} ${timeInput.value}`,
        activity: activityInput.value.trim(),
        criterion: criterionInput.value.trim(),
        reflection_1: ref1Input.value.trim(),
        reflection_2: ref2Input.value.trim(),
        related_dimensions: Array.from(selectedTags)
      };
      const result = await saveActivityRecord(record);
      if (result) {
        msgSpan.textContent = "âœ… å·²æ·»åŠ "; msgSpan.className = "msg success";
        activityInput.value = criterionInput.value = ref1Input.value = ref2Input.value = "";
        selectedTags.clear(); document.querySelectorAll(".dim-tag").forEach(t => t.classList.remove("selected"));
        // åˆ·æ–°åˆ—è¡¨
        await refreshActivityList(listContainer);
      } else {
        msgSpan.innerHTML = "âŒ å¤±è´¥<br><small>è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯</small>";
        msgSpan.className = "msg error";
      }
    };

    // ä»Šæ—¥åˆ—è¡¨
    const listContainer = container.createEl("div", { cls: "activity-list-sm" });
    await refreshActivityList(listContainer);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // è¿·ä½ ä»ªè¡¨ç›˜ç»„ä»¶
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderMiniDashboard(container) {
    const data = await loadData(CONFIG.scoresFile);
    const today = getLocalDateString();
    const todayRecord = data?.records?.find(r => r.date === today);

    // ä»Šæ—¥æ¦‚è§ˆ
    if (todayRecord) {
      const row = container.createEl("div", { cls: "mini-score-row" });
      row.createEl("span", { text: todayRecord.daily_avg.toFixed(1), cls: "mini-score" });
      row.createEl("span", { text: "/5.0", cls: "mini-unit" });
      row.createEl("span", { text: getLevel(todayRecord.daily_avg), cls: `mini-level ${getLevelClass(todayRecord.daily_avg)}` });
    } else {
      container.createEl("div", { text: "ä»Šæ—¥æš‚æ— è¯„åˆ†", cls: "empty-text" });
    }

    // ç»´åº¦æ ¼å­
    if (todayRecord) {
      const grid = container.createEl("div", { cls: "dims-grid-sm" });
      Object.entries(todayRecord.scores).forEach(([dimId, score]) => {
        const box = grid.createEl("div", { cls: `dim-box-sm score-${score}` });
        box.createEl("span", { text: dimId, cls: "dim-id-sm" });
        box.createEl("span", { text: score, cls: "dim-score-sm" });
      });
    }

    // è¿‘æœŸè¶‹åŠ¿
    if (data?.records?.length > 0) {
      const recent = data.records.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 7).reverse();
      const trend = container.createEl("div", { cls: "mini-trend" });
      recent.forEach(d => {
        const row = trend.createEl("div", { cls: "trend-row-sm" });
        row.createEl("span", { text: d.date.slice(5), cls: "trend-date-sm" });
        const barLen = Math.round((d.daily_avg / 5) * 10);
        row.createEl("span", { text: "â–ˆ".repeat(barLen) + "â–‘".repeat(10 - barLen), cls: "trend-bar-sm" });
        row.createEl("span", { text: d.daily_avg.toFixed(1), cls: "trend-val-sm" });
      });
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // åˆ†ç¦»è§†å›¾ - è¯„åˆ†é¡µ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderScoreView(container) {
    const section = container.createEl("div", { cls: "tab-section" });
    await renderScoreCard(section);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // åˆ†ç¦»è§†å›¾ - æµæ°´è´¦é¡µ (å¸¦ç¼–è¾‘å¼¹çª—)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderActivityView(container) {
    const section = container.createEl("div", { cls: "tab-section" });
    section.createEl("h2", { text: "ğŸ“‹ æµæ°´è´¦è®°å½•" });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ–°å¢è¡¨å• (ç®€åŒ–ä¸ºä¸€è¡Œ)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const addRow = section.createEl("div", { cls: "activity-add-row" });
    const addTime = addRow.createEl("input", { type: "time", cls: "add-time-input", value: new Date().toTimeString().slice(0, 5) });
    const addActivity = addRow.createEl("input", { type: "text", placeholder: "åšçš„äº‹é¡¹...", cls: "add-activity-input" });
    const addBtn = addRow.createEl("button", { text: "â• æ·»åŠ ", cls: "btn add-btn" });
    const addMsg = addRow.createEl("span", { cls: "add-msg" });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ—¥æœŸç­›é€‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const filterRow = section.createEl("div", { cls: "activity-filter-row" });
    filterRow.createEl("span", { text: "ğŸ“… ç­›é€‰:", cls: "filter-label" });
    const startDateInput = filterRow.createEl("input", { type: "date", cls: "date-input", value: window.scoringActivityStartDate });
    filterRow.createEl("span", { text: "è‡³", cls: "filter-separator" });
    const endDateInput = filterRow.createEl("input", { type: "date", cls: "date-input", value: window.scoringActivityEndDate });
    const filterBtn = filterRow.createEl("button", { text: "åº”ç”¨", cls: "btn filter-btn" });

    // æ—¥æœŸå˜æ›´ååˆ·æ–°
    filterBtn.onclick = () => {
      window.scoringActivityStartDate = startDateInput.value;
      window.scoringActivityEndDate = endDateInput.value;
      main();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // è®°å½•åˆ—è¡¨ (ç‚¹å‡»ç¼–è¾‘)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const listHeader = section.createEl("div", { cls: "activity-list-header" });
    listHeader.createEl("h3", { text: `ğŸ“œ ${window.scoringActivityStartDate} è‡³ ${window.scoringActivityEndDate} çš„è®°å½• (ç‚¹å‡»ç¼–è¾‘)` });

    const listContainer = section.createEl("div", { cls: "activity-list-full" });

    // åŠ è½½å¹¶æ˜¾ç¤ºç­›é€‰èŒƒå›´å†…çš„è®°å½•
    const data = await loadData(CONFIG.activityFile);
    const filteredRecords = data?.records?.filter(r => {
      const recordDate = r.datetime.split("T")[0];
      return recordDate >= window.scoringActivityStartDate && recordDate <= window.scoringActivityEndDate;
    }) || [];

    filteredRecords.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).forEach(r => {
      const item = listContainer.createEl("div", { cls: "activity-item-full" });
      item.style.cursor = "pointer";

      const itemHeader = item.createEl("div", { cls: "item-header-full" });
      itemHeader.createEl("span", { text: r.datetime.slice(5, 10), cls: "item-date-full" });
      itemHeader.createEl("span", { text: r.datetime.slice(11, 16), cls: "item-time-full" });
      itemHeader.createEl("span", { text: r.activity, cls: "item-desc-full" });

      // æœ‰å†…å®¹å°±å±•ç¤º
      if (r.criterion) {
        item.createEl("div", { text: `ğŸ“Š ${r.criterion}`, cls: "item-criterion-full" });
      }
      if (r.reflection_1) {
        item.createEl("div", { text: `ğŸ’­ ${r.reflection_1}`, cls: "item-reflection-full" });
      }
      if (r.reflection_2) {
        item.createEl("div", { text: `ğŸ”® ${r.reflection_2}`, cls: "item-reflection-full" });
      }
      if (r.related_dimensions?.length > 0) {
        const tagsDiv = item.createEl("div", { cls: "item-tags-full" });
        r.related_dimensions.forEach(d => tagsDiv.createEl("span", { text: d, cls: "tag-full" }));
      }

      // ç‚¹å‡»å¼¹å‡ºç¼–è¾‘å¼¹çª—
      item.onclick = () => showEditModal(r, data, listContainer);
    });

    if (filteredRecords.length === 0) {
      listContainer.createEl("div", { text: "æš‚æ— è®°å½•", cls: "empty-text" });
    }

    // æ·»åŠ æŒ‰é’®é€»è¾‘
    addBtn.onclick = async () => {
      if (!addActivity.value.trim()) { addMsg.textContent = "âš ï¸ å¡«å†™äº‹é¡¹"; addMsg.className = "add-msg error"; return; }
      const record = {
        datetime: `${getLocalDateString()} ${addTime.value}`,
        activity: addActivity.value.trim()
      };
      const result = await saveActivityRecord(record);
      if (result) {
        addMsg.textContent = "âœ… å·²æ·»åŠ "; addMsg.className = "add-msg success";
        addActivity.value = "";
        main();
      } else {
        addMsg.textContent = "âŒ å¤±è´¥"; addMsg.className = "add-msg error";
      }
    };
  }

  // ç¼–è¾‘å¼¹çª—
  async function showEditModal(record, data, listContainer) {
    const modal = document.createElement("div", { cls: "modal-overlay" });
    modal.style.cssText = "position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;";

    const modalContent = modal.createEl("div", { cls: "modal-content" });
    modalContent.style.cssText = "background:var(--background-secondary);border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;";

    modalContent.createEl("h3", { text: "âœï¸ ç¼–è¾‘æµæ°´è´¦", style: "margin:0 0 16px 0;" });

    // ä»è®°å½•ä¸­æå–æ—¥æœŸ
    const recordDate = record.datetime.split("T")[0];
    const recordTime = record.datetime.slice(11, 16);

    // æ—¥æœŸ + æ—¶é—´
    const datetimeRow = modalContent.createEl("div", { cls: "form-row" });
    datetimeRow.createEl("span", { text: "æ—¥æœŸ:", cls: "ref-label" });
    const editDate = datetimeRow.createEl("input", { type: "date", cls: "date-input", value: recordDate });
    datetimeRow.createEl("span", { text: "æ—¶é—´:", cls: "ref-label", style: "margin-left:12px;" });
    const editTime = datetimeRow.createEl("input", { type: "time", cls: "time-input", value: recordTime });

    // äº‹é¡¹
    const actRow = modalContent.createEl("div", { cls: "form-row" });
    actRow.createEl("span", { text: "äº‹é¡¹:", cls: "ref-label" });
    const editActivity = actRow.createEl("input", { type: "text", cls: "activity-input", value: record.activity });

    // åˆ¤æ®
    const critRow = modalContent.createEl("div", { cls: "form-row" });
    critRow.createEl("span", { text: "åˆ¤æ®:", cls: "ref-label" });
    const editCriterion = critRow.createEl("input", { type: "text", cls: "criterion-input", value: record.criterion || "" });

    // ç»´åº¦æ ‡ç­¾
    const tagRow = modalContent.createEl("div", { cls: "tag-row" });
    tagRow.createEl("span", { text: "ç»´åº¦:", cls: "tag-label" });
    const selectedTags = new Set(record.related_dimensions || []);

    Object.keys(DIMENSIONS).forEach(dim => {
      const tag = tagRow.createEl("span", {
        cls: `dim-tag ${selectedTags.has(dim) ? "selected" : ""}`,
        text: dim
      });
      tag.onclick = () => {
        if (selectedTags.has(dim)) { selectedTags.delete(dim); tag.classList.remove("selected"); }
        else { selectedTags.add(dim); tag.classList.add("selected"); }
      };
    });

    // äºŒæ¬¡åæ€
    const ref1Row = modalContent.createEl("div", { cls: "form-row" });
    ref1Row.createEl("span", { text: "äºŒæ¬¡:", cls: "ref-label" });
    const editRef1 = ref1Row.createEl("input", { type: "text", cls: "ref-input", value: record.reflection_1 || "" });

    // ä¸‰æ¬¡åæ€
    const ref2Row = modalContent.createEl("div", { cls: "form-row" });
    ref2Row.createEl("span", { text: "ä¸‰æ¬¡:", cls: "ref-label" });
    const editRef2 = ref2Row.createEl("input", { type: "text", cls: "ref-input", value: record.reflection_2 || "" });

    // æŒ‰é’®è¡Œ
    const btnRow = modalContent.createEl("div", { style: "display:flex;gap:12px;margin-top:20px;" });

    const saveBtn = btnRow.createEl("button", { text: "ğŸ’¾ ä¿å­˜", cls: "btn save-btn" });
    const deleteBtn = btnRow.createEl("button", { text: "ğŸ—‘ï¸ åˆ é™¤", cls: "btn clear-btn", style: "background:#ef4444;color:white;" });
    const cancelBtn = btnRow.createEl("button", { text: "å–æ¶ˆ", cls: "btn clear-btn" });

    // ä¿å­˜
    saveBtn.onclick = async () => {
      // å¿…å¡«æ ¡éªŒï¼šæ—¥æœŸ
      if (!editDate.value) {
        alert("âš ï¸ è¯·å¡«å†™æ—¥æœŸ");
        editDate.focus();
        return;
      }
      // å¿…å¡«æ ¡éªŒï¼šæ—¶é—´
      if (!editTime.value) {
        alert("âš ï¸ è¯·å¡«å†™æ—¶é—´");
        editTime.focus();
        return;
      }
      // å¿…å¡«æ ¡éªŒï¼šäº‹é¡¹
      if (!editActivity.value.trim()) {
        alert("âš ï¸ è¯·å¡«å†™äº‹é¡¹");
        editActivity.focus();
        return;
      }
      // åˆ¤æ®ã€äºŒæ¬¡åæ€ã€ä¸‰æ¬¡åæ€ã€ç»´åº¦æ ‡ç­¾å¯ç•™ç©ºï¼Œè‡ªåŠ¨å¤„ç†
      const updatedRecord = {
        ...record,
        datetime: `${editDate.value} ${editTime.value}`,
        activity: editActivity.value.trim(),
        criterion: editCriterion.value.trim() || undefined,
        reflection_1: editRef1.value.trim() || undefined,
        reflection_2: editRef2.value.trim() || undefined,
        related_dimensions: selectedTags.size > 0 ? Array.from(selectedTags) : undefined
      };

      const idx = data.records.findIndex(r => r.id === record.id);
      if (idx >= 0) {
        data.records[idx] = updatedRecord;
        const file = app.vault.getAbstractFileByPath(CONFIG.dataPath + CONFIG.activityFile);
        if (file) {
          await app.vault.modify(file, JSON.stringify(data, null, 2));
          document.body.removeChild(modal);
          main(); // åˆ·æ–°è§†å›¾
        }
      }
    };

    // åˆ é™¤
    deleteBtn.onclick = async () => {
      if (confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ")) {
        data.records = data.records.filter(r => r.id !== record.id);
        const file = app.vault.getAbstractFileByPath(CONFIG.dataPath + CONFIG.activityFile);
        if (file) {
          await app.vault.modify(file, JSON.stringify(data, null, 2));
          document.body.removeChild(modal);
          main(); // åˆ·æ–°è§†å›¾
        }
      }
    };

    // å–æ¶ˆ
    cancelBtn.onclick = () => document.body.removeChild(modal);

    document.body.appendChild(modal);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // åˆ†ç¦»è§†å›¾ - ä»ªè¡¨ç›˜é¡µ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function renderDashboardView(container) {
    const section = container.createEl("div", { cls: "tab-section" });
    section.createEl("h2", { text: "ğŸ“ˆ æ•°æ®ä»ªè¡¨ç›˜" });

    const data = await loadData(CONFIG.scoresFile);
    const today = getLocalDateString();
    const todayRecord = data?.records?.find(r => r.date === today);

    // ä»Šæ—¥æ¦‚è§ˆ
    const todayCard = section.createEl("div", { cls: "dash-card" });
    todayCard.createEl("h3", { text: "ğŸ“… ä»Šæ—¥æ¦‚è§ˆ" });
    if (todayRecord) {
      const row = todayCard.createEl("div", { cls: "today-score" });
      row.createEl("span", { text: todayRecord.daily_avg.toFixed(1), cls: "big-num" });
      row.createEl("span", { text: "/5.0", cls: "unit" });
      row.createEl("span", { text: getLevel(todayRecord.daily_avg), cls: `level-badge ${getLevelClass(todayRecord.daily_avg)}` });
    } else {
      todayCard.createEl("p", { text: "ä»Šæ—¥æš‚æ— è¯„åˆ†", cls: "empty-text" });
    }

    // ç»´åº¦æ˜ç»†
    if (todayRecord) {
      const dimsCard = section.createEl("div", { cls: "dash-card" });
      dimsCard.createEl("h3", { text: "ğŸ“Š ç»´åº¦æ˜ç»†" });
      const grid = dimsCard.createEl("div", { cls: "dims-grid" });
      Object.entries(todayRecord.scores).forEach(([dimId, score]) => {
        const box = grid.createEl("div", { cls: `dim-box score-${score}` });
        box.createEl("span", { text: dimId, cls: "dim-id" });
        box.createEl("span", { text: DIMENSIONS[dimId].name, cls: "dim-name-sm" });
        box.createEl("span", { text: score, cls: "dim-score" });
      });
    }

    // è¿‘æœŸè¶‹åŠ¿
    const trendCard = section.createEl("div", { cls: "dash-card" });
    trendCard.createEl("h3", { text: "ğŸ“ˆ è¿‘14å¤©è¶‹åŠ¿" });
    if (data?.records?.length > 0) {
      const recent = data.records.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 14).reverse();
      const chart = trendCard.createEl("div", { cls: "mini-chart" });
      recent.forEach(d => {
        const row = chart.createEl("div", { cls: "chart-row" });
        row.createEl("span", { text: d.date.slice(5), cls: "chart-date" });
        const barLen = Math.round((d.daily_avg / 5) * 18);
        row.createEl("span", { text: "â–ˆ".repeat(barLen) + "â–‘".repeat(18 - barLen), cls: "chart-bar" });
        row.createEl("span", { text: d.daily_avg.toFixed(1), cls: "chart-value" });
      });
    } else {
      trendCard.createEl("p", { text: "æ•°æ®ç§¯ç´¯ä¸­...", cls: "empty-text" });
    }

    // å±‚çº§åˆ†æ
    const layerCard = section.createEl("div", { cls: "dash-card" });
    layerCard.createEl("h3", { text: "ğŸ“Š å±‚çº§åˆ†æ (è¿‘7å¤©)" });
    if (data?.records?.length >= 3) {
      const recent7 = data.records.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 7);
      for (const [layer, dims] of Object.entries(LAYER_DIMS)) {
        const row = layerCard.createEl("div", { cls: "layer-row" });
        row.createEl("span", { text: layer, cls: "layer-name" });
        const avg = recent7.reduce((s, r) => s + dims.reduce((ss, d) => ss + (r.scores[d] || 0), 0), 0) / (recent7.length * dims.length);
        const barBox = row.createEl("div", { cls: "bar-box" });
        barBox.createEl("div", { cls: "bar-fill", style: `width: ${(avg / 5) * 100}%` });
        row.createEl("span", { text: avg.toFixed(2), cls: "layer-value" });
      }
    } else {
      layerCard.createEl("p", { text: "éœ€è¦è‡³å°‘3å¤©æ•°æ®", cls: "empty-text" });
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ¶ˆæ¯æç¤º
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  if (message.show) {
    const msgDiv = container.createEl("div", { cls: `message ${message.type}` });
    msgDiv.textContent = message.text;
  }
}

// å¯åŠ¨
main();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ ·å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const style = document.createElement("style");
style.textContent = `
  /* å¤´éƒ¨ */
  .scoring-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 2px solid var(--interactive-accent); }
  .scoring-header h1 { margin: 0; font-size: 20px; }
  .controls { display: flex; gap: 8px; }
  .control-btn { padding: 8px 16px; border: 1px solid var(--background-modifier-border); background: transparent; border-radius: 6px; cursor: pointer; font-size: 13px; }
  .control-btn.active { background: var(--interactive-accent); color: white; border-color: transparent; }

  /* æ ‡ç­¾é¡µ */
  .tabs { display: flex; gap: 8px; padding: 16px 20px; }
  .tabs.hidden { display: none; }
  .tab-btn { padding: 10px 20px; border: none; background: var(--background-secondary); border-radius: 8px; cursor: pointer; font-size: 14px; }
  .tab-btn.active { background: var(--interactive-accent); color: white; }

  .content { padding: 0 20px 20px; }

  /* å¡ç‰‡ */
  .card { background: var(--background-secondary); border-radius: 12px; padding: 20px; }
  .score-card { margin-bottom: 16px; }
  .half-card { flex: 1; }

  /* ç»Ÿä¸€è§†å›¾å¸ƒå±€ */
  .unified-section { display: flex; flex-direction: column; gap: 16px; }
  .bottom-row { display: flex; gap: 16px; }

  /* åˆ†æ•°æ˜¾ç¤º */
  .date-badge { font-size: 12px; color: var(--text-muted); background: var(--background-primary); padding: 4px 8px; border-radius: 4px; margin-left: 12px; }
  .score-display { display: flex; align-items: baseline; gap: 8px; margin-bottom: 16px; background: var(--background-primary); padding: 16px; border-radius: 8px; }
  .big-score { font-size: 48px; font-weight: 700; color: var(--interactive-accent); }
  .unit { font-size: 20px; color: var(--text-muted); }
  .level-badge { padding: 4px 10px; border-radius: 4px; font-size: 14px; font-weight: 600; }
  .level-excellent { background: #22c55e; color: white; }
  .level-good { background: #84cc16; color: white; }
  .level-normal { background: #eab308; color: black; }
  .level-poor { background: #f97316; color: white; }
  .level-bad { background: #ef4444; color: white; }

  /* å±‚çº§è¿›åº¦æ¡ */
  .layers-row { display: flex; gap: 12px; margin-bottom: 16px; }
  .layer-item { flex: 1; text-align: center; }
  .layer-label { font-size: 12px; color: var(--text-muted); }
  .layer-value { font-size: 16px; font-weight: 600; display: block; margin-top: 4px; }
  .bar-bg { height: 6px; background: var(--background-modifier-border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
  .bar-fill { height: 100%; transition: width 0.3s; }

  /* ç»´åº¦è¯„åˆ† */
  .dims-container { display: flex; flex-direction: column; gap: 12px; }
  .layer-group { background: var(--background-primary); border-radius: 8px; padding: 12px; }
  .layer-title { font-weight: 600; color: var(--interactive-accent); font-size: 13px; margin-bottom: 8px; }
  .dim-row { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 8px; }
  .dim-icon { font-size: 14px; }
  .dim-name { font-weight: 500; }
  .btn-row { display: flex; gap: 3px; }
  .score-btn { width: 28px; height: 28px; border: 2px solid var(--background-modifier-border); background: transparent; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s; }
  .score-btn:hover { background: var(--background-modifier-hover); }
  .score-btn.selected { color: white; border-color: transparent; }
  .score-btn.score-5.selected { background: #22c55e; }
  .score-btn.score-4.selected { background: #84cc16; }
  .score-btn.score-3.selected { background: #eab308; }
  .score-btn.score-2.selected { background: #f97316; }
  .score-btn.score-1.selected { background: #ef4444; }
  .anchor-text { font-size: 11px; color: var(--text-muted); font-style: italic; }

  /* D1-D7 è¯´æ˜ */
  .help-toggle { margin-bottom: 12px; }
  .help-btn { padding: 6px 12px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; font-size: 12px; }
  .help-content { margin-top: 8px; padding: 12px; background: var(--background-primary); border-radius: 8px; }
  .help-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .help-table th, .help-table td { padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--background-modifier-border); }
  .help-table th { background: var(--background-secondary); font-weight: 600; }

  /* æ“ä½œæŒ‰é’® */
  .action-row { display: flex; gap: 12px; margin-top: 16px; }
  .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
  .save-btn { background: #22c55e; color: white; }
  .clear-btn { background: var(--background-modifier-hover); }
  .add-btn { background: #10b981; color: white; }

  /* æµæ°´è´¦è¡¨å• */
  .activity-form { display: flex; flex-direction: column; gap: 10px; }
  .form-row { display: flex; gap: 8px; }
  .form-row input { padding: 8px 10px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-secondary); }
  .time-input { width: 80px; }
  .activity-input { flex: 1; }
  .criterion-input { width: 100%; }
  .tag-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .tag-label { font-size: 12px; color: var(--text-muted); }
  .dim-tag { padding: 3px 8px; background: var(--background-modifier-border); border-radius: 4px; font-size: 11px; cursor: pointer; }
  .dim-tag.selected { background: var(--interactive-accent); color: white; }
  .ref-label { font-size: 12px; color: var(--text-muted); width: 36px; }
  .ref-input { flex: 1; }
  .add-btn-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
  .msg { font-size: 12px; font-weight: 600; }
  .msg.success { color: #22c55e; }
  .msg.error { color: #ef4444; }

  /* æ´»åŠ¨åˆ—è¡¨ */
  .activity-list-sm { margin-top: 12px; max-height: 200px; overflow-y: auto; }
  .activity-item-sm { display: flex; gap: 8px; padding: 6px; background: var(--background-primary); border-radius: 4px; margin-bottom: 4px; font-size: 12px; }
  .item-time-sm { color: var(--text-muted); min-width: 45px; }
  .item-desc-sm { font-weight: 500; }

  /* è¿·ä½ ä»ªè¡¨ç›˜ */
  .mini-score-row { display: flex; align-items: baseline; gap: 8px; margin-bottom: 12px; }
  .mini-score { font-size: 32px; font-weight: 700; color: var(--interactive-accent); }
  .mini-unit { font-size: 16px; color: var(--text-muted); }
  .mini-level { padding: 3px 8px; border-radius: 4px; font-size: 12px; }
  .dims-grid-sm { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 12px; }
  .dim-box-sm { text-align: center; padding: 6px 4px; border-radius: 4px; }
  .dim-box-sm.score-5 { background: #dcfce7; color: #166534; }
  .dim-box-sm.score-4 { background: #ecfccb; color: #3f6212; }
  .dim-box-sm.score-3 { background: #fef9c3; color: #854d0e; }
  .dim-box-sm.score-2 { background: #ffedd5; color: #9a3412; }
  .dim-box-sm.score-1 { background: #fee2e2; color: #991b1b; }
  .dim-id-sm { display: block; font-size: 10px; font-weight: 600; }
  .dim-score-sm { display: block; font-size: 16px; font-weight: 700; }
  .mini-trend { font-family: monospace; font-size: 12px; }
  .trend-row-sm { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
  .trend-date-sm { width: 45px; text-align: right; color: var(--text-muted); }
  .trend-bar-sm { color: var(--interactive-accent); }
  .trend-val-sm { font-weight: 600; }

  /* åˆ†ç¦»è§†å›¾æ ·å¼ */
  .tab-section { background: var(--background-secondary); border-radius: 12px; padding: 20px; }
  .tab-section h2 { margin: 0 0 16px 0; font-size: 18px; }
  .tab-section h3 { margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted); }

  /* ä»ªè¡¨ç›˜å¡ç‰‡ */
  .dash-card { background: var(--background-primary); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
  .dash-card h3 { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; }
  .today-score { display: flex; align-items: baseline; gap: 12px; }
  .big-num { font-size: 36px; font-weight: 700; color: var(--interactive-accent); }

  /* ç»´åº¦æ ¼å­ */
  .dims-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
  .dim-box { text-align: center; padding: 10px 6px; border-radius: 6px; }
  .dim-box.score-5 { background: #dcfce7; color: #166534; }
  .dim-box.score-4 { background: #ecfccb; color: #3f6212; }
  .dim-box.score-3 { background: #fef9c3; color: #854d0e; }
  .dim-box.score-2 { background: #ffedd5; color: #9a3412; }
  .dim-box.score-1 { background: #fee2e2; color: #991b1b; }
  .dim-id { display: block; font-size: 12px; font-weight: 600; }
  .dim-name-sm { display: block; font-size: 10px; opacity: 0.8; }
  .dim-score { display: block; font-size: 20px; font-weight: 700; }

  /* è¶‹åŠ¿å›¾ */
  .mini-chart { font-family: monospace; font-size: 13px; }
  .chart-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .chart-date { width: 50px; text-align: right; color: var(--text-muted); }
  .chart-bar { color: var(--interactive-accent); letter-spacing: -1px; }
  .chart-value { width: 36px; text-align: right; font-weight: 600; }

  /* å±‚çº§åˆ†æ */
  .layer-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
  .layer-name { width: 60px; font-weight: 600; font-size: 13px; }
  .bar-box { flex: 1; height: 16px; background: var(--background-secondary); border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; background: var(--interactive-accent); }
  .layer-value { width: 40px; text-align: right; font-weight: 600; font-size: 13px; }

  /* æ´»åŠ¨åˆ—è¡¨ */
  .activity-list { margin-top: 16px; max-height: 400px; overflow-y: auto; }
  .activity-item { padding: 12px; background: var(--background-primary); border-radius: 6px; margin-bottom: 8px; }
  .item-header { display: flex; gap: 12px; align-items: baseline; margin-bottom: 6px; }
  .item-time { font-size: 12px; color: var(--text-muted); min-width: 50px; }
  .item-desc { font-weight: 600; }
  .item-criterion { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
  .item-refs { margin-top: 6px; }
  .ref-text { font-size: 12px; padding-left: 12px; border-left: 2px solid; margin-bottom: 4px; }
  .ref-text:first-child { border-color: #6366f1; color: #6366f1; }
  .ref-text:last-child { border-color: #8b5cf6; color: #8b5cf6; }
  .item-tags { display: flex; gap: 4px; margin-top: 8px; }
  .tag { padding: 2px 6px; background: var(--interactive-accent); color: white; border-radius: 3px; font-size: 10px; }

  .empty-text { color: var(--text-muted); font-style: italic; font-size: 13px; }

  /* æ¶ˆæ¯æç¤º */
  .message { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-weight: 600; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .message.success { background: #22c55e; color: white; }
  .message.error { background: #ef4444; color: white; }

  /* å®Œæ•´æµæ°´è´¦åˆ—è¡¨ */
  .activity-list-full { margin-top: 16px; max-height: 500px; overflow-y: auto; }
  .activity-item-full { padding: 12px; background: var(--background-primary); border-radius: 6px; margin-bottom: 8px; transition: transform 0.1s; }
  .activity-item-full:hover { transform: translateX(4px); border-left: 3px solid var(--interactive-accent); }
  .item-header-full { display: flex; gap: 12px; align-items: baseline; margin-bottom: 6px; }
  .item-time-full { font-size: 12px; color: var(--text-muted); min-width: 50px; }
  .item-desc-full { font-weight: 600; font-size: 14px; }
  .item-criterion-full { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
  .item-refs-full { margin-top: 6px; }
  .ref-text-full { font-size: 12px; padding-left: 12px; border-left: 2px solid; margin-bottom: 4px; }
  .ref-text-full:first-child { border-color: #6366f1; color: #6366f1; }
  .ref-text-full:last-child { border-color: #8b5cf6; color: #8b5cf6; }
  .item-tags-full { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
  .tag-full { padding: 2px 8px; background: var(--interactive-accent); color: white; border-radius: 3px; font-size: 11px; }

  /* æµæ°´è´¦æ–°å¢è¡Œ */
  .activity-add-row { display: flex; gap: 8px; align-items: center; padding: 12px; background: var(--background-primary); border-radius: 8px; margin-bottom: 12px; }
  .add-time-input { width: 90px; padding: 6px 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; }
  .add-activity-input { flex: 1; padding: 6px 10px; border: 1px solid var(--background-modifier-border); border-radius: 4px; }
  .add-msg { font-size: 12px; font-weight: 600; margin-left: 8px; }
  .add-msg.success { color: #22c55e; }
  .add-msg.error { color: #ef4444; }

  /* æµæ°´è´¦æ—¥æœŸç­›é€‰ */
  .activity-filter-row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: var(--background-secondary); border-radius: 6px; }
  .filter-label { font-size: 13px; color: var(--text-muted); }
  .filter-separator { color: var(--text-muted); }
  .date-input { padding: 4px 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; }
  .filter-btn { padding: 4px 12px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }

  /* æµæ°´è´¦åˆ—è¡¨å¤´éƒ¨ */
  .activity-list-header { margin-bottom: 8px; }
  .activity-list-header h3 { margin: 0; font-size: 14px; color: var(--text-muted); }

  /* å®Œæ•´åˆ—è¡¨æ—¥æœŸæ˜¾ç¤º */
  .item-date-full { font-size: 12px; color: var(--text-muted); min-width: 45px; }
  .item-reflection-full { font-size: 12px; color: var(--text-muted); margin-top: 4px; padding-left: 12px; border-left: 2px solid; }
  .item-reflection-full:first-of-type { border-color: #6366f1; }
  .item-reflection-full:last-of-type { border-color: #8b5cf6; }
`;
document.head.appendChild(style);
```
```dataviewjs
// ============================================================
// ğŸ“Š æ—¶é—´ç»Ÿè®¡ä¸è¯„ä¼°è§†å›¾ (v6.1 JSONæé€Ÿç‰ˆ + æ‰‹åŠ¨æ—¶é—´)
// ============================================================

const startDate = new Date("2025-11-01"); 
const endDate = new Date("2026-12-31");
endDate.setHours(23,59,59,999);

// --- 0. JSON å­˜å‚¨é…ç½® ---
const JSON_FILENAME = "TimeLog_Database.json";
const currentFolder = dv.current().file.folder;
const DB_PATH = currentFolder + "/" + JSON_FILENAME;

// --- 1. æ ¸å¿ƒäº¤äº’ç»„ä»¶ (UIä¿æŒä¸€è‡´) ---
class QuickSuggester extends obsidian.FuzzySuggestModal {
    constructor(app, items, onChoose) {
        super(app);
        this.items = items;
        this.onChoose = onChoose;
    }
    getItems() { return this.items; }
    getItemText(item) { return item; }
    onChooseItem(item, evt) { this.onChoose(item); }
}

class QuickPrompt extends obsidian.Modal {
    constructor(app, title, placeholder, onSubmit, defaultValue = "") {
        super(app);
        this.titleStr = title;
        this.placeholder = placeholder;
        this.defaultValue = defaultValue;
        this.onSubmit = onSubmit;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.createEl("h3", { text: this.titleStr });
        const inputContainer = contentEl.createDiv();
        const input = inputContainer.createEl("input", { type: "text", value: this.defaultValue });
        input.placeholder = this.placeholder;
        input.style.width = "100%";
        input.focus();
        
        const btnContainer = contentEl.createDiv({ style: "margin-top: 15px; text-align: right;" });
        const confirmBtn = btnContainer.createEl("button", { text: "ç¡®å®š", cls: "mod-cta" });
        const submit = () => { if(input.value) { this.close(); this.onSubmit(input.value); }};
        confirmBtn.onclick = submit;
        input.addEventListener("keypress", (e) => { if (e.key === "Enter") submit(); });
    }
    onClose() { this.contentEl.empty(); }
}

const prompt = (title, placeholder = "", defaultValue = "") => new Promise(r => new QuickPrompt(app, title, placeholder, r, defaultValue).open());
const suggester = (items) => new Promise(r => new QuickSuggester(app, items, r).open());

// --- 2. æ•°æ®å¤„ç†é€»è¾‘ (JSONæ ¸å¿ƒ) ---

// è¯»å– JSON
const loadData = async () => {
    if (!await app.vault.adapter.exists(DB_PATH)) return [];
    const content = await app.vault.adapter.read(DB_PATH);
    try { return JSON.parse(content); } catch (e) { return []; }
};

// å†™å…¥ JSON
const saveData = async (newData) => {
    const file = app.vault.getAbstractFileByPath(DB_PATH);
    const jsonString = JSON.stringify(newData, null, 2);
    if (file) await app.vault.modify(file, jsonString);
    else await app.vault.create(DB_PATH, jsonString);
    renderView(); // ä¿å­˜ååˆ·æ–°
};

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ·»åŠ æ–°è®°å½•é€»è¾‘ï¼šæ”¯æŒè‡ªå®šä¹‰æ—¶é—´
async function addNewRecord() {
    let allLogs = await loadData();
    let existingCategories = new Set([
        "3-ç¨³å¥æ‰§è¡Œ", "4-ä¸ºè‡ªå·±çš„ç³»ç»Ÿè®¾è®¡", "2-å†å²çš„ä¿¡æ¯archieve", 
        "1-è§£å†³å¯¼è‡´å¡é¡¿çš„é—®é¢˜", "5-å‘å†å²çš„ä¸å®Œå¤‡åšå°å µ", 
        "6-ååŒåˆä½œç»Ÿåˆç»¼æ•ˆ", "2A-æ˜ç¡®é—®é¢˜å¸¦æ¥ä¿¡æ¯å¢é‡æ‰©å±•é—®é¢˜åœˆ"
    ]); 
    allLogs.forEach(log => { if(log.category) existingCategories.add(log.category); });
    let catList = Array.from(existingCategories).sort();

    // (1) äº‹é¡¹
    const issue = await prompt("åšäº†ä»€ä¹ˆï¼Ÿï¼ˆäº‹é¡¹æ€»ç»“ï¼‰", "ä¾‹å¦‚ï¼šä¿®å¤äº†é›·è¾¾æ¨¡å—BUG");
    if (!issue) return;

    // (2) ã€æ–°å¢ã€‘è¾“å…¥æ—¥æœŸæ—¶é—´
    const defaultTime = moment().format("YYYY-MM-DD HH:mm");
    const timestampInput = await prompt("ç¡®è®¤æ—¶é—´ (YYYY-MM-DD HH:mm)", "å¯ä¿®æ”¹ä»¥è¡¥å½•", defaultTime);
    if (!timestampInput) return; // å…è®¸å–æ¶ˆ

    // (3) åˆ†ç±»
    const choices = ["[+] æ–°å¢åˆ†ç±»...", ...catList];
    let category = await suggester(choices);
    if (!category) return;

    if (category === "[+] æ–°å¢åˆ†ç±»...") {
        category = await prompt("è¯·è¾“å…¥æ–°åˆ†ç±»åç§°ï¼š", "ä¾‹å¦‚ï¼š7-æ–°ä¸šåŠ¡æ¢ç´¢");
        if (!category) return;
    }

    // (4) æ—¶é•¿
    const durationInput = await prompt("è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰", "90");
    if (!durationInput) return;
    const durationMin = parseInt(durationInput);

    // (5) æ‰“åˆ†
    const score = await prompt("æ‰“åˆ†ï¼ˆ1-10ï¼‰", "5");
    if (!score) return;

    // æ„å»ºæ–°å¯¹è±¡
    const newEntry = {
        timestamp: timestampInput, // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æ—¶é—´
        issue: issue,
        category: category,
        duration: durationMin,
        score: Number(score)
    };

    allLogs.push(newEntry);
    
    // æŒ‰æ—¶é—´æ’åºï¼Œç¡®ä¿è¡¨æ ¼å’Œå›¾è¡¨é¡ºåºæ­£ç¡®
    allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    await saveData(allLogs);
    new Notice(`âœ… è®°å½•å·²æ·»åŠ : ${timestampInput}`);
}

// --- 3. ä¸»æ¸²æŸ“é€»è¾‘ (å°è£…ä»¥ä¾¿è°ƒç”¨) ---
const renderView = async () => {
    dv.container.innerHTML = ""; // æ¸…ç©ºç”»å¸ƒ
    const logs = await loadData();
    
    if (logs.length === 0 && !await app.vault.adapter.exists(DB_PATH)) {
        dv.paragraph(`âš ï¸ æœªæ‰¾åˆ°æ•°æ®åº“: <code>${JSON_FILENAME}</code><br>è¯·ç¡®ä¿å·²è¿è¡Œè¿ç§»è„šæœ¬ï¼Œå¹¶å°†æ–‡ä»¶æ”¾ç½®åœ¨å½“å‰ç›®å½•ã€‚`);
        return;
    }

    // é¢„å¤„ç†æ•°æ®ä»¥ä¾¿æ˜¾ç¤º
    let allEntries = [];
    for (let log of logs) {
        let logDate = new Date(log.timestamp);
        if (isNaN(logDate.getTime())) continue;

        if (logDate >= startDate && logDate <= endDate) {
            allEntries.push({
                dateObj: logDate,
                dateStr: moment(logDate).format("YYYY-MM-DD"),
                timeStr: moment(logDate).format("HH:mm"),
                issue: log.issue,
                category: log.category,
                durationMin: log.duration,
                score: log.score
            });
        }
    }

    // æ ¼å¼åŒ–å‡½æ•°
    function formatMin(m) {
        if(!m) return "0m";
        if(m < 60) return `${m}m`;
        const h = Math.floor(m / 60);
        const min = m % 60;
        return min > 0 ? `${h}h ${min}m` : `${h}h`;
    }

    function goldenAngleColor(idx, total) {
        const GOLDEN_ANGLE = 137.508;
        let hue = (idx * GOLDEN_ANGLE) % 360;
        return {
            fill: `hsl(${hue},${65 + ((idx%2)*15)}%,${60 + ((idx%3)*15)}%)`,
            border: `hsl(${hue},85%,35%)`,
        };
    }

    // æ¸²æŸ“æŒ‰é’®
    const btnContainer = dv.el("div", "", { attr: { style: "margin-bottom: 20px; padding: 15px; background: var(--background-primary-alt); border: 1px dashed var(--background-modifier-border); border-radius: 8px; text-align: center;" }});
    const btn = btnContainer.createEl("button", { text: "â• æ·»åŠ æ–°çš„æ—¶é—´è®°å½•", attr: { style: "background-color: var(--interactive-accent); color: var(--text-on-accent); padding: 8px 24px; font-weight: bold; cursor: pointer; border-radius: 6px; border: none; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" }});
    btn.onclick = addNewRecord;

    if (allEntries.length === 0) {
        dv.paragraph("ğŸ“ è¿˜æ²¡æœ‰æ•°æ®ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è®°å½•ï¼");
    } else {
        const group = allEntries.reduce((acc, e) => {
            if (!acc[e.dateStr]) acc[e.dateStr] = [];
            acc[e.dateStr].push(e);
            return acc;
        }, {});

        let allCategories = Array.from(new Set(allEntries.map(e => e.category))).sort();
        const colorPairMap = {};
        allCategories.forEach((cat, idx) => {
            colorPairMap[cat] = goldenAngleColor(idx, allCategories.length);
        });

        // 1. å †å å›¾
        dv.header(3, "ğŸ“Š è´¨é‡è¯„ä¼°å †å å›¾");
        const blockHeight = 60;
        const minChartHeight = 280;
        let chartHtml = `<div style="display:flex;align-items:flex-end;gap:12px;overflow-x:auto;padding: 10px 0;">`;
        
        Object.keys(group).sort().forEach(date => {
            const entries = group[date].sort((a, b) => b.score - a.score);
            let stack = entries.map(e => {
                const color = colorPairMap[e.category] || {fill:"#ddd", border:"#444"};
                let shortCat = e.category.split('-')[1] || e.category; 
                if(shortCat.length > 4) shortCat = shortCat.substring(0,4)+"..";
                
                return `<div style="width:50px;height:${blockHeight}px;background:${color.fill};border:2px solid ${color.border};border-radius:6px;margin-bottom:3px;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;box-sizing: border-box;transition: transform 0.1s;" 
                    title="${e.timeStr} | ${e.issue}\nåˆ†ç±»: ${e.category}\nè€—æ—¶: ${e.durationMin}åˆ†é’Ÿ\nè¯„åˆ†: ${e.score}" 
                    onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <span style="font-size:15px;font-weight:bold;color:#222;line-height:1.2;">${e.score}</span>
                    <span style="font-size:9px;color:#444;width:44px;text-align:center;overflow:hidden;white-space:nowrap;">${shortCat}</span>
                </div>`;
            }).join('');
            
            const dayTotal = entries.reduce((a,b)=>a+b.durationMin,0);
            chartHtml += `<div style="display:flex;flex-direction:column;justify-content:flex-end;align-items:center;min-height:${minChartHeight}px;">
                ${stack}
                <div style="margin-top:5px;font-size:12px;font-weight:bold;color:var(--text-muted);">${date.slice(5)}</div>
                <div style="font-size:10px;color:var(--text-faint);">${formatMin(dayTotal)}</div>
            </div>`;
        });
        chartHtml += `</div>`;
        dv.paragraph(chartHtml);

        // å›¾ä¾‹
        let legendHtml = `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;margin-bottom:30px;padding:10px;background:var(--background-secondary);border-radius:6px;">`;
        allCategories.forEach(cat => {
            const c = colorPairMap[cat];
            legendHtml += `<span style="padding:2px 8px;border-radius:4px;background:${c.fill};border:1px solid ${c.border};font-size:12px;color:var(--text-normal);">${cat}</span>`;
        });
        legendHtml += `</div>`;
        dv.paragraph(legendHtml);

        // 2. è¡¨æ ¼
        let tableData = [];
        Object.keys(group).sort().reverse().forEach(date => {
            const entries = group[date].sort((a, b) => b.dateObj - a.dateObj);
            const totalMin = entries.reduce((a, b) => a + b.durationMin, 0);
            
            entries.forEach((e, i) => {
                tableData.push([
                    i === 0 ? `**${date}**` : "",
                    e.timeStr,
                    e.issue,
                    e.category,
                    formatMin(e.durationMin),
                    e.score,
                    i === 0 ? formatMin(totalMin) : ""
                ]);
            });
        });
        dv.header(3, "ğŸ“‹ è¯¦ç»†è®°å½•è¡¨");
        dv.table(["æ—¥æœŸ", "æ—¶åˆ»", "äº‹é¡¹å†…å®¹", "åˆ†ç±»", "è€—æ—¶", "è¯„åˆ†", "æ—¥åˆè®¡"], tableData);
    }
};

// å¯åŠ¨
renderView();

```


